@using Lab_Blazor.Services.Auth
@using Microsoft.AspNetCore.Components.Authorization
@using System.Security.Claims
@inject NavigationManager Navigation
@inject AuthenticationStateProvider AuthProvider

<AuthorizeView>
    <Authorized Context="authState">
        @{
            var user = authState.User;
        }

        <aside class="sidebar d-flex flex-column flex-shrink-0 bg-dark text-white position-fixed top-0 start-0 h-100 shadow">
            <div class="sb-header">
                <a class="brand d-flex align-items-center text-white text-decoration-none" href="/" title="Inicio">
                    <img src="images/logo-inmaculada.png" alt="Logo Laboratorio" class="brand-logo" />
                </a>
                <button class="btn sb-toggle ms-auto" type="button" onclick="window.toggleSidebar()" title="Abrir / Cerrar menú">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" class="sb-toggle-icon" fill="currentColor">
                        <rect x="3" y="5" width="18" height="2" rx="1"></rect>
                        <rect x="3" y="11" width="18" height="2" rx="1"></rect>
                        <rect x="3" y="17" width="18" height="2" rx="1"></rect>
                    </svg>
                </button>

            </div>

            <hr class="border-secondary" />

            <div class="sb-scroll p-3 d-flex flex-column h-100">
                <ul class="nav nav-pills flex-column mb-3">
                    <li class="nav-item mb-1">
                        <NavLink class="nav-link text-white d-flex align-items-center"
                                 activeClass="active bg-primary"
                                 href="/"
                                 Match="NavLinkMatch.All"
                                 title="Inicio">
                            <i class="bi bi-house-door me-2"></i>
                            <span class="nav-text">Inicio</span>
                        </NavLink>
                    </li>
                    <hr class="border-secondary" />

                    @if (user.IsInRole("administrador"))
                    {
                        <li class="mb-1">
                            <NavLink class="nav-link text-white d-flex align-items-center"
                                     activeClass="active bg-primary"
                                     href="/usuarios"
                                     title="Gestión de Usuarios">
                                <i class="bi bi-person-vcard me-2"></i>
                                <span class="nav-text">Usuarios</span>
                            </NavLink>
                        </li>
                    }



                    @if (user.IsInRole("administrador") || user.IsInRole("recepcionista"))
                    {
                        <li class="mb-1">
                            <button class="btn btn-toggle align-items-center rounded text-start text-white w-100"
                                    data-bs-target="#grpPacientes"
                                    aria-expanded="false"
                                    type="button">
                                <i class="bi bi-people me-2"></i>
                                <span class="nav-text">Pacientes</span>
                            </button>
                            <div class="collapse" id="grpPacientes">
                                <ul class="btn-toggle-nav list-unstyled fw-normal pb-1 small ps-4">
                                    <li>
                                        <NavLink class="link-light nav-link py-1 px-0"
                                                 activeClass="active"
                                                 href="/pacientes">Listado</NavLink>
                                    </li>
                                </ul>
                            </div>
                        </li>

                        <li class="mb-1">
                            <button class="btn btn-toggle align-items-center rounded text-start text-white w-100"
                                    data-bs-target="#grpMedicos"
                                    aria-expanded="false"
                                    type="button">
                                <i class="bi bi-person-badge me-2"></i>
                                <span class="nav-text">Médicos</span>
                            </button>
                            <div class="collapse" id="grpMedicos">
                                <ul class="btn-toggle-nav list-unstyled fw-normal pb-1 small ps-4">
                                    <li><NavLink class="link-light nav-link py-1 px-0" activeClass="active" href="/medicos">Listado</NavLink></li>
                                    <li><NavLink class="link-light nav-link py-1 px-0" activeClass="active" href="/convenios">Convenios</NavLink></li>
                                </ul>
                            </div>
                        </li>
                    }

                    @if (user.IsInRole("administrador") || user.IsInRole("laboratorista"))
                    {
                        <li class="mb-1">
                            <button class="btn btn-toggle align-items-center rounded text-start text-white w-100"
                                    data-bs-target="#grpExamenes"
                                    aria-expanded="false"
                                    type="button">
                                <i class="bi bi-clipboard2-pulse me-2"></i>
                                <span class="nav-text">Exámenes</span>
                            </button>
                            <div class="collapse" id="grpExamenes">
                                <ul class="btn-toggle-nav list-unstyled fw-normal pb-1 small ps-4">
                                    <li><NavLink class="link-light nav-link py-1 px-0" activeClass="active" href="/examenes">Catálogo</NavLink></li>
                                    <li><NavLink class="link-light nav-link py-1 px-0" activeClass="active" href="/asociaciones-reactivos">Asociaciones</NavLink></li>
                                </ul>
                            </div>
                        </li>

                        <li class="mb-1">
                            <button class="btn btn-toggle align-items-center rounded text-start text-white w-100"
                                    data-bs-target="#grpReactivos"
                                    aria-expanded="false"
                                    type="button">
                                <i class="bi bi-box-seam me-2"></i>
                                <span class="nav-text">Reactivos</span>
                            </button>
                            <div class="collapse" id="grpReactivos">
                                <ul class="btn-toggle-nav list-unstyled fw-normal pb-1 small ps-4">
                                    <li><NavLink class="link-light nav-link py-1 px-0" activeClass="active" href="/reactivos">Stock</NavLink></li>
                                    <li><NavLink class="link-light nav-link py-1 px-0" activeClass="active" href="/movimientos">Movimientos</NavLink></li>
                                </ul>
                            </div>
                        </li>
                    }

                    @if (user.IsInRole("administrador") || user.IsInRole("recepcionista") || user.IsInRole("laboratorista") || user.IsInRole("paciente"))
                    {
                        <li class="mb-1">
                            <button class="btn btn-toggle align-items-center rounded text-start text-white w-100"
                                    data-bs-target="#grpOrdenes"
                                    aria-expanded="false"
                                    type="button">
                                <i class="bi bi-file-earmark-medical me-2"></i>
                                <span class="nav-text">Órdenes Médicas</span>
                            </button>
                            <div class="collapse" id="grpOrdenes">
                                <ul class="btn-toggle-nav list-unstyled fw-normal pb-1 small ps-4">
                                    <li><NavLink class="link-light nav-link py-1 px-0" activeClass="active" href="/ordenes">Listado</NavLink></li>
                                    @if (user.IsInRole("administrador") || user.IsInRole("recepcionista"))
                                    {
                                        <li><NavLink class="link-light nav-link py-1 px-0" activeClass="active" href="/nueva-orden">Nueva Orden</NavLink></li>
                                        <li><NavLink class="link-light nav-link py-1 px-0" activeClass="active" href="/cuentasporcobrar">Cuentas por Cobrar</NavLink></li>
                                    }
                                </ul>
                            </div>
                        </li>

                        <li class="mb-1">
                            <button class="btn btn-toggle align-items-center rounded text-start text-white w-100"
                                    data-bs-target="#grpResultados"
                                    aria-expanded="false"
                                    type="button">
                                <i class="bi bi-clipboard-check me-2"></i>
                                <span class="nav-text">Resultados</span>
                            </button>
                            <div class="collapse" id="grpResultados">
                                <ul class="btn-toggle-nav list-unstyled fw-normal pb-1 small ps-4">
                                    <li><NavLink class="link-light nav-link py-1 px-0" activeClass="active" href="/resultados">Listado</NavLink></li>
                                </ul>
                            </div>
                        </li>
                    }

                    <hr class="border-secondary" />

                    <li class="mb-1">
                        <button class="btn btn-toggle align-items-center rounded text-start text-white w-100"
                                data-bs-target="#grpAjustes"
                                aria-expanded="false"
                                type="button">
                            <i class="bi bi-gear-fill me-2"></i>
                            <span class="nav-text">Ajustes</span>
                        </button>
                        <div class="collapse" id="grpAjustes">
                            <ul class="btn-toggle-nav list-unstyled fw-normal pb-1 small ps-4">
                                <li><NavLink class="link-light nav-link py-1 px-0" activeClass="active" href="/ajustes/perfil">Mi Perfil</NavLink></li>
                                <li><NavLink class="link-light nav-link py-1 px-0" activeClass="active" href="/ajustes/seguridad">Seguridad</NavLink></li>
                                <li><NavLink class="link-light nav-link py-1 px-0" activeClass="active" href="/ajustes/preferencias">Preferencias</NavLink></li>
                            </ul>
                        </div>
                    </li>
                </ul>

                <div class="sb-user mt-auto p-3 d-flex align-items-center">
                    <div class="sb-user-info flex-grow-1 ms-2">
                        <div class="fw-bold">@GetUserName(user)</div>
                        <small class="text-muted">@GetUserRol(user)</small>
                        <small class="text-muted">@GetUserEmail(user)</small>
                    </div>
                    <button class="btn sb-logout" @onclick="Logout">
                        <i class="bi bi-box-arrow-right"></i>
                    </button>
                </div>
            </div>
        </aside>

    </Authorized>

    <NotAuthorized>
        <aside class="sidebar d-flex flex-column flex-shrink-0 bg-dark text-white position-fixed top-0 start-0 h-100 shadow">
            <div class="sb-header">
                <a class="brand d-flex align-items-center text-white text-decoration-none" href="/" title="Inicio">
                    <img src="images/logo-inmaculada.png" alt="Logo Laboratorio" class="brand-logo" />
                </a>
                <button class="btn sb-toggle ms-auto" type="button" onclick="window.toggleSidebar()" title="Abrir / Cerrar menú">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" class="sb-toggle-icon" fill="currentColor">
                        <rect x="3" y="5" width="18" height="2" rx="1"></rect>
                        <rect x="3" y="11" width="18" height="2" rx="1"></rect>
                        <rect x="3" y="17" width="18" height="2" rx="1"></rect>
                    </svg>
                </button>

            </div>

            <hr class="border-secondary" />

            <div class="sb-scroll p-3 d-flex flex-column h-100">
                <ul class="nav nav-pills flex-column mb-3">
                    <li class="nav-item mb-1">
                        <NavLink class="nav-link text-white d-flex align-items-center"
                                 activeClass="active bg-primary"
                                 href="/"
                                 Match="NavLinkMatch.All"
                                 title="Inicio">
                            <i class="bi bi-house-door me-2"></i>
                            <span class="nav-text">Inicio</span>
                        </NavLink>
                    </li>
                    <hr class="border-secondary" />

                </ul>
            </div>

        </aside>
    </NotAuthorized>


</AuthorizeView>


@code {
    private async Task Logout()
    {
        if (AuthProvider is CustomAuthenticationStateProvider customAuth)
            await customAuth.SignOutAsync();
        Navigation.NavigateTo("/login", replace: true);
    }

    private string GetUserName(ClaimsPrincipal user) => user?.Identity?.Name ?? "Usuario";
    private string GetUserEmail(ClaimsPrincipal user) => user?.FindFirst("email")?.Value ?? "correo@ejemplo.com";
    private string GetUserRol(ClaimsPrincipal user)
    {
        var rawRol = user?.FindFirst(ClaimTypes.Role)?.Value ?? "";
        return rawRol switch
        {
            "administrador" => "Administrador",
            "recepcionista" => "Recepcionista",
            "laboratorista" => "Laboratorista",
            "paciente" => "Paciente",
            _ => rawRol
        };
    }
}
