@using Lab_Blazor.Services.Auth
@using Microsoft.AspNetCore.Components.Authorization
@using System.Security.Claims
@inject NavigationManager Navigation
@inject AuthenticationStateProvider AuthProvider

<aside class="sidebar d-flex flex-column flex-shrink-0 bg-dark text-white position-fixed top-0 start-0 h-100 shadow">
    <div class="sb-scroll p-3 d-flex flex-column h-100">
        <div class="sb-header d-flex align-items-center mb-3">
            <a class="brand d-flex align-items-center text-white text-decoration-none" href="/" title="Inicio">
                <img src="images/logo-inmaculada.png" alt="Logo Laboratorio" class="brand-logo" />
            </a>
            <button class="btn sb-toggle ms-auto" type="button" onclick="window.toggleSidebar()" title="Expandir/Contraer" data-rail-tooltip="true">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 28 24" class="sb-toggle-icon">
                    <rect x="3" y="3" width="5" height="18" rx="1.2" fill="currentColor"></rect>
                    <path d="M12 12 L19 6 V18 Z" fill="currentColor"></path>
                </svg>
            </button>
        </div>


        <hr class="border-secondary" />

        <ul class="nav nav-pills flex-column mb-3">
            <li class="nav-item mb-1">
                <NavLink class="nav-link text-white d-flex align-items-center"
                         activeClass="active bg-primary"
                         href="/"
                         Match="NavLinkMatch.All"
                         title="Inicio"
                         data-rail-tooltip="true">
                    <i class="bi bi-house-door me-2"></i>
                    <span class="nav-text">Inicio</span>
                </NavLink>
            </li>

            <li class="mb-1">
                <button class="btn btn-toggle align-items-center rounded text-start text-white w-100"
                        data-bs-target="#grpPacientes"
                        aria-expanded="false"
                        title="Pacientes"
                        data-rail-tooltip="true"
                        type="button">
                    <i class="bi bi-people me-2"></i>
                    <span class="nav-text">Pacientes</span>
                </button>

                <div class="collapse" id="grpPacientes">
                    <ul class="btn-toggle-nav list-unstyled fw-normal pb-1 small ps-4">
                        <li>
                            <NavLink class="link-light nav-link py-1 px-0"
                                     activeClass="active"
                                     href="/pacientes"
                                     title="Listado"
                                     data-rail-tooltip="true">Listado</NavLink>
                        </li>
                    </ul>
                </div>

            </li>

            <li class="mb-1">
                <button class="btn btn-toggle align-items-center rounded text-start text-white w-100"
                        data-bs-target="#grpMedicos"
                        aria-expanded="false"
                        title="Médicos"
                        data-rail-tooltip="true">
                    <i class="bi bi-person-badge me-2"></i>
                    <span class="nav-text">Médicos</span>
                </button>
                <div class="collapse" id="grpMedicos">
                    <ul class="btn-toggle-nav list-unstyled fw-normal pb-1 small ps-4">
                        <li><NavLink class="link-light nav-link py-1 px-0" activeClass="active" href="/medicos" title="Listado" data-rail-tooltip="true">Listado</NavLink></li>
                        <li><NavLink class="link-light nav-link py-1 px-0" activeClass="active" href="/convenios" title="Convenios" data-rail-tooltip="true">Convenios</NavLink></li>
                    </ul>
                </div>
            </li>

            <li class="mb-1">
                <button class="btn btn-toggle align-items-center rounded text-start text-white w-100"
                        data-bs-target="#grpExamenes"
                        aria-expanded="false"
                        title="Exámenes"
                        data-rail-tooltip="true">
                    <i class="bi bi-clipboard2-pulse me-2"></i>
                    <span class="nav-text">Exámenes</span>
                </button>
                <div class="collapse" id="grpExamenes">
                    <ul class="btn-toggle-nav list-unstyled fw-normal pb-1 small ps-4">
                        <li><NavLink class="link-light nav-link py-1 px-0" activeClass="active" href="/examenes" title="Catálogo" data-rail-tooltip="true">Catálogo</NavLink></li>
                        <li><NavLink class="link-light nav-link py-1 px-0" activeClass="active" href="/asociaciones-reactivos" title="Asociaciones" data-rail-tooltip="true">Asociaciones</NavLink></li>
                    </ul>
                </div>
            </li>

            <li class="mb-1">
                <button class="btn btn-toggle align-items-center rounded text-start text-white w-100"
                        data-bs-target="#grpReactivos"
                        aria-expanded="false"
                        title="Reactivos"
                        data-rail-tooltip="true">
                    <i class="bi bi-box-seam me-2"></i>
                    <span class="nav-text">Reactivos</span>
                </button>
                <div class="collapse" id="grpReactivos">
                    <ul class="btn-toggle-nav list-unstyled fw-normal pb-1 small ps-4">
                        <li><NavLink class="link-light nav-link py-1 px-0" activeClass="active" href="/reactivos" title="Stock" data-rail-tooltip="true">Stock</NavLink></li>
                        <li><NavLink class="link-light nav-link py-1 px-0" activeClass="active" href="/movimientos" title="Movimientos" data-rail-tooltip="true">Movimientos</NavLink></li>
                    </ul>
                </div>
            </li>

            <li class="mb-1">
                <button class="btn btn-toggle align-items-center rounded text-start text-white w-100"
                        data-bs-target="#grpOrdenes"
                        aria-expanded="false"
                        title="Órdenes Médicas"
                        data-rail-tooltip="true">
                    <i class="bi bi-file-earmark-medical me-2"></i>
                    <span class="nav-text">Órdenes Médicas</span>
                </button>
                <div class="collapse" id="grpOrdenes">
                    <ul class="btn-toggle-nav list-unstyled fw-normal pb-1 small ps-4">
                        <li><NavLink class="link-light nav-link py-1 px-0" activeClass="active" href="/ordenes" title="Órdenes" data-rail-tooltip="true">Órdenes</NavLink></li>
                        <li><NavLink class="link-light nav-link py-1 px-0" activeClass="active" href="/cuentasporcobrar" title="Cuentas por Cobrar" data-rail-tooltip="true">Cuentas por Cobrar</NavLink></li>
                    </ul>
                </div>
            </li>

            <li class="mb-1">
                <button class="btn btn-toggle align-items-center rounded text-start text-white w-100"
                        data-bs-target="#grpResultados"
                        aria-expanded="false"
                        title="Resultados"
                        data-rail-tooltip="true">
                    <i class="bi bi-clipboard-check me-2"></i>
                    <span class="nav-text">Resultados</span>
                </button>
                <div class="collapse" id="grpResultados">
                    <ul class="btn-toggle-nav list-unstyled fw-normal pb-1 small ps-4">
                        <li><NavLink class="link-light nav-link py-1 px-0" activeClass="active" href="/resultados" title="Listado" data-rail-tooltip="true">Listado</NavLink></li>
                    </ul>
                </div>
            </li>
        </ul>

        <hr class="border-secondary" />

        <AuthorizeView>
            <Authorized Context="authState">
                <div class="sb-user mt-auto p-3 d-flex align-items-center">
                    <div class="sb-user-info flex-grow-1 ms-2">
                        <div class="fw-bold">@GetUserName(authState.User)</div>
                        <small class="text-muted">@GetUserRol(authState.User)</small>
                        <small class="text-muted">@GetUserEmail(authState.User)</small>
                    </div>
                    <button class="btn sb-logout" title="Cerrar sesión" data-rail-tooltip="true" @onclick="Logout">
                        <i class="bi bi-box-arrow-right"></i>
                    </button>
                </div>
            </Authorized>
        </AuthorizeView>
    </div>
</aside>

@code {
    private async Task Logout()
    {
        if (AuthProvider is CustomAuthenticationStateProvider customAuth)
            await customAuth.SignOutAsync();
        Navigation.NavigateTo("/login", replace: true);
    }

    private string GetUserName(ClaimsPrincipal user) => user?.Identity?.Name ?? "Usuario";
    private string GetUserEmail(ClaimsPrincipal user) => user?.FindFirst("email")?.Value ?? "correo@ejemplo.com";
    private string GetUserRol(ClaimsPrincipal user)
    {
        var rawRol = user?.FindFirst(ClaimTypes.Role)?.Value ?? "";
        return rawRol switch
        {
            "administrador" => "Administrador",
            "recepcionista" => "Recepcionista",
            "paciente" => "Paciente",
            "laboratorista" => "Laboratorista",
            _ => rawRol
        };
    }
}
