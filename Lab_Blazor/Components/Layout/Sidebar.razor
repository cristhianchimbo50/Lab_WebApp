@using Lab_Blazor.Services.Auth
@using Microsoft.AspNetCore.Components.Authorization
@using System.Security.Claims
@inject NavigationManager Navigation
@inject AuthenticationStateProvider AuthProvider

<AuthorizeView>
    <Authorized Context="authState">
        @{
            var user = authState.User;
        }

        <aside class="sidebar d-flex flex-column flex-shrink-0 bg-dark text-white position-fixed top-0 start-0 h-100 shadow">
            <div class="sb-scroll p-3 d-flex flex-column h-100">
                <div class="sb-header d-flex align-items-center mb-3">
                    <a class="brand d-flex align-items-center text-white text-decoration-none" href="/" title="Inicio">
                        <img src="images/logo-inmaculada.png" alt="Logo Laboratorio" class="brand-logo" />
                    </a>
                    <button class="btn sb-toggle ms-auto" type="button" onclick="window.toggleSidebar()" title="Expandir/Contraer" data-rail-tooltip="true">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 28 24" class="sb-toggle-icon">
                            <rect x="3" y="3" width="5" height="18" rx="1.2" fill="currentColor"></rect>
                            <path d="M12 12 L19 6 V18 Z" fill="currentColor"></path>
                        </svg>
                    </button>
                </div>

                <hr class="border-secondary" />

                <ul class="nav nav-pills flex-column mb-3">
                    <!-- Inicio -->
                    <li class="nav-item mb-1">
                        <NavLink class="nav-link text-white d-flex align-items-center"
                                 activeClass="active bg-primary"
                                 href="/"
                                 Match="NavLinkMatch.All"
                                 title="Inicio"
                                 data-rail-tooltip="true">
                            <i class="bi bi-house-door me-2"></i>
                            <span class="nav-text">Inicio</span>
                        </NavLink>
                    </li>

                    @if (user.IsInRole("administrador"))
                    {
                        <li class="mb-1">
                            <NavLink class="nav-link text-white d-flex align-items-center"
                                     activeClass="active bg-primary"
                                     href="/usuarios"
                                     title="Gestión de Usuarios"
                                     data-rail-tooltip="true">
                                <i class="bi bi-people-gear me-2"></i>
                                <span class="nav-text">Usuarios</span>
                            </NavLink>
                        </li>
                    }


                    @if (user.IsInRole("administrador") || user.IsInRole("recepcionista"))
                    {
                        <!-- Pacientes -->
                        <li class="mb-1">
                            <button class="btn btn-toggle align-items-center rounded text-start text-white w-100"
                                    data-bs-target="#grpPacientes"
                                    aria-expanded="false"
                                    title="Pacientes"
                                    data-rail-tooltip="true"
                                    type="button">
                                <i class="bi bi-people me-2"></i>
                                <span class="nav-text">Pacientes</span>
                            </button>
                            <div class="collapse" id="grpPacientes">
                                <ul class="btn-toggle-nav list-unstyled fw-normal pb-1 small ps-4">
                                    <li><NavLink class="link-light nav-link py-1 px-0"
                                                 activeClass="active"
                                                 href="/pacientes"
                                                 title="Listado"
                                                 data-rail-tooltip="true">Listado</NavLink></li>
                                </ul>
                            </div>
                        </li>

                        <!-- Médicos / Convenios -->
                        <li class="mb-1">
                            <button class="btn btn-toggle align-items-center rounded text-start text-white w-100"
                                    data-bs-target="#grpMedicos"
                                    aria-expanded="false"
                                    title="Médicos"
                                    data-rail-tooltip="true">
                                <i class="bi bi-person-badge me-2"></i>
                                <span class="nav-text">Médicos</span>
                            </button>
                            <div class="collapse" id="grpMedicos">
                                <ul class="btn-toggle-nav list-unstyled fw-normal pb-1 small ps-4">
                                    <li><NavLink class="link-light nav-link py-1 px-0" activeClass="active" href="/medicos" title="Listado" data-rail-tooltip="true">Listado</NavLink></li>
                                    <li><NavLink class="link-light nav-link py-1 px-0" activeClass="active" href="/convenios" title="Convenios" data-rail-tooltip="true">Convenios</NavLink></li>
                                </ul>
                            </div>
                        </li>
                    }

                    @if (user.IsInRole("administrador") || user.IsInRole("laboratorista"))
                    {
                        <!-- Exámenes -->
                        <li class="mb-1">
                            <button class="btn btn-toggle align-items-center rounded text-start text-white w-100"
                                    data-bs-target="#grpExamenes"
                                    aria-expanded="false"
                                    title="Exámenes"
                                    data-rail-tooltip="true">
                                <i class="bi bi-clipboard2-pulse me-2"></i>
                                <span class="nav-text">Exámenes</span>
                            </button>
                            <div class="collapse" id="grpExamenes">
                                <ul class="btn-toggle-nav list-unstyled fw-normal pb-1 small ps-4">
                                    <li><NavLink class="link-light nav-link py-1 px-0"
                                                 activeClass="active"
                                                 href="/examenes"
                                                 title="Catálogo"
                                                 data-rail-tooltip="true">Catálogo</NavLink></li>
                                    <li><NavLink class="link-light nav-link py-1 px-0"
                                                 activeClass="active"
                                                 href="/asociaciones-reactivos"
                                                 title="Asociaciones"
                                                 data-rail-tooltip="true">Asociaciones</NavLink></li>
                                </ul>
                            </div>
                        </li>

                        <!-- Reactivos -->
                        <li class="mb-1">
                            <button class="btn btn-toggle align-items-center rounded text-start text-white w-100"
                                    data-bs-target="#grpReactivos"
                                    aria-expanded="false"
                                    title="Reactivos"
                                    data-rail-tooltip="true">
                                <i class="bi bi-box-seam me-2"></i>
                                <span class="nav-text">Reactivos</span>
                            </button>
                            <div class="collapse" id="grpReactivos">
                                <ul class="btn-toggle-nav list-unstyled fw-normal pb-1 small ps-4">
                                    <li><NavLink class="link-light nav-link py-1 px-0" activeClass="active" href="/reactivos" title="Stock" data-rail-tooltip="true">Stock</NavLink></li>
                                    <li><NavLink class="link-light nav-link py-1 px-0" activeClass="active" href="/movimientos" title="Movimientos" data-rail-tooltip="true">Movimientos</NavLink></li>
                                </ul>
                            </div>
                        </li>
                    }

                    @if (user.IsInRole("administrador") || user.IsInRole("recepcionista") || user.IsInRole("laboratorista") || user.IsInRole("paciente"))
                    {
                        <li class="mb-1">
                            <button class="btn btn-toggle align-items-center rounded text-start text-white w-100"
                                    data-bs-target="#grpOrdenes"
                                    aria-expanded="false"
                                    title="Órdenes Médicas"
                                    data-rail-tooltip="true">
                                <i class="bi bi-file-earmark-medical me-2"></i>
                                <span class="nav-text">
                                    @(user.IsInRole("paciente") ? "Mis Órdenes" : "Órdenes Médicas")
                                </span>
                            </button>
                            <div class="collapse" id="grpOrdenes">
                                <ul class="btn-toggle-nav list-unstyled fw-normal pb-1 small ps-4">
                                    <li>
                                        <NavLink class="link-light nav-link py-1 px-0"
                                                 activeClass="active"
                                                 href="/ordenes"
                                                 title="@(user.IsInRole("paciente") ? "Mis Órdenes" : "Órdenes")"
                                                 data-rail-tooltip="true">
                                            @(user.IsInRole("paciente") ? "Mis Órdenes" : "Órdenes")
                                        </NavLink>
                                    </li>

                                    @if (user.IsInRole("administrador") || user.IsInRole("recepcionista"))
                                    {
                                        <li>
                                            <NavLink class="link-light nav-link py-1 px-0"
                                                     activeClass="active"
                                                     href="/cuentasporcobrar"
                                                     title="Cuentas por Cobrar"
                                                     data-rail-tooltip="true">
                                                Cuentas por Cobrar
                                            </NavLink>
                                        </li>
                                    }
                                </ul>
                            </div>
                        </li>

                        <!-- Resultados -->

                        <li class="mb-1">
                            <button class="btn btn-toggle align-items-center rounded text-start text-white w-100"
                                    data-bs-target="#grpResultados"
                                    aria-expanded="false"
                                    title="Resultados"
                                    data-rail-tooltip="true">
                                <i class="bi bi-clipboard-check me-2"></i>
                                <span class="nav-text">
                                    @(user.IsInRole("paciente") ? "Mis Resultados" : "Resultados")
                                </span>
                            </button>
                            <div class="collapse" id="grpResultados">
                                <ul class="btn-toggle-nav list-unstyled fw-normal pb-1 small ps-4">
                                    <li>
                                        <NavLink class="link-light nav-link py-1 px-0"
                                                 activeClass="active"
                                                 href="/resultados"
                                                 title="@(user.IsInRole("paciente") ? "Mis Resultados" : "Resultados")"
                                                 data-rail-tooltip="true">
                                            @(user.IsInRole("paciente") ? "Mis Resultados" : "Resultados")
                                        </NavLink>
                                    </li>
                                </ul>
                            </div>
                        </li>
                    }

                    <hr class="border-secondary" />


                    <li class="mb-1">
                        <button class="btn btn-toggle align-items-center rounded text-start text-white w-100"
                                data-bs-target="#grpAjustes"
                                aria-expanded="false"
                                title="Ajustes"
                                data-rail-tooltip="true"
                                type="button">
                            <i class="bi bi-gear-fill me-2"></i>
                            <span class="nav-text">Ajustes</span>
                        </button>

                        <div class="collapse" id="grpAjustes">
                            <ul class="btn-toggle-nav list-unstyled fw-normal pb-1 small ps-4">
                                <li><NavLink class="link-light nav-link py-1 px-0" activeClass="active" href="/ajustes/perfil" title="Mi Perfil" data-rail-tooltip="true">Mi Perfil</NavLink></li>
                                <li><NavLink class="link-light nav-link py-1 px-0" activeClass="active" href="/ajustes/seguridad" title="Seguridad" data-rail-tooltip="true">Seguridad</NavLink></li>
                                <li><NavLink class="link-light nav-link py-1 px-0" activeClass="active" href="/ajustes/preferencias" title="Preferencias" data-rail-tooltip="true">Preferencias</NavLink></li>
                            </ul>
                        </div>
                    </li>
                </ul>

                

                <AuthorizeView>
                    <Authorized Context="userState">
                        <div class="sb-user mt-auto p-3 d-flex align-items-center">
                            <div class="sb-user-info flex-grow-1 ms-2">
                                <div class="fw-bold">@GetUserName(userState.User)</div>
                                <small class="text-muted">@GetUserRol(userState.User)</small>
                                <small class="text-muted">@GetUserEmail(userState.User)</small>
                            </div>
                            <button class="btn sb-logout" title="Cerrar sesión" data-rail-tooltip="true" @onclick="Logout">
                                <i class="bi bi-box-arrow-right"></i>
                            </button>
                        </div>
                    </Authorized>
                </AuthorizeView>

            </div>
        </aside>
    </Authorized>

    <NotAuthorized>
        <aside class="sidebar d-flex flex-column flex-shrink-0 bg-dark text-white position-fixed top-0 start-0 h-100 shadow">
            <div class="sb-scroll p-3 d-flex flex-column h-100">
                <div class="sb-header d-flex align-items-center mb-3">
                    <a class="brand d-flex align-items-center text-white text-decoration-none" href="/" title="Inicio">
                        <img src="images/logo-inmaculada.png" alt="Logo Laboratorio" class="brand-logo" />
                    </a>
                    <button class="btn sb-toggle ms-auto" type="button" onclick="window.toggleSidebar()" title="Expandir/Contraer" data-rail-tooltip="true">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 28 24" class="sb-toggle-icon">
                            <rect x="3" y="3" width="5" height="18" rx="1.2" fill="currentColor"></rect>
                            <path d="M12 12 L19 6 V18 Z" fill="currentColor"></path>
                        </svg>
                    </button>
                </div>

                <hr class="border-secondary" />

                <ul class="nav nav-pills flex-column mb-3">
                    <li class="nav-item mb-1">
                        <NavLink class="nav-link text-white d-flex align-items-center"
                                 activeClass="active bg-primary"
                                 href="/"
                                 Match="NavLinkMatch.All"
                                 title="Inicio"
                                 data-rail-tooltip="true">
                            <i class="bi bi-house-door me-2"></i>
                            <span class="nav-text">Inicio</span>
                        </NavLink>
                    </li>
                </ul>
            </div>
        </aside>
    </NotAuthorized>
</AuthorizeView>

@code {
    private async Task Logout()
    {
        if (AuthProvider is CustomAuthenticationStateProvider customAuth)
            await customAuth.SignOutAsync();
        Navigation.NavigateTo("/login", replace: true);
    }

    private string GetUserName(ClaimsPrincipal user) => user?.Identity?.Name ?? "Usuario";
    private string GetUserEmail(ClaimsPrincipal user) => user?.FindFirst("email")?.Value ?? "correo@ejemplo.com";
    private string GetUserRol(ClaimsPrincipal user)
    {
        var rawRol = user?.FindFirst(ClaimTypes.Role)?.Value ?? "";
        return rawRol switch
        {
            "administrador" => "Administrador",
            "recepcionista" => "Recepcionista",
            "laboratorista" => "Laboratorista",
            "paciente" => "Paciente",
            _ => rawRol
        };
    }
}
