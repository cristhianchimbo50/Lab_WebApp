@page "/usuarios"
<PageTitle>Gestión de Usuarios</PageTitle>
@using Lab_Blazor.Services.Usuarios
@using Lab_Contracts.Usuarios
@using Microsoft.AspNetCore.Components.Authorization
@inject IUsuariosApiService UsuariosApi
@using Lab_Blazor.Services.Auth
@inject SesionVerificacionService SesionService
@inject IJSRuntime JS
@inject AuthenticationStateProvider AuthProvider

<AuthorizeView>
    <Authorized Context="authState">
        @{
            var user = authState.User;
            var rol = user.FindFirst(System.Security.Claims.ClaimTypes.Role)?.Value ?? "";
            bool puedeGestionar = rol == "administrador";
        }

        @if (!puedeGestionar)
        {
            <div class="d-flex justify-content-center align-items-center vh-100">
                <div class="card shadow-lg text-center border-0" style="max-width: 450px;">
                    <div class="card-body p-4">
                        <i class="bi bi-shield-lock text-primary fs-1 mb-3"></i>
                        <h5 class="fw-bold mb-2">Acceso no autorizado</h5>
                        <p class="text-muted mb-3">No tienes permisos para acceder a la gestión de usuarios.</p>
                        <button class="btn btn-outline-primary" @onclick="VolverAtrasAsync">
                            <i class="bi bi-arrow-left"></i> Regresar
                        </button>
                    </div>
                </div>
            </div>
        }
        else
        {
            <h3 class="mb-4 d-flex align-items-center text-uppercase justify-content-between fw-bold flex-wrap">
                <span><i class="bi bi-people-fill me-2 text-primary fs-4"></i>Gestión de Usuarios</span>
                <button class="btn btn-success shadow-sm" @onclick="AbrirModalNuevo">
                    <i class="bi bi-person-plus-fill me-1"></i>Nuevo Usuario
                </button>
            </h3>

            <div class="card mb-3 shadow-sm border-0">
                <div class="card-body row g-3 align-items-end">
                    <div class="col-md-3">
                        <label class="form-label fw-semibold">Filtrar por</label>
                        <select class="form-select" @bind="_campoFiltro">
                            <option value="">-- Seleccione --</option>
                            <option value="nombre">Nombre</option>
                            <option value="correo">Correo</option>
                            <option value="rol">Rol</option>
                            <option value="activo">Estado</option>
                        </select>
                    </div>
                    <div class="col-md-5">
                        <label class="form-label fw-semibold">Valor</label>
                        @if (_campoFiltro == "rol")
                        {
                            <select class="form-select" @bind="_valorFiltro">
                                <option value="">-- Todos --</option>
                                <option value="administrador">Administrador</option>
                                <option value="recepcionista">Recepcionista</option>
                                <option value="laboratorista">Laboratorista</option>
                            </select>
                        }
                        else if (_campoFiltro == "activo")
                        {
                            <select class="form-select" @bind="_valorFiltro">
                                <option value="">-- Todos --</option>
                                <option value="true">Activo</option>
                                <option value="false">Inactivo</option>
                            </select>
                        }
                        else
                        {
                            <input class="form-control" @bind="_valorFiltro" placeholder="Ingrese valor a buscar..." />
                        }
                    </div>
                    <div class="col-md-2 text-end">
                        <button class="btn btn-primary w-100 shadow-sm" @onclick="BuscarAsync">
                            <i class="bi bi-search">Buscar</i>
                        </button>
                    </div>
                    <div class="col-md-2 text-end">
                        <button class="btn btn-outline-secondary w-100 shadow-sm" @onclick="LimpiarFiltro">
                            <i class="bi bi-eraser"></i>
                        </button>
                    </div>
                </div>
            </div>

            @if (!string.IsNullOrEmpty(_mensaje))
            {
                <div class="alert alert-@_tipoMensaje alert-dismissible fade show" role="alert">
                    @_mensaje
                    <button type="button" class="btn-close" @onclick="() => _mensaje = null"></button>
                </div>
            }

            @if (!_mostroBusqueda)
            {
                <div class="alert alert-info text-center">
                    <i class="bi bi-info-circle me-2"></i> Usa los filtros y presiona <strong>Buscar</strong> para ver los usuarios.
                </div>
            }
            else if (_usuarios.Count == 0)
            {
                <div class="alert alert-warning text-center">
                    <i class="bi bi-exclamation-triangle me-2"></i> No se encontraron usuarios internos.
                </div>
            }
            else
            {
                <div class="table-responsive shadow-sm rounded">
                    <table class="table table-striped table-hover align-middle text-center">
                        <thead class="table-light">
                            <tr>
                                <th>Nombre</th>
                                <th>Correo</th>
                                <th>Rol</th>
                                <th>Estado</th>
                                <th>Creación</th>
                                <th>Último acceso</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var usuario in _usuarios)
                            {
                                <tr>
                                    <td>@usuario.NombreUsuario</td>
                                    <td>@usuario.CorreoUsuario</td>
                                    <td class="text-capitalize">@usuario.Rol</td>
                                    <td>
                                        <span class="badge bg-@(usuario.Activo ? "success" : "secondary")">
                                            @(usuario.Activo ? "Activo" : "Inactivo")
                                        </span>
                                    </td>
                                    <td>@usuario.FechaCreacion.ToLocalTime().ToString("yyyy-MM-dd HH:mm")</td>
                                    <td>@(usuario.UltimoAcceso?.ToLocalTime().ToString("yyyy-MM-dd HH:mm") ?? "-")</td>
                                    <td>
                                        <div class="d-flex justify-content-center gap-2">
                                            <button class="btn btn-link p-0 text-primary" title="Ver detalle"
                                                    @onclick="() => AbrirModalDetalleAsync(usuario.IdUsuario)">
                                                <i class="bi bi-eye"></i>
                                            </button>
                                            <button class="btn btn-sm btn-outline-primary" title="Editar"
                                                    @onclick="() => AbrirModalEditar(usuario)">
                                                <i class="bi bi-pencil-square"></i>
                                            </button>
                                            <button class="btn btn-sm @(usuario.Activo ? "btn-outline-danger" : "btn-outline-success")"
                                                    title="@(usuario.Activo ? "Deshabilitar" : "Habilitar")"
                                                    @onclick="() => CambiarEstadoAsync(usuario)"
                                                    disabled="@(usuario.CorreoUsuario == _usuarioActualCorreo)">
                                                <i class="bi @(usuario.Activo ? "bi-x-circle-fill" : "bi-check-circle-fill")"></i>
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            }

            <div class="modal fade @(_modalDetalleVisible ? "show d-block" : "")" tabindex="-1" style="background-color: rgba(0,0,0,0.5);">
                <div class="modal-dialog modal-md modal-dialog-centered">
                    <div class="modal-content shadow-lg border-0">
                        <div class="modal-header bg-info text-white">
                            <h5 class="modal-title"><i class="bi bi-eye me-2"></i>Detalle de Usuario</h5>
                            <button type="button" class="btn-close" @onclick="CerrarModalDetalle">
                            </button>
                        </div>
                        <div class="modal-body">
                            @if (_detalleUsuario != null)
                            {
                                <ul class="list-group list-group-flush">
                                    <li class="list-group-item"><strong>Nombre:</strong> @_detalleUsuario.NombreUsuario</li>
                                    <li class="list-group-item"><strong>Correo:</strong> @_detalleUsuario.CorreoUsuario</li>
                                    <li class="list-group-item"><strong>Rol:</strong> <span class="text-capitalize">@_detalleUsuario.Rol</span></li>
                                    <li class="list-group-item"><strong>Activo:</strong> @_detalleUsuario.Activo ? "Sí" : "No"</li>
                                    <li class="list-group-item"><strong>Fecha creación:</strong> @_detalleUsuario.FechaCreacion.ToLocalTime()</li>
                                    <li class="list-group-item"><strong>Último acceso:</strong> @_detalleUsuario.UltimoAcceso?.ToLocalTime().ToString() ?? "-"</li>
                                </ul>
                            }
                        </div>
                        <div class="modal-footer">
                            <button class="btn btn-secondary" @onclick="CerrarModalDetalle">
                                <i class="bi bi-x-lg me-1"></i>Cerrar
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="modal fade @(_modalVisible ? "show d-block" : "")" tabindex="-1" style="background-color: rgba(0,0,0,0.5);">
                <div class="modal-dialog modal-md modal-dialog-centered">
                    <div class="modal-content shadow-lg border-0">
                        <EditForm Model="@_usuarioActual" OnValidSubmit="GuardarUsuarioAsync">
                            <div class="modal-header bg-primary text-white">
                                <h5 class="modal-title">
                                    <i class="bi bi-person-circle me-2"></i>@(_usuarioActual.IdUsuario == 0 ? "Nuevo Usuario" : "Editar Usuario")
                                </h5>
                                <button type="button" class="btn-close" @onclick="CerrarModal">
                                </button>
                            </div>
                            <div class="modal-body">
                                <DataAnnotationsValidator />
                                <ValidationSummary />
                                <div class="mb-2">
                                    <label class="form-label">Nombre</label>
                                    <InputText class="form-control" @bind-Value="_usuarioActual.NombreUsuario" />
                                </div>
                                <div class="mb-2">
                                    <label class="form-label">Correo</label>
                                    <InputText class="form-control" @bind-Value="_usuarioActual.CorreoUsuario" readonly="@(_usuarioActual.IdUsuario != 0)" />
                                </div>
                                <div class="mb-2">
                                    <label class="form-label">Rol</label>
                                    <InputSelect class="form-select" @bind-Value="_usuarioActual.Rol">
                                        <option value="">Seleccione</option>
                                        <option value="administrador">Administrador</option>
                                        <option value="recepcionista">Recepcionista</option>
                                        <option value="laboratorista">Laboratorista</option>
                                    </InputSelect>
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="submit" class="btn btn-primary" disabled="@_cargando">
                                    <i class="bi bi-save me-1"></i>Guardar
                                </button>
                                <button type="button" class="btn btn-secondary" @onclick="CerrarModal">
                                    <i class="bi bi-x-lg me-1"></i>Cancelar
                                </button>
                            </div>
                        </EditForm>
                    </div>
                </div>
            </div>
        }
    </Authorized>

    <NotAuthorized>
        <div class="d-flex justify-content-center align-items-center vh-100">
            <div class="card shadow-lg text-center border-0" style="max-width: 450px;">
                <div class="card-body p-4">
                    <i class="bi bi-person-x text-danger fs-1 mb-3"></i>
                    <h5 class="fw-bold mb-2">Debe iniciar sesión</h5>
                    <p class="text-muted mb-3">Para acceder a esta sección, por favor inicie sesión con una cuenta autorizada.</p>
                    <NavLink href="/login" class="btn btn-primary">
                        <i class="bi bi-box-arrow-in-right"></i> Ir al Login
                    </NavLink>
                </div>
            </div>
        </div>
    </NotAuthorized>
</AuthorizeView>

@code {
    private List<UsuarioListadoDto> _usuarios = new();
    private UsuarioFiltroDto _filtro = new();
    private UsuarioEditarDto _usuarioActual = new();
    private UsuarioListadoDto? _detalleUsuario;
    private bool _modalVisible, _modalDetalleVisible, _cargando, _esNuevo, _mostroBusqueda;
    private string _mensaje = "", _tipoMensaje = "info";
    private string _campoFiltro = "", _valorFiltro = "";
    private string _usuarioActualCorreo = "";
    private bool _sesionVerificada = false;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender && !_sesionVerificada)
        {
            _sesionVerificada = true;

            if (!await SesionService.VerificarOSalirAsync())
                return;

            var auth = await AuthProvider.GetAuthenticationStateAsync();
            _usuarioActualCorreo = auth.User?.Identity?.Name ?? "";
            StateHasChanged();
        }
    }

    private async Task VolverAtrasAsync() => await JS.InvokeVoidAsync("history.back");

    private async Task BuscarAsync()
    {
        if (!await SesionService.VerificarOSalirAsync()) return;

        _mostroBusqueda = true;
        _filtro = new();
        if (!string.IsNullOrWhiteSpace(_campoFiltro) && !string.IsNullOrWhiteSpace(_valorFiltro))
        {
            switch (_campoFiltro)
            {
                case "nombre": _filtro.Nombre = _valorFiltro; break;
                case "correo": _filtro.Correo = _valorFiltro; break;
                case "rol": _filtro.Rol = _valorFiltro; break;
                case "activo": _filtro.Activo = _valorFiltro switch { "true" => true, "false" => false, _ => null }; break;
            }
        }
        _usuarios = await UsuariosApi.ListarUsuariosAsync(_filtro);
    }

    private void LimpiarFiltro()
    {
        _campoFiltro = _valorFiltro = "";
        _mostroBusqueda = false;
        _usuarios.Clear();
    }

    private void AbrirModalNuevo()
    {
        _usuarioActual = new() { Activo = true };
        _esNuevo = true;
        _modalVisible = true;
        JS.InvokeVoidAsync("marcarModalAbierto");
    }

    private void AbrirModalEditar(UsuarioListadoDto user)
    {
        _usuarioActual = new()
        {
            IdUsuario = user.IdUsuario,
            NombreUsuario = user.NombreUsuario,
            CorreoUsuario = user.CorreoUsuario,
            Rol = user.Rol,
            Activo = user.Activo
        };
        _esNuevo = false;
        _modalVisible = true;
        JS.InvokeVoidAsync("marcarModalAbierto");
    }

    private void CerrarModal()
    {
        _modalVisible = false;
        JS.InvokeVoidAsync("marcarModalCerrado");
    }

    private async Task GuardarUsuarioAsync()
    {
        if (!await SesionService.VerificarOSalirAsync()) return;

        _cargando = true;
        try
        {
            if (_esNuevo)
            {
                var crearDto = new UsuarioCrearDto
                {
                    NombreUsuario = _usuarioActual.NombreUsuario,
                    CorreoUsuario = _usuarioActual.CorreoUsuario,
                    Rol = _usuarioActual.Rol
                };

                await UsuariosApi.GuardarUsuarioAsync(crearDto);
                _mensaje = "Usuario registrado correctamente. Se ha enviado un enlace de activación al correo del usuario.";
            }
            else
            {
                await UsuariosApi.GuardarUsuarioAsync(_usuarioActual);
                _mensaje = "Usuario actualizado correctamente.";
            }

            _tipoMensaje = "success";
            _modalVisible = false;
            await BuscarAsync();
        }
        catch (Exception ex)
        {
            _mensaje = $"Error: {ex.Message}";
            _tipoMensaje = "danger";
        }
        finally
        {
            _cargando = false;
            JS.InvokeVoidAsync("marcarModalCerrado");
        }
    }

    private async Task CambiarEstadoAsync(UsuarioListadoDto usuario)
    {
        if (!await SesionService.VerificarOSalirAsync()) return;

        if (usuario.CorreoUsuario == _usuarioActualCorreo)
        {
            _mensaje = "No puedes deshabilitar tu propio usuario.";
            _tipoMensaje = "warning";
            return;
        }

        bool confirmar = await JS.InvokeAsync<bool>("confirm", usuario.Activo ? "¿Deseas deshabilitar este usuario?" : "¿Deseas habilitar este usuario?");
        if (!confirmar) return;

        try
        {
            await UsuariosApi.CambiarEstadoUsuarioAsync(usuario.IdUsuario, !usuario.Activo);
            _mensaje = usuario.Activo ? "Usuario desactivado." : "Usuario activado.";
            _tipoMensaje = "success";
            await BuscarAsync();
        }
        catch (Exception ex)
        {
            _mensaje = ex.Message;
            _tipoMensaje = "danger";
        }
    }

    private async Task AbrirModalDetalleAsync(int idUsuario)
    {
        if (!await SesionService.VerificarOSalirAsync()) return;

        _detalleUsuario = await UsuariosApi.ObtenerDetalleUsuarioAsync(idUsuario);
        _modalDetalleVisible = true;
        JS.InvokeVoidAsync("marcarModalAbierto");
    }

    private void CerrarModalDetalle()
    {
        _modalDetalleVisible = false;
        JS.InvokeVoidAsync("marcarModalCerrado");
    }
}
