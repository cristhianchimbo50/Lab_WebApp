@page "/usuarios"
@using Lab_Contracts.Usuarios
@using Microsoft.AspNetCore.Components.Authorization
@inject Lab_Blazor.Services.Usuarios.IUsuariosApiService UsuariosApi
@inject IJSRuntime JS
@inject AuthenticationStateProvider AuthProvider

<h3 class="mb-4 d-flex align-items-center justify-content-between flex-wrap">
    <span><i class="bi bi-people-fill me-2 text-primary"></i>Gestión de Usuarios</span>
    <button class="btn btn-success" @onclick="AbrirModalNuevo">
        <i class="bi bi-person-plus-fill me-1"></i>Nuevo Usuario
    </button>
</h3>

<div class="card mb-3 shadow-sm">
    <div class="card-body row g-3 align-items-end">
        <div class="col-md-3">
            <label class="form-label">Filtrar por</label>
            <select class="form-select" @bind="campoFiltro">
                <option value="">-- Seleccione --</option>
                <option value="nombre">Nombre</option>
                <option value="correo">Correo</option>
                <option value="rol">Rol</option>
                <option value="activo">Estado</option>
            </select>
        </div>
        <div class="col-md-5">
            <label class="form-label">Valor</label>
            @if (campoFiltro == "rol")
            {
                <select class="form-select" @bind="valorFiltro">
                    <option value="">-- Todos --</option>
                    <option value="administrador">Administrador</option>
                    <option value="recepcionista">Recepcionista</option>
                    <option value="laboratorista">Laboratorista</option>
                </select>
            }
            else if (campoFiltro == "activo")
            {
                <select class="form-select" @bind="valorFiltro">
                    <option value="">-- Todos --</option>
                    <option value="true">Activo</option>
                    <option value="false">Inactivo</option>
                </select>
            }
            else
            {
                <input class="form-control" @bind="valorFiltro" />
            }
        </div>
        <div class="col-md-2 text-end">
            <button class="btn btn-primary w-100" @onclick="Buscar">
                <i class="bi bi-search"></i>
            </button>
        </div>
        <div class="col-md-2 text-end">
            <button class="btn btn-secondary w-100" @onclick="LimpiarFiltro">
                <i class="bi bi-eraser"></i>
            </button>
        </div>
    </div>
</div>

@if (!string.IsNullOrEmpty(mensaje))
{
    <div class="alert alert-@tipoMensaje alert-dismissible fade show" role="alert">
        @mensaje
        <button type="button" class="btn-close" @onclick="() => mensaje = null"></button>
    </div>
}

@if (!mostroBusqueda)
{
    <div class="alert alert-info text-center">
        Utiliza los filtros y haz clic en <strong>Buscar</strong> para ver los usuarios.
    </div>
}
else if (usuarios.Count == 0)
{
    <div class="alert alert-warning text-center">No se encontraron usuarios internos.</div>
}
else
{
    <div class="table-responsive shadow-sm rounded">
        <table class="table table-striped table-hover align-middle text-center">
            <thead class="table-light">
                <tr>
                    <th>Nombre</th>
                    <th>Correo</th>
                    <th>Rol</th>
                    <th>Estado</th>
                    <th>Temporal</th>
                    <th>Creación</th>
                    <th>Último acceso</th>
                    <th>Acciones</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var usuario in usuarios)
                {
                    <tr>
   
                        <td>@usuario.NombreUsuario</td>
                        <td>@usuario.CorreoUsuario</td>
                        <td class="text-capitalize">@usuario.Rol</td>
                        <td>
                            <span class="badge bg-@(usuario.Activo ? "success" : "secondary")">
                                @(usuario.Activo ? "Activo" : "Inactivo")
                            </span>
                        </td>
                        <td>
                            @if (usuario.EsContraseniaTemporal)
                            {
                                <span class="badge bg-warning text-dark">Temporal</span>
                            }
                        </td>
                        <td>@usuario.FechaCreacion.ToLocalTime().ToString("yyyy-MM-dd HH:mm")</td>
                        <td>@(usuario.UltimoAcceso?.ToLocalTime().ToString("yyyy-MM-dd HH:mm"))</td>
                        <td>
                            <button class="btn btn-link p-0" title="Ver detalle" @onclick="() => AbrirModalDetalle(usuario.IdUsuario)">
                                <i class="bi bi-eye"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-primary me-1" @onclick="() => AbrirModalEditar(usuario)">
                                <i class="bi bi-pencil-square"></i>
                            </button>
                            <button class="btn btn-sm @(usuario.Activo ? "btn-outline-danger" : "btn-outline-success")"
                                    @onclick="() => CambiarEstado(usuario)"
                                    disabled="@(usuario.CorreoUsuario == usuarioActualCorreo)">
                                <i class="bi @(usuario.Activo ? "bi-x-circle-fill" : "bi-check-circle-fill")"></i>
                            </button>
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    </div>
}

<div class="modal fade @(modalDetalleVisible ? "show d-block" : "")" tabindex="-1" style="background-color: rgba(0,0,0,0.5);" aria-modal="true" role="dialog">
    <div class="modal-dialog modal-md modal-dialog-centered">
        <div class="modal-content shadow-lg border-0">
            <div class="modal-header bg-info text-white">
                <h5 class="modal-title"><i class="bi bi-eye me-2"></i>Detalle de Usuario</h5>
                <button type="button" class="btn-close" @onclick="CerrarModalDetalle"></button>
            </div>
            <div class="modal-body">
                @if (detalleUsuario != null)
                {
                    <div class="mb-3 text-center">
                        <i class="bi bi-person-circle" style="font-size:2.5rem; color:#007bff"></i>
                    </div>
                    <ul class="list-group list-group-flush mb-2">
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            <span class="fw-semibold">Nombre:</span>
                            <span>@detalleUsuario.NombreUsuario</span>
                        </li>
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            <span class="fw-semibold">Correo:</span>
                            <span>@detalleUsuario.CorreoUsuario</span>
                        </li>
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            <span class="fw-semibold">Rol:</span>
                            <span class="text-capitalize">@detalleUsuario.Rol</span>
                        </li>
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            <span class="fw-semibold">Contraseña temporal:</span>
                            <span>@(detalleUsuario.EsContraseniaTemporal ? "Sí" : "No")</span>
                        </li>
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            <span class="fw-semibold">Activo:</span>
                            <span>@(detalleUsuario.Activo ? "Sí" : "No")</span>
                        </li>
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            <span class="fw-semibold">Fecha de creación:</span>
                            <span>@detalleUsuario.FechaCreacion.ToLocalTime().ToString("yyyy-MM-dd HH:mm")</span>
                        </li>
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            <span class="fw-semibold">Último acceso:</span>
                            <span>@(detalleUsuario.UltimoAcceso?.ToLocalTime().ToString("yyyy-MM-dd HH:mm") ?? "-")</span>
                        </li>
                    </ul>
                }
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" @onclick="CerrarModalDetalle">
                    <i class="bi bi-x-lg me-1"></i>Cerrar
                </button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade @(modalVisible ? "show d-block" : "")" tabindex="-1" style="background-color: rgba(0,0,0,0.5);" aria-modal="true" role="dialog">
    <div class="modal-dialog modal-md modal-dialog-centered">
        <div class="modal-content shadow-lg border-0">
            <EditForm Model="@usuarioActual" OnValidSubmit="GuardarUsuario">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title">
                        <i class="bi bi-person-circle me-2"></i>@(usuarioActual.IdUsuario == 0 ? "Nuevo Usuario" : "Editar Usuario")
                    </h5>
                    <button type="button" class="btn-close" @onclick="CerrarModal"></button>
                </div>
                <div class="modal-body">
                    <DataAnnotationsValidator />
                    <ValidationSummary />
                    <div class="mb-2">
                        <label class="form-label">Nombre</label>
                        <InputText class="form-control" @bind-Value="usuarioActual.NombreUsuario" />
                    </div>
                    <div class="mb-2">
                        <label class="form-label">Correo</label>
                        <InputText class="form-control" @bind-Value="usuarioActual.CorreoUsuario"
                                   readonly="@(usuarioActual.IdUsuario != 0)" />
                    </div>
                    <div class="mb-2">
                        <label class="form-label">Rol</label>
                        <InputSelect class="form-select" @bind-Value="usuarioActual.Rol">
                            <option value="">Seleccione</option>
                            <option value="administrador">Administrador</option>
                            <option value="recepcionista">Recepcionista</option>
                            <option value="laboratorista">Laboratorista</option>
                        </InputSelect>
                    </div>
                    @if (usuarioActual.IdUsuario != 0 && usuarioActual.Activo && usuarioActual.EsContraseniaTemporal)
                    {
                        <div class="mb-2">
                            <button type="button" class="btn btn-warning w-100" @onclick="() => ReenviarCredenciales(usuarioActual.IdUsuario)">
                                <i class="bi bi-envelope-arrow-up me-1"></i>Reenviar contraseña temporal
                            </button>
                        </div>
                    }

                </div>
                <div class="modal-footer">
                    <button type="submit" class="btn btn-primary" disabled="@cargando">
                        <i class="bi bi-save me-1"></i>Guardar
                    </button>
                    <button type="button" class="btn btn-secondary" @onclick="CerrarModal">
                        <i class="bi bi-x-lg me-1"></i>Cancelar
                    </button>
                </div>
            </EditForm>
        </div>
    </div>
</div>

@code {
    List<UsuarioListadoDto> usuarios = new();
    UsuarioFiltroDto filtro = new();
    UsuarioEditarDto usuarioActual = new();
    bool modalVisible = false;
    bool cargando = false;
    string mensaje = "";
    string tipoMensaje = "info";
    bool esNuevo = true;
    bool firstRenderDone = false;
    bool mostroBusqueda = false;

    string campoFiltro = "";
    string valorFiltro = "";

    bool modalDetalleVisible = false;
    UsuarioListadoDto? detalleUsuario;

    string usuarioActualCorreo = "";

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender && !firstRenderDone)
        {
            firstRenderDone = true;
            var authState = await AuthProvider.GetAuthenticationStateAsync();
            usuarioActualCorreo = authState.User?.Identity?.Name ?? "";
            StateHasChanged();
        }
    }

    async Task Buscar()
    {
        filtro = new UsuarioFiltroDto();
        mostroBusqueda = true;

        if (string.IsNullOrWhiteSpace(campoFiltro) || string.IsNullOrWhiteSpace(valorFiltro))
        {
            usuarios = await UsuariosApi.GetUsuariosAsync(filtro);
            return;
        }

        switch (campoFiltro)
        {
            case "nombre":
                filtro.Nombre = valorFiltro;
                break;
            case "correo":
                filtro.Correo = valorFiltro;
                break;
            case "rol":
                filtro.Rol = valorFiltro;
                break;
            case "activo":
                filtro.Activo = valorFiltro == "true" ? true : valorFiltro == "false" ? false : (bool?)null;
                break;
        }
        usuarios = await UsuariosApi.GetUsuariosAsync(filtro);
    }

    void LimpiarFiltro()
    {
        campoFiltro = "";
        valorFiltro = "";
        mostroBusqueda = false;
        usuarios = new();
    }

    void AbrirModalNuevo()
    {
        usuarioActual = new UsuarioEditarDto
        {
            IdUsuario = 0,
            NombreUsuario = "",
            CorreoUsuario = "",
            Rol = "",
            Activo = true
        };
        esNuevo = true;
        modalVisible = true;
    }

    void AbrirModalEditar(UsuarioListadoDto user)
    {
        usuarioActual = new UsuarioEditarDto
        {
            IdUsuario = user.IdUsuario,
            NombreUsuario = user.NombreUsuario,
            CorreoUsuario = user.CorreoUsuario,
            Rol = user.Rol,
            Activo = user.Activo,
            EsContraseniaTemporal = user.EsContraseniaTemporal
        };
        esNuevo = false;
        modalVisible = true;
    }

    void CerrarModal()
    {
        modalVisible = false;
        usuarioActual = new UsuarioEditarDto();
    }

    async Task GuardarUsuario()
    {
        cargando = true;
        if (esNuevo)
        {
            var crearDto = new UsuarioCrearDto
            {
                NombreUsuario = usuarioActual.NombreUsuario,
                CorreoUsuario = usuarioActual.CorreoUsuario,
                Rol = usuarioActual.Rol
            };
            await UsuariosApi.CrearUsuarioAsync(crearDto);
            mensaje = "Usuario registrado y correo enviado.";
            tipoMensaje = "success";
        }
        else
        {
            await UsuariosApi.EditarUsuarioAsync(usuarioActual);
            mensaje = "Usuario actualizado.";
            tipoMensaje = "success";
        }
        modalVisible = false;
        cargando = false;
        await Buscar();
    }

    async Task CambiarEstado(UsuarioListadoDto usuario)
    {
        if (usuario.CorreoUsuario == usuarioActualCorreo)
        {
            mensaje = "No puedes deshabilitar tu propio usuario.";
            tipoMensaje = "danger";
            return;
        }

        var confirmar = await JS.InvokeAsync<bool>("confirm",
            usuario.Activo ? "¿Desea deshabilitar este usuario?" : "¿Desea habilitar este usuario?");
        if (!confirmar) return;

        try
        {
            await UsuariosApi.CambiarEstadoAsync(usuario.IdUsuario, !usuario.Activo);
            mensaje = !usuario.Activo ? "Usuario activado." : "Usuario desactivado.";
            tipoMensaje = "success";
            await Buscar();
        }
        catch (Exception ex)
        {
            mensaje = ex.Message;
            tipoMensaje = "danger";
        }
    }


    async Task ReenviarCredenciales(int idUsuario)
    {
        var ok = await JS.InvokeAsync<bool>("confirm", "¿Deseas reenviar una nueva contraseña temporal?");
        if (!ok) return;
        var result = await UsuariosApi.ReenviarCredencialesTemporalesAsync(idUsuario);
        mensaje = "Se envió la nueva contraseña temporal al correo.";
        tipoMensaje = "info";
        await Buscar();
    }

    async Task AbrirModalDetalle(int idUsuario)
    {
        detalleUsuario = await UsuariosApi.GetUsuarioPorIdAsync(idUsuario);
        modalDetalleVisible = true;
        StateHasChanged();
    }

    void CerrarModalDetalle()
    {
        modalDetalleVisible = false;
        detalleUsuario = null;
    }
}
