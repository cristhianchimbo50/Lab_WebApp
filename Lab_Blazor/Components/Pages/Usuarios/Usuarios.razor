@page "/usuarios"
@using Lab_Blazor.Services.Usuarios
@using Lab_Contracts.Usuarios
@using Microsoft.AspNetCore.Components.Authorization
@inject IUsuariosApiService UsuariosApi
@using Lab_Blazor.Services.Auth
@inject SesionVerificacionService SesionService
@inject IJSRuntime JS
@inject AuthenticationStateProvider AuthProvider

<AuthorizeView>
    <Authorized Context="authState">
        @{
            var user = authState.User;
            var rol = user.FindFirst(System.Security.Claims.ClaimTypes.Role)?.Value ?? "";
            bool puedeGestionar = rol == "administrador";
        }

        @if (!puedeGestionar)
        {
            <div class="d-flex justify-content-center align-items-center vh-100">
                <div class="card shadow-lg text-center border-0" style="max-width: 450px;">
                    <div class="card-body p-4">
                        <i class="bi bi-shield-lock text-primary fs-1 mb-3"></i>
                        <h5 class="fw-bold mb-2">Acceso no autorizado</h5>
                        <p class="text-muted mb-3">No tienes permisos para acceder a la gestión de usuarios.</p>
                        <button class="btn btn-outline-primary" @onclick="VolverAtras">
                            <i class="bi bi-arrow-left"></i> Regresar
                        </button>
                    </div>
                </div>
            </div>
        }
        else
        {
            <h3 class="mb-4 d-flex align-items-center text-uppercase justify-content-between fw-bold flex-wrap">
                <span><i class="bi bi-people-fill me-2 text-primary fs-4"></i>Gestión de Usuarios</span>
                <button class="btn btn-success shadow-sm" @onclick="AbrirModalNuevo">
                    <i class="bi bi-person-plus-fill me-1"></i>Nuevo Usuario
                </button>
            </h3>

            <div class="card mb-3 shadow-sm border-0">
                <div class="card-body row g-3 align-items-end">
                    <div class="col-md-3">
                        <label class="form-label fw-semibold">Filtrar por</label>
                        <select class="form-select" @bind="campoFiltro">
                            <option value="">-- Seleccione --</option>
                            <option value="nombre">Nombre</option>
                            <option value="correo">Correo</option>
                            <option value="rol">Rol</option>
                            <option value="activo">Estado</option>
                        </select>
                    </div>
                    <div class="col-md-5">
                        <label class="form-label fw-semibold">Valor</label>
                        @if (campoFiltro == "rol")
                        {
                            <select class="form-select" @bind="valorFiltro">
                                <option value="">-- Todos --</option>
                                <option value="administrador">Administrador</option>
                                <option value="recepcionista">Recepcionista</option>
                                <option value="laboratorista">Laboratorista</option>
                            </select>
                        }
                        else if (campoFiltro == "activo")
                        {
                            <select class="form-select" @bind="valorFiltro">
                                <option value="">-- Todos --</option>
                                <option value="true">Activo</option>
                                <option value="false">Inactivo</option>
                            </select>
                        }
                        else
                        {
                            <input class="form-control" @bind="valorFiltro" placeholder="Ingrese valor a buscar..." />
                        }
                    </div>
                    <div class="col-md-2 text-end">
                        <button class="btn btn-primary w-100 shadow-sm" @onclick="Buscar">
                            <i class="bi bi-search">Buscar</i>
                        </button>
                    </div>
                    <div class="col-md-2 text-end">
                        <button class="btn btn-outline-secondary w-100 shadow-sm" @onclick="LimpiarFiltro">
                            <i class="bi bi-eraser"></i>
                        </button>
                    </div>
                </div>
            </div>

            @if (!string.IsNullOrEmpty(mensaje))
            {
                <div class="alert alert-@tipoMensaje alert-dismissible fade show" role="alert">
                    @mensaje
                    <button type="button" class="btn-close" @onclick="() => mensaje = null"></button>
                </div>
            }

            @if (!mostroBusqueda)
            {
                <div class="alert alert-info text-center">
                    <i class="bi bi-info-circle me-2"></i> Usa los filtros y presiona <strong>Buscar</strong> para ver los usuarios.
                </div>
            }
            else if (usuarios.Count == 0)
            {
                <div class="alert alert-warning text-center">
                    <i class="bi bi-exclamation-triangle me-2"></i> No se encontraron usuarios internos.
                </div>
            }
            else
            {
                <div class="table-responsive shadow-sm rounded">
                    <table class="table table-striped table-hover align-middle text-center">
                        <thead class="table-light">
                            <tr>
                                <th>Nombre</th>
                                <th>Correo</th>
                                <th>Rol</th>
                                <th>Estado</th>
                                <th>Temporal</th>
                                <th>Creación</th>
                                <th>Último acceso</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var usuario in usuarios)
                            {
                                <tr>
                                    <td>@usuario.NombreUsuario</td>
                                    <td>@usuario.CorreoUsuario</td>
                                    <td class="text-capitalize">@usuario.Rol</td>
                                    <td>
                                        <span class="badge bg-@(usuario.Activo ? "success" : "secondary")">
                                            @(usuario.Activo ? "Activo" : "Inactivo")
                                        </span>
                                    </td>
                                    <td>
                                        @if (usuario.EsContraseniaTemporal)
                                        {
                                            <span class="badge bg-warning text-dark">Temporal</span>
                                        }
                                    </td>
                                    <td>@usuario.FechaCreacion.ToLocalTime().ToString("yyyy-MM-dd HH:mm")</td>
                                    <td>@(usuario.UltimoAcceso?.ToLocalTime().ToString("yyyy-MM-dd HH:mm") ?? "-")</td>
                                    <td>
                                        <div class="d-flex justify-content-center gap-2">
                                            <button class="btn btn-link p-0 text-primary" title="Ver detalle"
                                                    @onclick="() => AbrirModalDetalle(usuario.IdUsuario)">
                                                <i class="bi bi-eye"></i>
                                            </button>
                                            <button class="btn btn-sm btn-outline-primary" title="Editar"
                                                    @onclick="() => AbrirModalEditar(usuario)">
                                                <i class="bi bi-pencil-square"></i>
                                            </button>
                                            <button class="btn btn-sm @(usuario.Activo ? "btn-outline-danger" : "btn-outline-success")"
                                                    title="@(usuario.Activo ? "Deshabilitar" : "Habilitar")"
                                                    @onclick="() => CambiarEstado(usuario)"
                                                    disabled="@(usuario.CorreoUsuario == usuarioActualCorreo)">
                                                <i class="bi @(usuario.Activo ? "bi-x-circle-fill" : "bi-check-circle-fill")"></i>
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            }

            <div class="modal fade @(modalDetalleVisible ? "show d-block" : "")" tabindex="-1" style="background-color: rgba(0,0,0,0.5);">
                <div class="modal-dialog modal-md modal-dialog-centered">
                    <div class="modal-content shadow-lg border-0">
                        <div class="modal-header bg-info text-white">
                            <h5 class="modal-title"><i class="bi bi-eye me-2"></i>Detalle de Usuario</h5>
                            <button type="button" class="btn-close" @onclick="CerrarModalDetalle"></button>
                        </div>
                        <div class="modal-body">
                            @if (detalleUsuario != null)
                            {
                                <ul class="list-group list-group-flush">
                                    <li class="list-group-item"><strong>Nombre:</strong> @detalleUsuario.NombreUsuario</li>
                                    <li class="list-group-item"><strong>Correo:</strong> @detalleUsuario.CorreoUsuario</li>
                                    <li class="list-group-item"><strong>Rol:</strong> <span class="text-capitalize">@detalleUsuario.Rol</span></li>
                                    <li class="list-group-item"><strong>Activo:</strong> @(detalleUsuario.Activo ? "Sí" : "No")</li>
                                    <li class="list-group-item"><strong>Temporal:</strong> @(detalleUsuario.EsContraseniaTemporal ? "Sí" : "No")</li>
                                    <li class="list-group-item"><strong>Fecha creación:</strong> @detalleUsuario.FechaCreacion.ToLocalTime()</li>
                                    <li class="list-group-item"><strong>Último acceso:</strong> @(detalleUsuario.UltimoAcceso?.ToLocalTime().ToString() ?? "-")</li>
                                </ul>
                            }
                        </div>
                        <div class="modal-footer">
                            <button class="btn btn-secondary" @onclick="CerrarModalDetalle">
                                <i class="bi bi-x-lg me-1"></i>Cerrar
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="modal fade @(modalVisible ? "show d-block" : "")" tabindex="-1" style="background-color: rgba(0,0,0,0.5);">
                <div class="modal-dialog modal-md modal-dialog-centered">
                    <div class="modal-content shadow-lg border-0">
                        <EditForm Model="@usuarioActual" OnValidSubmit="GuardarUsuario">
                            <div class="modal-header bg-primary text-white">
                                <h5 class="modal-title">
                                    <i class="bi bi-person-circle me-2"></i>@(usuarioActual.IdUsuario == 0 ? "Nuevo Usuario" : "Editar Usuario")
                                </h5>
                                <button type="button" class="btn-close" @onclick="CerrarModal"></button>
                            </div>
                            <div class="modal-body">
                                <DataAnnotationsValidator />
                                <ValidationSummary />
                                <div class="mb-2">
                                    <label class="form-label">Nombre</label>
                                    <InputText class="form-control" @bind-Value="usuarioActual.NombreUsuario" />
                                </div>
                                <div class="mb-2">
                                    <label class="form-label">Correo</label>
                                    <InputText class="form-control" @bind-Value="usuarioActual.CorreoUsuario" readonly="@(usuarioActual.IdUsuario != 0)" />
                                </div>
                                <div class="mb-2">
                                    <label class="form-label">Rol</label>
                                    <InputSelect class="form-select" @bind-Value="usuarioActual.Rol">
                                        <option value="">Seleccione</option>
                                        <option value="administrador">Administrador</option>
                                        <option value="recepcionista">Recepcionista</option>
                                        <option value="laboratorista">Laboratorista</option>
                                    </InputSelect>
                                </div>
                                @if (usuarioActual.IdUsuario != 0 && usuarioActual.EsContraseniaTemporal && usuarioActual.Activo)
                                {
                                    <div class="mt-3">
                                        <button type="button" class="btn btn-warning w-100" @onclick="() => ReenviarCredenciales(usuarioActual.IdUsuario)">
                                            <i class="bi bi-envelope-arrow-up me-1"></i> Reenviar contraseña temporal
                                        </button>
                                    </div>
                                }
                            </div>
                            <div class="modal-footer">
                                <button type="submit" class="btn btn-primary" disabled="@cargando">
                                    <i class="bi bi-save me-1"></i>Guardar
                                </button>
                                <button type="button" class="btn btn-secondary" @onclick="CerrarModal">
                                    <i class="bi bi-x-lg me-1"></i>Cancelar
                                </button>
                            </div>
                        </EditForm>
                    </div>
                </div>
            </div>
        }
    </Authorized>

    <NotAuthorized>
        <div class="d-flex justify-content-center align-items-center vh-100">
            <div class="card shadow-lg text-center border-0" style="max-width: 450px;">
                <div class="card-body p-4">
                    <i class="bi bi-person-x text-danger fs-1 mb-3"></i>
                    <h5 class="fw-bold mb-2">Debe iniciar sesión</h5>
                    <p class="text-muted mb-3">Para acceder a esta sección, por favor inicie sesión con una cuenta autorizada.</p>
                    <NavLink href="/login" class="btn btn-primary">
                        <i class="bi bi-box-arrow-in-right"></i> Ir al Login
                    </NavLink>
                </div>
            </div>
        </div>
    </NotAuthorized>
</AuthorizeView>

@code {
    List<UsuarioListadoDto> usuarios = new();
    UsuarioFiltroDto filtro = new();
    UsuarioEditarDto usuarioActual = new();
    UsuarioListadoDto? detalleUsuario;
    bool modalVisible, modalDetalleVisible, cargando, esNuevo, mostroBusqueda;
    string mensaje = "", tipoMensaje = "info";
    string campoFiltro = "", valorFiltro = "";
    string usuarioActualCorreo = "";

    private bool _sesionVerificada = false;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender && !_sesionVerificada)
        {
            _sesionVerificada = true;

            if (!await SesionService.VerificarOSalirAsync())
                return;

            var auth = await AuthProvider.GetAuthenticationStateAsync();
            usuarioActualCorreo = auth.User?.Identity?.Name ?? "";
            StateHasChanged();
        }
    }

    async Task VolverAtras() => await JS.InvokeVoidAsync("history.back");

    async Task Buscar()
    {
        if (!await SesionService.VerificarOSalirAsync()) return;

        mostroBusqueda = true;
        filtro = new();
        if (!string.IsNullOrWhiteSpace(campoFiltro) && !string.IsNullOrWhiteSpace(valorFiltro))
        {
            switch (campoFiltro)
            {
                case "nombre": filtro.Nombre = valorFiltro; break;
                case "correo": filtro.Correo = valorFiltro; break;
                case "rol": filtro.Rol = valorFiltro; break;
                case "activo": filtro.Activo = valorFiltro switch { "true" => true, "false" => false, _ => null }; break;
            }
        }
        usuarios = await UsuariosApi.GetUsuariosAsync(filtro);
    }

    void LimpiarFiltro()
    {
        campoFiltro = valorFiltro = "";
        mostroBusqueda = false;
        usuarios.Clear();
    }

    void AbrirModalNuevo()
    {
        usuarioActual = new() { Activo = true };
        esNuevo = true;
        modalVisible = true;
        JS.InvokeVoidAsync("marcarModalAbierto");
    }

    void AbrirModalEditar(UsuarioListadoDto user)
    {
        usuarioActual = new()
        {
            IdUsuario = user.IdUsuario,
            NombreUsuario = user.NombreUsuario,
            CorreoUsuario = user.CorreoUsuario,
            Rol = user.Rol,
            Activo = user.Activo,
            EsContraseniaTemporal = user.EsContraseniaTemporal
        };
        esNuevo = false;
        modalVisible = true;
        JS.InvokeVoidAsync("marcarModalAbierto");
    }

    void CerrarModal()
    {
        modalVisible = false;
        JS.InvokeVoidAsync("marcarModalCerrado");
    }

    async Task GuardarUsuario()
    {
        if (!await SesionService.VerificarOSalirAsync()) return;

        cargando = true;
        try
        {
            if (esNuevo)
            {
                var crearDto = new UsuarioCrearDto
                {
                    NombreUsuario = usuarioActual.NombreUsuario,
                    CorreoUsuario = usuarioActual.CorreoUsuario,
                    Rol = usuarioActual.Rol
                };
                await UsuariosApi.CrearUsuarioAsync(crearDto);
                mensaje = "Usuario creado correctamente y credenciales enviadas.";
            }
            else
            {
                await UsuariosApi.EditarUsuarioAsync(usuarioActual);
                mensaje = "Usuario actualizado correctamente.";
            }

            tipoMensaje = "success";
            modalVisible = false;
            await Buscar();
        }
        catch (Exception ex)
        {
            mensaje = $"Error: {ex.Message}";
            tipoMensaje = "danger";
        }
        finally
        {
            cargando = false;
            JS.InvokeVoidAsync("marcarModalCerrado");
        }
    }

    async Task CambiarEstado(UsuarioListadoDto usuario)
    {
        if (!await SesionService.VerificarOSalirAsync()) return;

        if (usuario.CorreoUsuario == usuarioActualCorreo)
        {
            mensaje = "No puedes deshabilitar tu propio usuario.";
            tipoMensaje = "warning";
            return;
        }

        bool confirmar = await JS.InvokeAsync<bool>("confirm", usuario.Activo ? "¿Deseas deshabilitar este usuario?" : "¿Deseas habilitar este usuario?");
        if (!confirmar) return;

        try
        {
            await UsuariosApi.CambiarEstadoAsync(usuario.IdUsuario, !usuario.Activo);
            mensaje = usuario.Activo ? "Usuario desactivado." : "Usuario activado.";
            tipoMensaje = "success";
            await Buscar();
        }
        catch (Exception ex)
        {
            mensaje = ex.Message;
            tipoMensaje = "danger";
        }
    }

    async Task ReenviarCredenciales(int idUsuario)
    {
        if (!await SesionService.VerificarOSalirAsync()) return;

        bool confirmar = await JS.InvokeAsync<bool>("confirm", "¿Deseas reenviar una nueva contraseña temporal?");
        if (!confirmar) return;

        await UsuariosApi.ReenviarCredencialesTemporalesAsync(idUsuario);
        mensaje = "Se envió una nueva contraseña temporal al correo.";
        tipoMensaje = "info";
        await Buscar();
    }

    async Task AbrirModalDetalle(int idUsuario)
    {
        if (!await SesionService.VerificarOSalirAsync()) return;

        detalleUsuario = await UsuariosApi.GetUsuarioPorIdAsync(idUsuario);
        modalDetalleVisible = true;
        JS.InvokeVoidAsync("marcarModalAbierto");
    }

    void CerrarModalDetalle()
    {
        modalDetalleVisible = false;
        JS.InvokeVoidAsync("marcarModalCerrado");
    }
}
