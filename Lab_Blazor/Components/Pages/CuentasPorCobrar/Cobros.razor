@page "/cobros/{cedula}"
@inject SesionVerificacionService SesionService

@rendermode InteractiveServer

@using Lab_Blazor.Services.Auth
@using Lab_Contracts.Ordenes
@using Lab_Contracts.Pagos
@using Lab_Blazor.Services.Pagos
@using Microsoft.AspNetCore.Components.Authorization
@using System.Security.Claims
@inject IPagosApiService PagosApi
@inject NavigationManager Navigation
@inject IJSRuntime JS
@inject AuthenticationStateProvider AuthProvider

<PageTitle>Cobros de Pacientes</PageTitle>

<AuthorizeView>
    <Authorized Context="authState">
        @{
            var user = authState.User;
            var rol = user.FindFirst(ClaimTypes.Role)?.Value
            ?? user.FindFirst("role")?.Value
            ?? user.FindFirst("roles")?.Value
            ?? "";

            bool puedeVer = rol is "administrador" or "recepcionista";
        }

        @if (!puedeVer)
        {
            <div class="d-flex justify-content-center align-items-center vh-100">
                <div class="card shadow-lg text-center border-0" style="max-width: 450px;">
                    <div class="card-body p-4">
                        <i class="bi bi-shield-lock text-primary fs-1 mb-3"></i>
                        <h5 class="fw-bold mb-2">Acceso no autorizado</h5>
                        <p class="text-muted mb-3">No tienes permisos suficientes para acceder a esta sección.</p>
                        <button class="btn btn-outline-primary" @onclick="VolverAtrasAsync">
                            <i class="bi bi-arrow-left"></i> Regresar
                        </button>
                    </div>
                </div>
            </div>
        }
        else
        {
            <h3 class="mb-4 d-flex align-items-center text-uppercase justify-content-between fw-bold flex-wrap">
                <i class="bi bi-cash-coin text-primary fs-4 me-2"></i>Cobros de Pacientes
            </h3>

            @if (!_datosCargados)
            {
                <div class="text-center py-5 text-primary">
                    <div class="spinner-border me-2"></div>
                    <span>Cargando órdenes del paciente...</span>
                </div>
            }
            else
            {
                <div class="row g-4">
                    <div class="col-lg-6">
                        <div class="card shadow-sm border-0">
                            <div class="card-body">
                                <h5 class="card-title mb-3 text-primary">
                                    <i class="bi bi-person-badge me-2"></i>Datos del Paciente
                                </h5>
                                <div class="mb-2">
                                    <label class="form-label">Cédula</label>
                                    <input class="form-control" value="@cedula" disabled />
                                </div>
                                <div class="mb-2">
                                    <label class="form-label">Nombre</label>
                                    <input class="form-control" value="@_nombrePaciente" disabled />
                                </div>

                                <h6 class="mt-4 text-secondary">Órdenes por Cobrar</h6>

                                <div class="alert alert-success py-2 small d-flex align-items-center" role="alert">
                                    <i class="bi bi-hand-index-thumb me-2 fs-5"></i>
                                    <span>Seleccione una orden para cobrar usando el botón verde <strong>✔️</strong>.</span>
                                </div>

                                @if (_ordenesPorCobrar.Count == 0)
                                {
                                    <div class="alert alert-light border">
                                        <i class="bi bi-info-circle me-2"></i>Sin órdenes pendientes.
                                    </div>
                                }
                                else
                                {
                                    <div class="table-responsive" style="max-height: 250px;">
                                        <table class="table table-sm table-hover table-bordered text-center align-middle">
                                            <thead class="table-light">
                                                <tr>
                                                    <th>Número</th>
                                                    <th>Fecha</th>
                                                    <th>Total</th>
                                                    <th>Saldo</th>
                                                    <th>Acción</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                @foreach (var orden in _ordenesPorCobrar)
                                                {
                                                    <tr>
                                                        <td>@orden.NumeroOrden</td>
                                                        <td>@orden.FechaOrden.ToString("dd/MM/yyyy")</td>
                                                        <td>@orden.Total.ToString("C")</td>
                                                        <td class="text-danger fw-bold">@orden.SaldoPendiente.ToString("C")</td>
                                                        <td>
                                                            <button class="btn btn-sm btn-success" title="Agregar a selección"
                                                                    @onclick="(() => SeleccionarOrdenAsync(orden))">
                                                                <i class="bi bi-check-lg"></i>
                                                            </button>
                                                        </td>
                                                    </tr>
                                                }
                                            </tbody>
                                        </table>
                                    </div>
                                }
                            </div>
                        </div>
                    </div>

                    <div class="col-lg-6">
                        <div class="card shadow-sm border-0">
                            <div class="card-body">
                                <h6 class="text-secondary mb-3">Órdenes Seleccionadas</h6>

                                <div class="alert alert-danger py-2 small d-flex align-items-center" role="alert">
                                    <i class="bi bi-hand-index-thumb me-2 fs-5"></i>
                                    <span>Quite una orden seleccionada usando el botón rojo <strong>❌</strong>.</span>
                                </div>

                                <div class="table-responsive" style="max-height: 200px;">
                                    <table class="table table-sm table-bordered table-hover text-center align-middle">
                                        <thead class="table-light">
                                            <tr>
                                                <th>Número</th>
                                                <th>Saldo</th>
                                                <th>Acción</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            @if (_ordenesSeleccionadas.Count == 0)
                                            {
                                                <tr>
                                                    <td colspan="3" class="text-muted">Ninguna orden seleccionada</td>
                                                </tr>
                                            }
                                            else
                                            {
                                                @foreach (var orden in _ordenesSeleccionadas)
                                                {
                                                    <tr>
                                                        <td>@orden.NumeroOrden</td>
                                                        <td>@orden.SaldoPendiente.ToString("C")</td>
                                                        <td>
                                                            <button class="btn btn-sm btn-danger" title="Quitar de selección"
                                                                    @onclick="(() => QuitarOrdenAsync(orden))">
                                                                <i class="bi bi-x-lg"></i>
                                                            </button>
                                                        </td>
                                                    </tr>
                                                }
                                            }
                                        </tbody>
                                    </table>
                                </div>

                                <h6 class="mt-4 text-secondary">Pagos Registrados</h6>

                                <div class="alert alert-info py-2 small d-flex align-items-center" role="alert">
                                    <i class="bi bi-info-circle-fill me-2 fs-5"></i>
                                    <span>Se muestran los pagos ya registrados para las órdenes seleccionadas.</span>
                                </div>

                                <div class="table-responsive" style="max-height: 200px;">
                                    <table class="table table-sm table-bordered align-middle text-center">
                                        <thead class="table-light">
                                            <tr>
                                                <th>Fecha</th>
                                                <th>Tipo</th>
                                                <th>Monto</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            @if (_pagosPrevios.Count == 0)
                                            {
                                                <tr>
                                                    <td colspan="3" class="text-muted">Sin pagos registrados</td>
                                                </tr>
                                            }
                                            else
                                            {
                                                @foreach (var pago in _pagosPrevios)
                                                {
                                                    <tr>
                                                        <td>@pago.FechaPago?.ToString("dd/MM/yyyy")</td>
                                                        <td>@pago.TipoPago</td>
                                                        <td>@pago.Monto.ToString("C")</td>
                                                    </tr>
                                                }
                                            }
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="row mt-4 g-3">
                    <div class="col-md-4">
                        <label class="form-label fw-bold">Total Deuda</label>
                        <input class="form-control" value="@_totalDeuda.ToString("C")" disabled />
                    </div>
                    <div class="col-md-4">
                        <label class="form-label fw-bold">Total Pagos</label>
                        <input class="form-control" value="@_totalPagos.ToString("C")" disabled />
                    </div>
                    <div class="col-md-4">
                        <label class="form-label fw-bold">Saldo Seleccionado</label>
                        <input class="form-control" value="@_totalSaldoSeleccionado.ToString("C")" disabled />
                    </div>
                </div>

                <div class="d-flex justify-content-end mt-4">
                    <button class="btn btn-success px-4" @onclick="MostrarModalCobroAsync" disabled="@(_ordenesSeleccionadas.Count == 0)">
                        <i class="bi bi-cash-stack me-1"></i> Registrar Cobro
                    </button>
                </div>
            }

            @if (_mostrarModalCobro)
            {
                <div class="modal fade show d-block" style="background-color: rgba(0,0,0,0.5); z-index:1050;">
                    <div class="modal-dialog modal-dialog-centered">
                        <div class="modal-content shadow-lg">
                            <div class="modal-header bg-primary text-white">
                                <h5 class="modal-title">
                                    <i class="bi bi-wallet2 me-2"></i>Registrar Cobro
                                </h5>
                                <button type="button" class="btn-close" @onclick="CerrarModalCobroAsync"></button>
                            </div>
                            <div class="modal-body">
                                <div class="mb-3">
                                    <label class="form-label">Dinero en Efectivo</label>
                                    <InputNumber class="form-control" @bind-Value="_dineroEfectivo" />
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Transferencia</label>
                                    <InputNumber class="form-control" @bind-Value="_transferencia" />
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Observación</label>
                                    <InputText class="form-control text-uppercase" @bind-Value="_observacion"
                                               @oninput="(e => _observacion = e.Value?.ToString()?.ToUpper() ?? string.Empty)" />
                                </div>
                                <hr />
                                <p><strong>Total Cobro:</strong> @TotalCobro.ToString("C")</p>
                                <p><strong>Saldo Seleccionado:</strong> @_totalSaldoSeleccionado.ToString("C")</p>
                                @if (TotalCobro > _totalSaldoSeleccionado)
                                {
                                    <p><strong>Cambio:</strong> <span class="text-warning fw-bold">@((TotalCobro - _totalSaldoSeleccionado).ToString("C"))</span></p>
                                }
                                else
                                {
                                    <p>
                                        <strong>Restante:</strong>
                                        <span class="@( (_totalSaldoSeleccionado - TotalCobro) > 0 ? "text-danger fw-bold" : "text-success fw-bold")">
                                            @((_totalSaldoSeleccionado - TotalCobro).ToString("C"))
                                        </span>
                                    </p>
                                }
                            </div>
                            <div class="modal-footer">
                                <button class="btn btn-primary" @onclick="RegistrarCobroAsync">
                                    <i class="bi bi-check-circle me-1"></i> Confirmar
                                </button>
                                <button class="btn btn-secondary" @onclick="CerrarModalCobroAsync">Cancelar</button>
                            </div>
                        </div>
                    </div>
                </div>
            }
        }
    </Authorized>

    <NotAuthorized>
        <div class="d-flex justify-content-center align-items-center vh-100">
            <div class="card shadow-lg text-center border-0" style="max-width: 450px;">
                <div class="card-body p-4">
                    <i class="bi bi-person-x text-danger fs-1 mb-3"></i>
                    <h5 class="fw-bold mb-2">Debe iniciar sesión</h5>
                    <p class="text-muted mb-3">Inicie sesión con una cuenta autorizada para continuar.</p>
                    <NavLink href="/login" class="btn btn-primary">
                        <i class="bi bi-box-arrow-in-right"></i> Ir al Login
                    </NavLink>
                </div>
            </div>
        </div>
    </NotAuthorized>
</AuthorizeView>

@code {
    [Parameter] public string cedula { get; set; } = string.Empty;
    private string _nombrePaciente = string.Empty;
    private List<OrdenDto> _ordenesPorCobrar = new();
    private List<OrdenDto> _ordenesSeleccionadas = new();
    private List<DetallePagoDto> _pagosPrevios = new();
    private decimal _totalDeuda, _totalPagos, _totalSaldoSeleccionado, _dineroEfectivo, _transferencia;
    private string _observacion = string.Empty;
    private bool _mostrarModalCobro;
    private bool _datosCargados;
    private bool _sesionVerificada = false;

    private decimal TotalCobro => _dineroEfectivo + _transferencia;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender && !_datosCargados && !_sesionVerificada)
        {
            var authState = await AuthProvider.GetAuthenticationStateAsync();
            var user = authState.User;

            if (!user.Identity?.IsAuthenticated ?? true)
            {
                _datosCargados = true;
                StateHasChanged();
                return;
            }

            var rol = user.FindFirst(ClaimTypes.Role)?.Value ?? "";
            bool puedeVer = rol is "administrador" or "recepcionista";

            if (puedeVer)
                await CargarOrdenesAsync();

            _datosCargados = true;
            StateHasChanged();
        }
    }

    private async Task CargarOrdenesAsync()
    {
        if (!await SesionService.VerificarOSalirAsync()) return;
        var filtro = new PagoFiltroDto { Cedula = cedula, IncluirAnulados = false };
        var ordenes = await PagosApi.ListarCuentasPorCobrarAsync(filtro);
        _ordenesPorCobrar = ordenes.Where(o => o.SaldoPendiente > 0 && (o.Anulado == null || o.Anulado == false)).ToList();
        if (_ordenesPorCobrar.Any()) _nombrePaciente = _ordenesPorCobrar.First().NombrePaciente ?? "";
        _totalDeuda = _ordenesPorCobrar.Sum(o => o.SaldoPendiente);
    }

    private async Task CargarPagosAsync()
    {
        if (!await SesionService.VerificarOSalirAsync()) return;
        _pagosPrevios.Clear();
        foreach (var orden in _ordenesSeleccionadas)
        {
            var pagos = await PagosApi.ListarPagosAsync(orden.IdOrden);
            foreach (var pago in pagos)
                if (pago.DetallePagos != null)
                    _pagosPrevios.AddRange(pago.DetallePagos.Select(d => new DetallePagoDto
                    {
                        IdDetallePago = d.IdDetallePago,
                        IdPago = pago.IdPago,
                        TipoPago = d.TipoPago,
                        Monto = d.Monto,
                        FechaPago = pago.FechaPago
                    }));
        }
        _totalPagos = _pagosPrevios.Sum(p => p.Monto);
    }

    private async Task SeleccionarOrdenAsync(OrdenDto orden)
    {
        if (!await SesionService.VerificarOSalirAsync()) return;

        if (!_ordenesSeleccionadas.Any(o => o.IdOrden == orden.IdOrden))
        {
            _ordenesSeleccionadas.Add(orden);
            _ordenesPorCobrar.Remove(orden);
            await CargarPagosAsync();
            CalcularSaldoSeleccionado();
            StateHasChanged();
        }
    }

    private async Task QuitarOrdenAsync(OrdenDto orden)
    {
        if (!await SesionService.VerificarOSalirAsync()) return;

        _ordenesPorCobrar.Add(orden);
        _ordenesSeleccionadas.Remove(orden);
        await CargarPagosAsync();
        CalcularSaldoSeleccionado();
        StateHasChanged();
    }

    private void CalcularSaldoSeleccionado() => _totalSaldoSeleccionado = _ordenesSeleccionadas.Sum(o => o.SaldoPendiente);

    private async Task MostrarModalCobroAsync()
    {
        if (!await SesionService.VerificarOSalirAsync()) return;

        _mostrarModalCobro = true;
        await JS.InvokeVoidAsync("marcarModalAbierto");
    }

    private async Task CerrarModalCobroAsync()
    {
        if (!await SesionService.VerificarOSalirAsync()) return;

        _mostrarModalCobro = false;
        await JS.InvokeVoidAsync("marcarModalCerrado");
    }

    private async Task RegistrarCobroAsync()
    {
        if (!await SesionService.VerificarOSalirAsync()) return;

        decimal saldoTotal = _totalSaldoSeleccionado;
        decimal cobroTotal = TotalCobro;
        decimal cambio = 0;

        if (cobroTotal > saldoTotal)
        {
            cambio = cobroTotal - saldoTotal;
            cobroTotal = saldoTotal;
        }

        var pagoDto = new PagoDto
        {
            DineroEfectivo = _dineroEfectivo,
            Transferencia = _transferencia,
            Observacion = _observacion
        };

        bool errores = false;

        foreach (var orden in _ordenesSeleccionadas)
        {
            if (!await SesionService.VerificarOSalirAsync()) return;

            pagoDto.IdOrden = orden.IdOrden;
            var response = await PagosApi.GuardarCobroCuentaPorCobrarAsync(pagoDto);
            if (response == null)
                errores = true;
            if (cobroTotal <= 0)
                break;
        }

        if (errores)
            await JS.InvokeVoidAsync("alert", "Algunos pagos no se registraron correctamente.");
        else if (cambio > 0)
            await JS.InvokeVoidAsync("alert", $"Pago registrado correctamente. Cambio: {cambio.ToString("C")}");
        else
            await JS.InvokeVoidAsync("alert", "Pago registrado exitosamente.");

        Navigation.NavigateTo(Navigation.Uri, true);
    }

    private async Task VolverAtrasAsync() => await JS.InvokeVoidAsync("history.back");
}
