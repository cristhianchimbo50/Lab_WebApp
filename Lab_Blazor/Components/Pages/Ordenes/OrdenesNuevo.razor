@page "/ordenes/nuevo"
@rendermode InteractiveServer

@using Lab_Blazor.Services.Examenes
@using Lab_Blazor.Services.Medicos
@using Lab_Blazor.Services.Ordenes
@using Lab_Blazor.Services.Pacientes
@using Lab_Blazor.Services.Pagos
@using Lab_Contracts.Ordenes
@using Lab_Contracts.Pacientes
@using Lab_Contracts.Medicos
@using Lab_Contracts.Examenes
@using Lab_Contracts.Pagos
@using Microsoft.AspNetCore.Components.Authorization
@using System.Security.Claims
@using System.Linq

@inject IOrdenesApiService OrdenApi
@inject NavigationManager Navigation
@inject IPacientesApiService PacientesApi
@inject IMedicosApiService MedicosApi
@inject IExamenesApiService ExamenesApi
@inject IPagosApiService PagosApi
@inject IJSRuntime JS
@inject AuthenticationStateProvider AuthProvider

<PageTitle>Registrar Orden</PageTitle>

<AuthorizeView>
    <Authorized Context="authState">
        @{
            var user = authState.User;
            var rol = user.FindFirst(ClaimTypes.Role)?.Value
            ?? user.FindFirst("role")?.Value
            ?? user.FindFirst("roles")?.Value
            ?? "";
            bool puedeVer = rol is "administrador" or "recepcionista";
        }

        @if (!puedeVer)
        {
            <div class="d-flex justify-content-center align-items-center vh-100">
                <div class="card shadow-lg text-center border-0" style="max-width: 450px;">
                    <div class="card-body p-4">
                        <i class="bi bi-shield-lock text-primary fs-1 mb-3"></i>
                        <h5 class="fw-bold mb-2">Acceso no autorizado</h5>
                        <p class="text-muted mb-3">No tienes permisos para registrar órdenes.</p>
                        <button class="btn btn-outline-primary" @onclick="VolverAtras">
                            <i class="bi bi-arrow-left"></i> Regresar
                        </button>
                    </div>
                </div>
            </div>
        }
        else
        {
            <h4 class="mb-4 d-flex align-items-center">
                <i class="bi bi-file-earmark-medical text-primary fs-4 me-2"></i> Registrar Nueva Orden
            </h4>

            @if (!cargado)
            {
                <div class="d-flex align-items-center text-primary">
                    <div class="spinner-border me-2" role="status"></div>
                    <strong>Cargando...</strong>
                </div>
            }
            else
            {
                <EditForm Model="orden" OnValidSubmit="MostrarPagoModal">
                    <div class="card shadow-sm mb-4">
                        <div class="card-body row g-3">
                            <div class="col-md-4">
                                <label class="form-label fw-semibold">Fecha de la Orden</label>
                                <InputDate class="form-control" @bind-Value="FechaOrdenSeleccionada" />
                            </div>
                            <div class="col-md-6">
                                <label class="form-label fw-semibold">Cédula del Paciente</label>
                                <div class="input-group">
                                    <InputText class="form-control" @bind-Value="Cedula" placeholder="Ingrese cédula" />
                                    <button class="btn btn-outline-primary" @onclick="BuscarPorCedula">
                                        <i class="bi bi-search"></i>
                                    </button>
                                </div>
                            </div>
                        </div>

                        @if (PacienteActual is not null)
                        {
                            <hr />
                            <div class="row g-3 mt-2">
                                <div class="col-md-3"><label>Nombre</label><input class="form-control" value="@PacienteActual.NombrePaciente" disabled /></div>
                                <div class="col-md-2"><label>Edad</label><input class="form-control" value="@PacienteActual.EdadPaciente" disabled /></div>
                                <div class="col-md-4"><label>Dirección</label><input class="form-control" value="@PacienteActual.DireccionPaciente" disabled /></div>
                                <div class="col-md-3"><label>Teléfono</label><input class="form-control" value="@PacienteActual.TelefonoPaciente" disabled /></div>
                                <div class="col-md-6"><label>Correo</label><input class="form-control" value="@PacienteActual.CorreoElectronicoPaciente" disabled /></div>
                            </div>
                        }
                    </div>

                    <div class="card shadow-sm mb-4">
                        <div class="card-body">
                            <label class="form-label fw-semibold">Médico</label>
                            <div class="input-group">
                                <select class="form-select" @bind="MedicoIdSeleccionado">
                                    <option value="">-- Seleccione un médico --</option>
                                    @foreach (var medico in Medicos)
                                    {
                                        <option value="@medico.IdMedico">@medico.NombreMedico</option>
                                    }
                                </select>
                                <button class="btn btn-secondary" type="button" @onclick="AbrirModalNuevoMedico">
                                    <i class="bi bi-person-plus"></i> Nuevo
                                </button>
                            </div>
                        </div>
                    </div>

                    <div class="mb-3">
                        <button class="btn btn-success" type="button" @onclick="() => MostrarModalExamen = true">
                            <i class="bi bi-plus-circle me-1"></i> Agregar Examen
                        </button>
                    </div>

                    @if (ExamenesSeleccionados.Any())
                    {
                        <div class="card shadow-sm mb-4">
                            <div class="card-body table-responsive">
                                <table class="table table-striped table-bordered table-sm align-middle text-center">
                                    <thead class="table-light">
                                        <tr><th>Nombre</th><th>Estudio</th><th>Precio</th><th>Acción</th></tr>
                                    </thead>
                                    <tbody>
                                        @foreach (var ex in ExamenesSeleccionados)
                                        {
                                            <tr>
                                                <td>@ex.NombreExamen</td>
                                                <td>@ex.Estudio</td>
                                                <td>@ex.Precio.ToString("C")</td>
                                                <td><button class="btn btn-sm btn-danger" @onclick="() => QuitarExamen(ex)"><i class="bi bi-trash"></i></button></td>
                                            </tr>
                                        }
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    }

                    <div class="text-end mb-4">
                        <button class="btn btn-primary px-4" type="submit">
                            <i class="bi bi-save me-1"></i> Guardar Orden
                        </button>
                    </div>
                </EditForm>
            }
        }
    </Authorized>

    <NotAuthorized>
        <div class="d-flex justify-content-center align-items-center vh-100">
            <div class="card shadow-lg text-center border-0" style="max-width: 450px;">
                <div class="card-body p-4">
                    <i class="bi bi-person-x text-danger fs-1 mb-3"></i>
                    <h5 class="fw-bold mb-2">Debe iniciar sesión</h5>
                    <p class="text-muted mb-3">Para acceder, inicie sesión con una cuenta autorizada.</p>
                    <NavLink href="/login" class="btn btn-primary">
                        <i class="bi bi-box-arrow-in-right"></i> Ir al Login
                    </NavLink>
                </div>
            </div>
        </div>
    </NotAuthorized>
</AuthorizeView>

@code {
    private bool cargado;
    private string Cedula = "";
    private PacienteDto? PacienteActual;
    private List<MedicoDto> Medicos = new();
    private MedicoDto? MedicoActual;
    private MedicoDto NuevoMedico = new();
    private bool MostrarModalMedico;
    private bool MostrarModalExamen;
    private bool MostrarModalPago;
    private string TextoBuscarExamen = "";
    private List<ExamenDto> ExamenesDisponibles = new();
    private List<ExamenDto> ExamenesSeleccionados = new();
    private DateOnly FechaOrdenSeleccionada = DateOnly.FromDateTime(DateTime.Now);
    private OrdenDto orden = new();
    private PagoDto PagoActual = new();
    private decimal Efectivo;
    private decimal Transferencia;

    private int? MedicoIdSeleccionado
    {
        get => MedicoActual?.IdMedico;
        set => MedicoActual = Medicos.FirstOrDefault(m => m.IdMedico == value);
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender && !cargado)
        {
            Medicos = await MedicosApi.ListarMedicosAsync();
            cargado = true;
            StateHasChanged();
        }
    }

    private async Task BuscarPorCedula()
    {
        if (string.IsNullOrWhiteSpace(Cedula)) return;
        var paciente = await PacientesApi.ObtenerPacientePorCedulaAsync(Cedula);
        if (paciente != null)
            PacienteActual = paciente;
        else
        {
            PacienteActual = null;
            await JS.InvokeVoidAsync("alert", "No se encontró paciente con esa cédula.");
        }
    }

    private async Task AbrirModalNuevoMedico()
    {
        NuevoMedico = new MedicoDto();
        MostrarModalMedico = true;
        await JS.InvokeVoidAsync("marcarModalAbierto");
    }

    private async Task GuardarNuevoMedico()
    {
        var res = await MedicosApi.CrearMedicoAsync(NuevoMedico);
        if (res.IsSuccessStatusCode)
        {
            Medicos = await MedicosApi.ListarMedicosAsync();
            MedicoActual = Medicos.FirstOrDefault(m => m.NombreMedico == NuevoMedico.NombreMedico);
            MostrarModalMedico = false;
            await JS.InvokeVoidAsync("marcarModalCerrado");
        }
        else
        {
            var msg = await res.Content.ReadAsStringAsync();
            await JS.InvokeVoidAsync("alert", $"Error al crear médico: {msg}");
        }
    }

    private async Task BuscarExamenes() => ExamenesDisponibles = await ExamenesApi.ListarExamenesAsync(TextoBuscarExamen);

    private void SeleccionarExamen(ExamenDto examen)
    {
        if (!ExamenesSeleccionados.Any(e => e.IdExamen == examen.IdExamen))
            ExamenesSeleccionados.Add(examen);
        MostrarModalExamen = false;
    }

    private void QuitarExamen(ExamenDto examen) => ExamenesSeleccionados.Remove(examen);

    private void MostrarPagoModal()
    {
        if (PacienteActual == null || MedicoActual == null || !ExamenesSeleccionados.Any())
        {
            JS.InvokeVoidAsync("alert", "Debe seleccionar paciente, médico y al menos un examen.");
            return;
        }
        Efectivo = 0;
        Transferencia = 0;
        PagoActual = new PagoDto();
        MostrarModalPago = true;
    }

    private decimal CalcularTotal() => ExamenesSeleccionados.Sum(e => e.Precio);
    private decimal ObtenerSaldoPendiente() => Math.Max(0, CalcularTotal() - (Efectivo + Transferencia));

    private async Task GuardarPago()
    {
        var pagado = Efectivo + Transferencia;
        var saldo = ObtenerSaldoPendiente();

        orden.IdPaciente = PacienteActual!.IdPaciente;
        orden.IdMedico = MedicoActual!.IdMedico;
        orden.FechaOrden = FechaOrdenSeleccionada;
        orden.Total = CalcularTotal();
        orden.SaldoPendiente = saldo;
        orden.TotalPagado = pagado;
        orden.EstadoPago = saldo == 0 ? "PAGADO" : "PENDIENTE";
        orden.Anulado = false;
        orden.LiquidadoConvenio = false;
        orden.NumeroOrden = "";
        orden.Observacion = "";
        orden.Detalles = ExamenesSeleccionados.Select(e => new DetalleOrdenDto { IdExamen = e.IdExamen, Precio = e.Precio }).ToList();

        var dto = new OrdenCompletaDto { Orden = orden, IdsExamenes = ExamenesSeleccionados.Select(e => e.IdExamen).ToList() };
        var response = await OrdenApi.CrearOrdenHttpResponseAsync(dto);

        if (response.IsSuccessStatusCode)
        {
            var resp = await response.Content.ReadFromJsonAsync<OrdenRespuestaDto>();
            if (resp != null && resp.IdOrden > 0)
            {
                var observacion = string.IsNullOrWhiteSpace(PagoActual.Observacion) ? "PAGO DESDE ORDEN" : PagoActual.Observacion;
                var pago = new PagoDto
                {
                    IdOrden = resp.IdOrden,
                    FechaPago = DateTime.Now,
                    MontoPagado = pagado,
                    Observacion = observacion,
                    DetallePagos = new List<DetallePagoDto>
                    {
                        new() { TipoPago = "EFECTIVO", Monto = Efectivo },
                        new() { TipoPago = "TRANSFERENCIA", Monto = Transferencia }
                    }
                };
                await PagosApi.RegistrarPagoAsync(pago);
                Navigation.NavigateTo("/ordenes");
            }
            else await JS.InvokeVoidAsync("alert", "No se pudo registrar la orden.");
        }
        else
        {
            var msg = await response.Content.ReadAsStringAsync();
            await JS.InvokeVoidAsync("alert", $"Error al registrar la orden: {msg}");
        }
    }

    private async Task VolverAtras() => await JS.InvokeVoidAsync("history.back");
}
