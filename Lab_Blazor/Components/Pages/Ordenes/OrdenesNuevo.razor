@page "/nueva-orden"
@rendermode InteractiveServer

@using Lab_Blazor.Services.Examenes
@using Lab_Blazor.Services.Medicos
@using Lab_Blazor.Services.Ordenes
@using Lab_Blazor.Services.Pacientes
@using Lab_Blazor.Services.Pagos
@using Lab_Contracts.Ordenes
@using Lab_Contracts.Pacientes
@using Lab_Contracts.Medicos
@using Lab_Contracts.Examenes
@using Lab_Contracts.Pagos
@using Microsoft.AspNetCore.Components.Authorization
@using System.Security.Claims
@using System.Linq
@using Lab_Blazor.Services.Auth
@inject SesionVerificacionService SesionService
@inject IOrdenesApiService OrdenesApi
@inject NavigationManager Navigation
@inject IPacientesApiService PacientesApi
@inject IMedicosApiService MedicosApi
@inject IExamenesApiService ExamenesApi
@inject IPagosApiService PagosApi
@inject IJSRuntime JS
@inject AuthenticationStateProvider AuthProvider

<PageTitle>Registrar Orden</PageTitle>

<AuthorizeView>
    <Authorized Context="EstadoAutenticacion">
        @{
            var Usuario = EstadoAutenticacion.User;
            var Rol = Usuario.FindFirst(ClaimTypes.Role)?.Value
            ?? Usuario.FindFirst("role")?.Value
            ?? Usuario.FindFirst("roles")?.Value
            ?? "";
            bool PuedeVer = Rol is "administrador" or "recepcionista";
        }

        @if (!PuedeVer)
        {
            <div class="d-flex justify-content-center align-items-center vh-100">
                <div class="card shadow-lg text-center border-0" style="max-width: 450px;">
                    <div class="card-body p-4">
                        <i class="bi bi-shield-lock text-primary fs-1 mb-3"></i>
                        <h5 class="fw-bold mb-2">Acceso no autorizado</h5>
                        <p class="text-muted mb-3">No tienes permisos para registrar órdenes.</p>
                        <button class="btn btn-outline-primary" @onclick="VolverAtras">
                            <i class="bi bi-arrow-left"></i> Regresar
                        </button>
                    </div>
                </div>
            </div>
        }
        else
        {
            <h3 class="mb-4 d-flex align-items-center text-uppercase fw-bold flex-wrap">
                <i class="bi bi-file-earmark-medical text-primary fs-4 me-2"></i> Registrar Nueva Orden
            </h3>

            @if (!ContenidoCargado)
            {
                <div class="d-flex align-items-center text-primary">
                    <div class="spinner-border me-2" role="status"></div>
                </div>
            }
            else
            {
                <EditForm Model="OrdenActual" OnValidSubmit="AbrirModalPago">
                    <div class="card shadow-sm mb-4">
                        <div class="card-body row g-3">
                            <div class="col-md-4">
                                <label class="form-label fw-semibold">Fecha de la Orden</label>
                                <InputDate class="form-control" @bind-Value="FechaOrden" TValue="DateOnly" disabled />
                            </div>

                            <div class="col-md-6">
                                <label class="form-label fw-semibold">Cédula del Paciente</label>
                                <div class="input-group">
                                    <InputText class="form-control" @bind-Value="CedulaPaciente" placeholder="Ingrese cédula" />
                                    <button type="button" class="btn btn-outline-primary" @onclick="BuscarPorCedula">
                                        <i class="bi bi-search"></i>
                                    </button>

                                </div>
                            </div>
                        </div>

                        @if (PacienteSeleccionado is not null)
                        {
                            <div class="card border-0 shadow-sm mt-3">
                                <div class="card-header bg-light fw-semibold">
                                    <i class="bi bi-person-badge text-primary me-2"></i> Datos del Paciente
                                </div>
                                <div class="card-body">
                                    <div class="row g-3">
                                        <div class="col-md-4">
                                            <label class="form-label fw-semibold">Nombre</label>
                                            <input class="form-control" value="@PacienteSeleccionado.NombrePaciente" disabled />
                                        </div>
                                        <div class="col-md-3">
                                            <label class="form-label fw-semibold">Cédula</label>
                                            <input class="form-control" value="@PacienteSeleccionado.CedulaPaciente" disabled />
                                        </div>
                                        <div class="col-md-5">
                                            <label class="form-label fw-semibold">Correo Electrónico</label>
                                            <input class="form-control" value="@PacienteSeleccionado.CorreoElectronicoPaciente" disabled />
                                        </div>
                                        <div class="col-md-4">
                                            <label class="form-label fw-semibold">Teléfono</label>
                                            <input class="form-control" value="@PacienteSeleccionado.TelefonoPaciente" disabled />
                                        </div>
                                        <div class="col-md-8">
                                            <label class="form-label fw-semibold">Dirección</label>
                                            <input class="form-control" value="@PacienteSeleccionado.DireccionPaciente" disabled />
                                        </div>
                                    </div>
                                </div>
                            </div>
                        }
                    </div>

                    <div class="card shadow-sm mb-4">
                        <div class="card-body">
                            <label class="form-label fw-semibold">Médico</label>
                            <div class="input-group">
                                <select class="form-select" @bind="MedicoIdSeleccionado">
                                    <option value="">-- Seleccione un médico --</option>
                                    @foreach (var Medico in ListaMedicos)
                                    {
                                        <option value="@Medico.IdMedico">@Medico.NombreMedico</option>
                                    }
                                </select>
                                <button class="btn btn-secondary" type="button" @onclick="AbrirModalNuevoMedico">
                                    <i class="bi bi-person-plus"></i> Nuevo
                                </button>
                            </div>
                        </div>
                    </div>

                    <div class="mb-3">
                        <button class="btn btn-success" type="button" @onclick="() => MostrarModalExamen = true">
                            <i class="bi bi-plus-circle me-1"></i> Agregar Examen
                        </button>
                    </div>


                    <div class="text-end mb-4">
                        <button class="btn btn-primary px-4" type="submit">
                            <i class="bi bi-save me-1"></i> Guardar Orden
                        </button>
                    </div>
                </EditForm>

                @if (MostrarModalRegistrarPaciente)
                {
                    <div class="modal show d-block" style="background-color: rgba(0,0,0,0.5);">
                        <div class="modal-dialog modal-lg modal-dialog-centered">
                            <div class="modal-content shadow-lg border-0">
                                <EditForm Model="@PacienteNuevo" OnValidSubmit="RegistrarNuevoPaciente">
                                    <div class="modal-header bg-primary text-white">
                                        <h5 class="modal-title"><i class="bi bi-person-plus me-2"></i>Registrar Paciente</h5>
                                        <button type="button" class="btn-close btn-close-white" @onclick="CerrarModalRegistrarPaciente"></button>
                                    </div>
                                    <div class="modal-body">
                                        <DataAnnotationsValidator />
                                        <ValidationSummary />
                                        <div class="row g-3">
                                            <div class="col-md-6">
                                                <label class="form-label">Cédula</label>
                                                <InputText class="form-control" @bind-Value="PacienteNuevo.CedulaPaciente" readonly />
                                            </div>
                                            <div class="col-md-6">
                                                <label class="form-label">Nombre</label>
                                                <InputText class="form-control text-uppercase"
                                                           @bind-Value="PacienteNuevo.NombrePaciente"
                                                           @oninput="(e => PacienteNuevo.NombrePaciente = e.Value?.ToString()?.ToUpper() ?? string.Empty)" />
                                            </div>

                                            <div class="col-md-6">
                                                <label class="form-label">Fecha Nacimiento</label>
                                                <InputDate class="form-control" @bind-Value="PacienteNuevo.FechaNacPaciente" TValue="DateTime" />
                                            </div>
                                            <div class="col-md-6">
                                                <label class="form-label">Correo</label>
                                                <InputText class="form-control" @bind-Value="PacienteNuevo.CorreoElectronicoPaciente" />
                                            </div>
                                            <div class="col-md-6">
                                                <label class="form-label">Teléfono</label>
                                                <InputText class="form-control" @bind-Value="PacienteNuevo.TelefonoPaciente" />
                                            </div>
                                            <div class="col-md-6">
                                                <label class="form-label">Dirección</label>
                                                <InputText class="form-control text-uppercase"
                                                           @bind-Value="PacienteNuevo.DireccionPaciente"
                                                           @oninput="(e => PacienteNuevo.DireccionPaciente = e.Value?.ToString()?.ToUpper() ?? string.Empty)" />
                                            </div>

                                        </div>
                                    </div>
                                    <div class="modal-footer">
                                        <button class="btn btn-primary px-3" type="submit">
                                            <i class="bi bi-save me-1"></i>Guardar
                                        </button>
                                        <button class="btn btn-secondary" type="button" @onclick="CerrarModalRegistrarPaciente">
                                            <i class="bi bi-x-lg me-1"></i>Cancelar
                                        </button>
                                    </div>
                                </EditForm>
                            </div>
                        </div>
                    </div>
                }

                @if (MostrarModalBuscarPaciente)
                {
                    <div class="modal show d-block" style="background-color: rgba(0,0,0,0.5);">
                        <div class="modal-dialog modal-lg modal-dialog-centered">
                            <div class="modal-content shadow-lg border-0">
                                <div class="modal-header bg-primary text-white">
                                    <h5 class="modal-title"><i class="bi bi-search me-2"></i>Buscar Paciente</h5>
                                    <button type="button" class="btn-close btn-close-white" @onclick="CerrarModalBuscarPaciente"></button>
                                </div>
                                <div class="modal-body">
                                    <div class="row g-2 mb-3">
                                        <div class="col-md-4">
                                            <InputSelect class="form-select" @bind-Value="FiltroBusquedaPaciente">
                                                <option value="nombre">Nombre</option>
                                                <option value="cedula">Cédula</option>
                                            </InputSelect>
                                        </div>
                                        <div class="col-md-6">
                                            <InputText class="form-control" @bind-Value="ValorBusquedaPaciente" placeholder="Ingrese valor a buscar" />
                                        </div>
                                        <div class="col-md-2 d-grid">
                                            <button class="btn btn-primary" @onclick="BuscarPacientesModal"><i class="bi bi-search"></i></button>
                                        </div>
                                    </div>

                                    <div style="max-height: 300px; overflow-y: auto;" class="border rounded">
                                        <table class="table table-sm table-hover align-middle mb-0">
                                            <thead class="table-light">
                                                <tr><th>Cédula</th><th>Nombre</th><th>Correo</th><th></th></tr>
                                            </thead>
                                            <tbody>
                                                @if (PacientesEncontrados.Any())
                                                {
                                                    @foreach (var Paciente in PacientesEncontrados)
                                                    {
                                                        <tr>
                                                            <td>@Paciente.CedulaPaciente</td>
                                                            <td>@Paciente.NombrePaciente</td>
                                                            <td>@Paciente.CorreoElectronicoPaciente</td>
                                                            <td>
                                                                <button class="btn btn-success btn-sm" @onclick="() => SeleccionarPaciente(Paciente)">
                                                                    <i class="bi bi-check-lg"></i>
                                                                </button>
                                                            </td>
                                                        </tr>
                                                    }
                                                }
                                                else
                                                {
                                                    <tr><td colspan="4" class="text-center text-muted">Sin resultados</td></tr>
                                                }
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                                <div class="modal-footer">
                                    <button class="btn btn-secondary" @onclick="CerrarModalBuscarPaciente">Cerrar</button>
                                </div>
                            </div>
                        </div>
                    </div>
                }

                @if (MostrarModalMedico)
                {
                    <div class="modal show d-block" style="background-color: rgba(0,0,0,0.5);">
                        <div class="modal-dialog modal-md modal-dialog-centered">
                            <div class="modal-content shadow-lg border-0">
                                <EditForm Model="@MedicoNuevo" OnValidSubmit="GuardarNuevoMedico">
                                    <div class="modal-header bg-primary text-white">
                                        <h5 class="modal-title"><i class="bi bi-person-plus me-2"></i>Registrar Médico</h5>
                                        <button type="button" class="btn-close btn-close-white" @onclick="CerrarModalMedico"></button>
                                    </div>
                                    <div class="modal-body">
                                        <DataAnnotationsValidator />
                                        <ValidationSummary />
                                        <div class="mb-3">
                                            <label class="form-label">Nombre</label>
                                            <InputText class="form-control text-uppercase"
                                                       @bind-Value="MedicoNuevo.NombreMedico"
                                                       @oninput="(e => MedicoNuevo.NombreMedico = e.Value?.ToString()?.ToUpper() ?? string.Empty)" />
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label">Especialidad</label>
                                            <InputText class="form-control text-uppercase"
                                                       @bind-Value="MedicoNuevo.Especialidad"
                                                       @oninput="(e => MedicoNuevo.Especialidad = e.Value?.ToString()?.ToUpper() ?? string.Empty)" />
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label">Teléfono</label>
                                            <InputText class="form-control" @bind-Value="MedicoNuevo.Telefono" />
                                        </div>
                                    </div>
                                    <div class="modal-footer">
                                        <button class="btn btn-primary px-3" type="submit">
                                            <i class="bi bi-save me-1"></i>Guardar
                                        </button>
                                        <button class="btn btn-secondary" type="button" @onclick="CerrarModalMedico">
                                            <i class="bi bi-x-lg me-1"></i>Cancelar
                                        </button>
                                    </div>
                                </EditForm>
                            </div>
                        </div>
                    </div>
                }

                @if (MostrarModalExamen)
                {
                    <div class="modal show d-block" style="background-color: rgba(0,0,0,0.5);">
                        <div class="modal-dialog modal-xl modal-dialog-centered">
                            <div class="modal-content shadow-lg border-0">
                                <div class="modal-header bg-primary text-white">
                                    <h5 class="modal-title"><i class="bi bi-flask me-2"></i>Seleccionar Examen</h5>
                                    <button type="button" class="btn-close btn-close-white" @onclick="CerrarModalExamen"></button>
                                </div>

                                <div class="modal-body">
                                    <div class="row g-2 mb-3">
                                        <div class="col-md-10">
                                            <InputText class="form-control" @bind-Value="TextoBuscarExamen" placeholder="Buscar examen por nombre o estudio..." />
                                        </div>
                                        <div class="col-md-2 d-grid">
                                            <button class="btn btn-primary" @onclick="BuscarExamenes"><i class="bi bi-search"></i></button>
                                        </div>
                                    </div>

                                    <div style="max-height: 400px; overflow-y: auto;" class="border rounded">
                                        <table class="table table-sm table-hover align-middle mb-0">
                                            <thead class="table-light text-center">
                                                <tr>
                                                    <th>Nombre</th>
                                                    <th>Estudio</th>
                                                    <th>Precio</th>
                                                    <th>Acción</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                @if (ExamenesDisponibles.Any())
                                                {
                                                    @foreach (var Examen in ExamenesDisponibles)
                                                    {
                                                        <tr class="text-center">
                                                            <td>@Examen.NombreExamen</td>
                                                            <td>@Examen.Estudio</td>
                                                            <td>@Examen.Precio.ToString("C")</td>
                                                            <td>
                                                                <button class="btn btn-success btn-sm" @onclick="() => SeleccionarExamen(Examen)">
                                                                    <i class="bi bi-check-lg"></i>
                                                                </button>
                                                            </td>
                                                        </tr>
                                                    }
                                                }
                                                else
                                                {
                                                    <tr>
                                                        <td colspan="4" class="text-center text-muted">No hay resultados</td>
                                                    </tr>
                                                }
                                            </tbody>
                                        </table>
                                    </div>
                                </div>

                                <div class="modal-footer">
                                    <button class="btn btn-secondary" type="button" @onclick="CerrarModalExamen">
                                        <i class="bi bi-x-lg me-1"></i> Cerrar
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                }

                @if (!ExamenesSeleccionados.Any())
                {
                    <div class="alert alert-warning text-center mt-3">
                        <i class="bi bi-exclamation-triangle me-2"></i> No hay exámenes seleccionados.
                    </div>
                }
                else
                {
                    <div class="card shadow-sm mb-4">
                        <div class="card-header bg-light fw-semibold">
                            <i class="bi bi-list-check me-2 text-primary"></i> Exámenes Seleccionados
                        </div>
                        <div class="card-body table-responsive p-0">
                            <table class="table table-striped table-bordered table-sm align-middle text-center mb-0">
                                <thead class="table-primary text-dark">
                                    <tr>
                                        <th>Nombre</th>
                                        <th>Estudio</th>
                                        <th>Precio</th>
                                        <th>Acción</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var Examen in ExamenesSeleccionados)
                                    {
                                        <tr>
                                            <td>@Examen.NombreExamen</td>
                                            <td>@Examen.Estudio</td>
                                            <td>@Examen.Precio.ToString("C")</td>
                                            <td>
                                                <button class="btn btn-outline-danger btn-sm" title="Quitar examen" @onclick="() => QuitarExamen(Examen)">
                                                    <i class="bi bi-trash"></i>
                                                </button>
                                            </td>
                                        </tr>
                                    }
                                </tbody>
                                <tfoot class="fw-bold">
                                    <tr>
                                        <td colspan="2" class="text-end">Total:</td>
                                        <td>@CalcularTotal().ToString("C")</td>
                                        <td></td>
                                    </tr>
                                </tfoot>
                            </table>
                        </div>
                    </div>
                }

                @if (MostrarModalPago)
                {
                    <div class="modal fade show d-block" style="background-color: rgba(0,0,0,0.5);">
                        <div class="modal-dialog">
                            <div class="modal-content">
                                <EditForm Model="@PagoActual" OnValidSubmit="GuardarPago">
                                    <div class="modal-header">
                                        <h5 class="modal-title"><i class="fas fa-cash-register me-2"></i> Registrar Pago</h5>
                                        <button class="btn-close" type="button" @onclick="CerrarModalPago"></button>
                                    </div>
                                    <div class="modal-body">
                                        <div class="mb-2">
                                            <label>Total a pagar</label>
                                            <input class="form-control" value="@CalcularTotal().ToString("C")" disabled />
                                        </div>
                                        <div class="mb-2">
                                            <label>Efectivo</label>
                                            <InputNumber class="form-control" @bind-Value="MontoEfectivo" />
                                        </div>
                                        <div class="mb-2">
                                            <label>Transferencia</label>
                                            <InputNumber class="form-control" @bind-Value="MontoTransferencia" />
                                        </div>

                                        @if (ObtenerCambio() > 0)
                                        {
                                            <div class="mb-2">
                                                <label>Cambio</label>
                                                <input class="form-control" value="@ObtenerCambio().ToString("C")" disabled />
                                            </div>
                                        }
                                        else if (ObtenerSaldoPendiente() > 0)
                                        {
                                            <div class="mb-2">
                                                <label>Saldo pendiente</label>
                                                <input class="form-control" value="@ObtenerSaldoPendiente().ToString("C")" disabled />
                                            </div>
                                        }
                                        else
                                        {
                                            <div class="mb-2">
                                                <label>Cambio</label>
                                                <input class="form-control" value="0,00" disabled />
                                            </div>
                                        }

                                        <div class="mb-2">
                                            <label>Observación</label>
                                            <InputTextArea class="form-control" @bind-Value="PagoActual.Observacion" />
                                        </div>
                                    </div>

                                    <div class="modal-footer">
                                        <button class="btn btn-success" type="submit">Confirmar</button>
                                        <button class="btn btn-secondary" type="button" @onclick="CerrarModalPago">Cancelar</button>
                                    </div>
                                </EditForm>
                            </div>
                        </div>
                    </div>
                }


            }
        }
    </Authorized>





    <NotAuthorized>
        <div class="d-flex justify-content-center align-items-center vh-100">
            <div class="card shadow-lg text-center border-0" style="max-width: 450px;">
                <div class="card-body p-4">
                    <i class="bi bi-person-x text-danger fs-1 mb-3"></i>
                    <h5 class="fw-bold mb-2">Debe iniciar sesión</h5>
                    <p class="text-muted mb-3">Para acceder, inicie sesión con una cuenta autorizada.</p>
                    <NavLink href="/login" class="btn btn-primary">
                        <i class="bi bi-box-arrow-in-right"></i> Ir al Login
                    </NavLink>
                </div>
            </div>
        </div>
    </NotAuthorized>
</AuthorizeView>

@code {
    private bool ContenidoCargado;
    private string CedulaPaciente = "";
    private DateOnly FechaOrden = DateOnly.FromDateTime(DateTime.Now);
    private PacienteDto? PacienteSeleccionado;
    private PacienteDto PacienteNuevo = new();
    private List<PacienteDto> PacientesEncontrados = new();
    private List<MedicoDto> ListaMedicos = new();
    private MedicoDto? MedicoSeleccionado;
    private MedicoDto MedicoNuevo = new();
    private List<ExamenDto> ExamenesDisponibles = new();
    private List<ExamenDto> ExamenesSeleccionados = new();
    private OrdenDto OrdenActual = new();
    private PagoDto PagoActual = new();
    private decimal MontoEfectivo;
    private decimal MontoTransferencia;
    private bool MostrarModalRegistrarPaciente;
    private bool MostrarModalBuscarPaciente;
    private bool MostrarModalMedico;
    private bool MostrarModalExamen;
    private bool MostrarModalPago;
    private string FiltroBusquedaPaciente = "nombre";
    private string ValorBusquedaPaciente = "";
    private string TextoBuscarExamen = "";

    private int? MedicoIdSeleccionado
    {
        get => MedicoSeleccionado?.IdMedico;
        set => MedicoSeleccionado = ListaMedicos.FirstOrDefault(m => m.IdMedico == value);
    }

    private bool SesionVerificada = false;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender && !SesionVerificada)
        {
            SesionVerificada = true;

            if (!await SesionService.VerificarOSalirAsync())
                return;

            ListaMedicos = await MedicosApi.ListarMedicosAsync();
            ContenidoCargado = true;
            StateHasChanged();
        }
    }

    private async Task BuscarPorCedula()
    {
        if (!await SesionService.VerificarOSalirAsync()) return;

        if (string.IsNullOrWhiteSpace(CedulaPaciente))
        {
            MostrarModalBuscarPaciente = true;
            ValorBusquedaPaciente = "";
            PacientesEncontrados = new();
            await JS.InvokeVoidAsync("marcarModalAbierto");
            return;
        }

        var Paciente = await PacientesApi.ObtenerPacientePorCedulaAsync(CedulaPaciente);

        if (Paciente != null)
        {
            PacienteSeleccionado = Paciente;
        }
        else
        {
            var DeseaRegistrar = await JS.InvokeAsync<bool>("confirm", "No se encontró paciente con esa cédula. ¿Desea registrarlo?");
            if (!DeseaRegistrar) return;

            if (!ValidarCedula(CedulaPaciente))
            {
                await JS.InvokeVoidAsync("alert", "La cédula ingresada no es válida.");
                return;
            }

            PacienteNuevo = new PacienteDto
            {
                CedulaPaciente = CedulaPaciente,
                FechaNacPaciente = DateTime.Today.AddYears(-20)
            };
            MostrarModalRegistrarPaciente = true;
            await JS.InvokeVoidAsync("marcarModalAbierto");
        }
    }

    private async Task BuscarPacientesModal()
    {
        if (!await SesionService.VerificarOSalirAsync()) return;

        PacientesEncontrados = string.IsNullOrWhiteSpace(ValorBusquedaPaciente)
            ? await PacientesApi.ListarPacientesAsync()
            : await PacientesApi.ListarPacientesAsync(FiltroBusquedaPaciente, ValorBusquedaPaciente);
    }

    private async Task RegistrarNuevoPaciente()
    {
        if (!await SesionService.VerificarOSalirAsync()) return;

        var (Exito, Mensaje, Paciente) = await PacientesApi.GuardarPacienteAsync(PacienteNuevo);
        await JS.InvokeVoidAsync("alert", Mensaje);

        if (Exito && Paciente != null)
        {
            PacienteSeleccionado = Paciente;
            CedulaPaciente = Paciente.CedulaPaciente;
            MostrarModalRegistrarPaciente = false;
            await JS.InvokeVoidAsync("marcarModalCerrado");
            StateHasChanged();
        }
    }

    private async Task SeleccionarPaciente(PacienteDto Paciente)
    {
        PacienteSeleccionado = Paciente;
        CedulaPaciente = Paciente.CedulaPaciente;
        MostrarModalBuscarPaciente = false;
        await JS.InvokeVoidAsync("marcarModalCerrado");
    }

    private async Task AbrirModalNuevoMedico()
    {
        MedicoNuevo = new MedicoDto();
        MostrarModalMedico = true;
        await JS.InvokeVoidAsync("marcarModalAbierto");
    }

    private async Task GuardarNuevoMedico()
    {
        if (!await SesionService.VerificarOSalirAsync()) return;

        var Respuesta = await MedicosApi.GuardarMedicoAsync(MedicoNuevo);
        if (Respuesta.IsSuccessStatusCode)
        {
            ListaMedicos = await MedicosApi.ListarMedicosAsync();
            MedicoSeleccionado = ListaMedicos.FirstOrDefault(m => m.NombreMedico == MedicoNuevo.NombreMedico);
            MostrarModalMedico = false;
            await JS.InvokeVoidAsync("marcarModalCerrado");
        }
        else
        {
            var Mensaje = await Respuesta.Content.ReadAsStringAsync();
            await JS.InvokeVoidAsync("alert", $"Error al crear médico: {Mensaje}");
        }
    }

    private async Task BuscarExamenes()
    {
        if (!await SesionService.VerificarOSalirAsync()) return;

        ExamenesDisponibles = await ExamenesApi.ListarExamenesAsync(TextoBuscarExamen);
    }

    private void SeleccionarExamen(ExamenDto Examen)
    {
        if (!ExamenesSeleccionados.Any(e => e.IdExamen == Examen.IdExamen))
            ExamenesSeleccionados.Add(Examen);
        MostrarModalExamen = false;
    }

    private void QuitarExamen(ExamenDto Examen) =>
        ExamenesSeleccionados.Remove(Examen);

    private void AbrirModalPago()
    {
        if (PacienteSeleccionado == null || MedicoSeleccionado == null || !ExamenesSeleccionados.Any())
        {
            JS.InvokeVoidAsync("alert", "Debe seleccionar paciente, médico y al menos un examen.");
            return;
        }

        MontoEfectivo = 0;
        MontoTransferencia = 0;
        PagoActual = new PagoDto();
        MostrarModalPago = true;
        StateHasChanged();
    }

    private decimal CalcularTotal() =>
        ExamenesSeleccionados.Sum(e => e.Precio);

    private decimal ObtenerSaldoPendiente() =>
        Math.Max(0, CalcularTotal() - (MontoEfectivo + MontoTransferencia));

    private decimal ObtenerCambio() =>
        Math.Max(0, (MontoEfectivo + MontoTransferencia) - CalcularTotal());

    private async Task GuardarPago()
    {
        if (!await SesionService.VerificarOSalirAsync()) return;

        var TotalPagado = MontoEfectivo + MontoTransferencia;
        var SaldoPendiente = ObtenerSaldoPendiente();

        OrdenActual.IdPaciente = PacienteSeleccionado!.IdPaciente;
        OrdenActual.IdMedico = MedicoSeleccionado!.IdMedico;
        OrdenActual.FechaOrden = FechaOrden;
        OrdenActual.Total = CalcularTotal();
        OrdenActual.SaldoPendiente = SaldoPendiente;
        OrdenActual.TotalPagado = TotalPagado;
        OrdenActual.EstadoPago = SaldoPendiente == 0 ? "PAGADO" : "PENDIENTE";
        OrdenActual.Anulado = false;
        OrdenActual.LiquidadoConvenio = false;
        OrdenActual.NumeroOrden = "";
        OrdenActual.Observacion = "";
        OrdenActual.Detalles = ExamenesSeleccionados
            .Select(e => new DetalleOrdenDto { IdExamen = e.IdExamen, Precio = e.Precio })
            .ToList();

        var DtoOrdenCompleta = new OrdenCompletaDto
        {
            Orden = OrdenActual,
            IdsExamenes = ExamenesSeleccionados.Select(e => e.IdExamen).ToList()
        };

        var RespuestaOrden = await OrdenesApi.GuardarOrdenHttpAsync(DtoOrdenCompleta);

        if (RespuestaOrden.IsSuccessStatusCode)
        {
            var RespuestaContenido = await RespuestaOrden.Content.ReadFromJsonAsync<OrdenRespuestaDto>();
            if (RespuestaContenido != null && RespuestaContenido.IdOrden > 0)
            {
                var Observacion = string.IsNullOrWhiteSpace(PagoActual.Observacion)
                    ? "PAGO DESDE ORDEN"
                    : PagoActual.Observacion;

                var Pago = new PagoDto
                {
                    IdOrden = RespuestaContenido.IdOrden,
                    FechaPago = DateTime.Now,
                    MontoPagado = TotalPagado,
                    Observacion = Observacion,
                    DetallePagos = new List<DetallePagoDto>
                {
                    new() { TipoPago = "EFECTIVO", Monto = MontoEfectivo },
                    new() { TipoPago = "TRANSFERENCIA", Monto = MontoTransferencia }
                }
                };

                await PagosApi.GuardarPagoAsync(Pago);
                Navigation.NavigateTo("/ordenes");
            }
            else await JS.InvokeVoidAsync("alert", "No se pudo registrar la orden.");
        }
        else
        {
            var Msg = await RespuestaOrden.Content.ReadAsStringAsync();
            await JS.InvokeVoidAsync("alert", $"Error al registrar la orden: {Msg}");
        }
    }

    private bool ValidarCedula(string Cedula)
    {
        if (string.IsNullOrWhiteSpace(Cedula) || Cedula.Length != 10 || !Cedula.All(char.IsDigit))
            return false;

        int suma = 0;
        for (int i = 0; i < 9; i++)
        {
            int digito = int.Parse(Cedula[i].ToString());
            int coef = (i % 2 == 0) ? 2 : 1;
            int producto = digito * coef;
            suma += (producto >= 10) ? (producto - 9) : producto;
        }

        int ultimoDigito = int.Parse(Cedula[9].ToString());
        int digitoCalculado = (suma % 10 == 0) ? 0 : (10 - (suma % 10));
        return ultimoDigito == digitoCalculado;
    }

    private async Task CerrarModalRegistrarPaciente()
    {
        MostrarModalRegistrarPaciente = false;
        await JS.InvokeVoidAsync("marcarModalCerrado");
    }

    private async Task CerrarModalBuscarPaciente()
    {
        MostrarModalBuscarPaciente = false;
        await JS.InvokeVoidAsync("marcarModalCerrado");
    }

    private async Task CerrarModalMedico()
    {
        MostrarModalMedico = false;
        await JS.InvokeVoidAsync("marcarModalCerrado");
    }

    private async Task CerrarModalExamen()
    {
        MostrarModalExamen = false;
        await JS.InvokeVoidAsync("marcarModalCerrado");
    }

    private async Task CerrarModalPago()
    {
        MostrarModalPago = false;
        await JS.InvokeVoidAsync("marcarModalCerrado");
    }

    private async Task VolverAtras() =>
        await JS.InvokeVoidAsync("history.back");
}