@page "/nueva-orden"
@rendermode InteractiveServer

@using System.Security.Claims
@using Lab_Blazor.Services.Auth
@using Lab_Blazor.Services.Examenes
@using Lab_Blazor.Services.Medicos
@using Lab_Blazor.Services.Ordenes
@using Lab_Blazor.Services.Pacientes
@using Lab_Blazor.Services.Pagos
@using Lab_Contracts.Ordenes
@using Lab_Contracts.Pacientes
@using Lab_Contracts.Medicos
@using Lab_Contracts.Examenes
@using Lab_Contracts.Pagos
@using Lab_Contracts.Common
@using Microsoft.AspNetCore.Components.Authorization

@inject SesionVerificacionService SesionService
@inject IOrdenesApiService OrdenesApi
@inject NavigationManager Navigation
@inject IPacientesApiService PacientesApi
@inject IMedicosApiService MedicosApi
@inject IExamenesApiService ExamenesApi
@inject IPagosApiService PagosApi
@inject IJSRuntime JS
@inject AuthenticationStateProvider AuthProvider

<PageTitle>Registrar Orden</PageTitle>

<AuthorizeView>
    <Authorized Context="EstadoAutenticacion">
        @{
        var usuario = EstadoAutenticacion.User;
        var rol = usuario.FindFirst(ClaimTypes.Role)?.Value ??
        usuario.FindFirst("role")?.Value ?? usuario.FindFirst("roles")?.Value ?? "";
        bool puedeVer = rol is "administrador" or "recepcionista";
        }

        @if (!puedeVer)
        {
            <div class="d-flex justify-content-center align-items-center vh-100">
                <div class="card shadow-lg text-center border-0" style="max-width: 450px;">
                    <div class="card-body p-4">
                        <i class="bi bi-shield-lock text-primary fs-1 mb-3"></i>
                        <h5 class="fw-bold mb-2">Acceso no autorizado</h5>
                        <p class="text-muted mb-3">No tienes permisos para registrar órdenes.</p>
                        <button class="btn btn-outline-primary" @onclick="VolverAtrasAsync">
                            <i class="bi bi-arrow-left"></i> Regresar
                        </button>
                    </div>
                </div>
            </div>
        }
        else
        {
            <h3 class="mb-4 d-flex align-items-center text-uppercase fw-bold flex-wrap">
                <i class="bi bi-file-earmark-medical text-primary fs-4 me-2"></i> Registrar Nueva Orden
            </h3>
            @if (!_contenidoCargado)
            {
                <div class="d-flex align-items-center text-primary">
                    <div class="spinner-border me-2" role="status"></div>
                </div>
            }
            else
            {
                <EditForm Model="@_ordenActual" OnValidSubmit="AbrirModalPago">
                    <div class="card shadow-sm mb-4">
                        <div class="card-body row g-3">
                            <div class="col-md-4">
                                <label class="form-label fw-semibold">Fecha de la Orden</label>
                                <InputDate class="form-control" @bind-Value="_fechaOrden" TValue="DateOnly" disabled />
                            </div>
                            <div class="col-md-6">
                                <label class="form-label fw-semibold">Cédula del Paciente</label>
                                <div class="input-group">
                                    <InputText class="form-control" @bind-Value="_cedulaPaciente" placeholder="Ingrese cédula" />
                                    <button type="button" class="btn btn-outline-primary" @onclick="BuscarPorCedulaAsync">
                                        <i class="bi bi-search"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                        @if (_pacienteSeleccionado is not null)
                        {
                            <div class="card border-0 shadow-sm mt-3">
                                <div class="card-header bg-light fw-semibold">
                                    <i class="bi bi-person-badge text-primary me-2"></i> Datos del Paciente
                                </div>
                                <div class="card-body">
                                    <div class="row g-3">
                                        <div class="col-md-4">
                                            <label class="form-label fw-semibold">Nombre</label>
                                            <input class="form-control" value="@_pacienteSeleccionado.NombrePaciente" disabled />
                                        </div>
                                        <div class="col-md-3">
                                            <label class="form-label fw-semibold">Cédula</label>
                                            <input class="form-control" value="@_pacienteSeleccionado.CedulaPaciente" disabled />
                                        </div>
                                        <div class="col-md-5">
                                            <label class="form-label fw-semibold">Correo Electrónico</label>
                                            <input class="form-control" value="@_pacienteSeleccionado.CorreoElectronicoPaciente" disabled />
                                        </div>
                                        <div class="col-md-4">
                                            <label class="form-label fw-semibold">Teléfono</label>
                                            <input class="form-control" value="@_pacienteSeleccionado.TelefonoPaciente" disabled />
                                        </div>
                                        <div class="col-md-8">
                                            <label class="form-label fw-semibold">Dirección</label>
                                            <input class="form-control" value="@_pacienteSeleccionado.DireccionPaciente" disabled />
                                        </div>
                                    </div>
                                </div>
                            </div>
                        }
                    </div>
                    <div class="card shadow-sm mb-4">
                        <div class="card-body">
                            <label class="form-label fw-semibold">Médico</label>
                            <div class="input-group">
                                <select class="form-select" @bind="MedicoIdSeleccionado">
                                    <option value="">-- Seleccione un médico --</option>
                                    @foreach (var medico in _listaMedicos)
                                    {
                                        <option value="@medico.IdMedico">@medico.NombreMedico</option>
                                    }
                                </select>
                                <button class="btn btn-secondary" type="button" @onclick="AbrirModalNuevoMedicoAsync">
                                    <i class="bi bi-person-plus"></i> Nuevo
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <button class="btn btn-success" type="button" @onclick="AbrirModalExamenAsync">
                            <i class="bi bi-plus-circle me-1"></i> Agregar Examen
                        </button>
                    </div>
                    <div class="text-end mb-4">
                        <button class="btn btn-primary px-4" type="submit">
                            <i class="bi bi-save me-1"></i> Guardar Orden
                        </button>
                    </div>
                </EditForm>
                @if (_mostrarModalRegistrarPaciente)
                {
                    <div class="modal show d-block" style="background-color: rgba(0,0,0,0.5);">
                        <div class="modal-dialog modal-lg modal-dialog-centered">
                            <div class="modal-content shadow-lg border-0">
                                <EditForm Model="@_pacienteNuevo" OnValidSubmit="RegistrarNuevoPacienteAsync">
                                    <div class="modal-header bg-primary text-white">
                                        <h5 class="modal-title"><i class="bi bi-person-plus me-2"></i>Registrar Paciente</h5>
                                        <button type="button" class="btn-close btn-close-white" @onclick="CerrarModalRegistrarPacienteAsync"></button>
                                    </div>
                                    <div class="modal-body">
                                        <DataAnnotationsValidator />
                                        <ValidationSummary />
                                        <div class="row g-3">
                                            <div class="col-md-6">
                                                <label class="form-label">Cédula</label>
                                                <InputText class="form-control" @bind-Value="_pacienteNuevo.CedulaPaciente" readonly />
                                            </div>
                                            <div class="col-md-6">
                                                <label class="form-label">Nombre</label>
                                                <InputText class="form-control text-uppercase"
                                                           @bind-Value="_pacienteNuevo.NombrePaciente"
                                                           @oninput="(e => _pacienteNuevo.NombrePaciente = e.Value?.ToString()?.ToUpper() ?? string.Empty)" />
                                            </div>
                                            <div class="col-md-6">
                                                <label class="form-label">Fecha Nacimiento</label>
                                                <InputDate class="form-control" @bind-Value="_pacienteNuevo.FechaNacPaciente" TValue="DateTime" />
                                            </div>
                                            <div class="col-md-6">
                                                <label class="form-label">Correo</label>
                                                <InputText class="form-control" @bind-Value="_pacienteNuevo.CorreoElectronicoPaciente" />
                                            </div>
                                            <div class="col-md-6">
                                                <label class="form-label">Teléfono</label>
                                                <InputText class="form-control" @bind-Value="_pacienteNuevo.TelefonoPaciente" />
                                            </div>
                                            <div class="col-md-6">
                                                <label class="form-label">Dirección</label>
                                                <InputText class="form-control text-uppercase"
                                                           @bind-Value="_pacienteNuevo.DireccionPaciente"
                                                           @oninput="(e => _pacienteNuevo.DireccionPaciente = e.Value?.ToString()?.ToUpper() ?? string.Empty)" />
                                            </div>
                                        </div>
                                    </div>
                                    <div class="modal-footer">
                                        <button class="btn btn-primary px-3" type="submit">
                                            <i class="bi bi-save me-1"></i>Guardar
                                        </button>
                                        <button class="btn btn-secondary" type="button" @onclick="CerrarModalRegistrarPacienteAsync">
                                            <i class="bi bi-x-lg me-1"></i>Cancelar
                                        </button>
                                    </div>
                                </EditForm>
                            </div>
                        </div>
                    </div>
                }

                @if (_mostrarModalBuscarPaciente)
                {
                    <div class="modal show d-block" style="background-color: rgba(0,0,0,0.5);">
                        <div class="modal-dialog modal-lg modal-dialog-centered">
                            <div class="modal-content shadow-lg border-0">
                                <div class="modal-header bg-primary text-white">
                                    <h5 class="modal-title"><i class="bi bi-search me-2"></i>Buscar Paciente</h5>
                                    <button type="button" class="btn-close btn-close-white" @onclick="CerrarModalBuscarPacienteAsync"></button>
                                </div>
                                <div class="modal-body">
                                    <div class="row g-2 mb-3">
                                        <div class="col-md-3">
                                            <InputSelect class="form-select" @bind-Value="_filtroPaciente.CriterioBusqueda">
                                                <option value="nombre">Nombre</option>
                                                <option value="cedula">Cédula</option>
                                                <option value="correo">Correo</option>
                                            </InputSelect>
                                        </div>
                                        <div class="col-md-5">
                                            <InputText class="form-control" @bind-Value="_filtroPaciente.ValorBusqueda" placeholder="Ingrese valor a buscar" />
                                        </div>
                                        <div class="col-md-2">
                                            <select class="form-select form-select-sm" @bind="_filtroPaciente.PageSize" @bind:after="async () => { _filtroPaciente.PageNumber = 1; await BuscarPacientesModalAsync(); }">
                                                <option value="5">5</option>
                                                <option value="10">10</option>
                                                <option value="15">15</option>
                                                <option value="20">20</option>
                                                <option value="50">50</option>
                                            </select>
                                        </div>
                                        <div class="col-md-2 d-grid">
                                            <button class="btn btn-primary" @onclick="BuscarPacientesModalAsync"><i class="bi bi-search"></i></button>
                                        </div>
                                    </div>
                                    <div class="d-flex justify-content-between align-items-center mb-2">
                                        <div class="text-muted small">
                                            @if (_resultadoPacientes != null)
                                            {
                                                <span>@RangoMostradoPacientes</span>
                                            }
                                        </div>
                                        <div class="d-flex align-items-center gap-2">
                                            <button class="btn btn-sm btn-outline-secondary me-1" disabled="@(_resultadoPacientes == null || _resultadoPacientes.PageNumber == 1)" @onclick="(() => CambiarPaginaPacienteAsync(-1))"><i class="bi bi-chevron-left"></i></button>
                                            <button class="btn btn-sm btn-outline-secondary" disabled="@(_resultadoPacientes == null || _resultadoPacientes.PageNumber >= TotalPaginasPacientes)" @onclick="(() => CambiarPaginaPacienteAsync(1))"><i class="bi bi-chevron-right"></i></button>
                                        </div>
                                    </div>
                                    <div style="max-height: 300px; overflow-y: auto;" class="border rounded">
                                        <table class="table table-sm table-hover align-middle mb-0">
                                            <thead class="table-light">
                                                <tr><th>Cédula</th><th>Nombre</th><th>Correo</th><th></th></tr>
                                            </thead>
                                            <tbody>
                                                @if (_resultadoPacientes?.Items.Any() == true)
                                                {
                                                    @foreach (var paciente in _resultadoPacientes.Items)
                                                    {
                                                        <tr>
                                                            <td>@paciente.CedulaPaciente</td>
                                                            <td>@paciente.NombrePaciente</td>
                                                            <td>@paciente.CorreoElectronicoPaciente</td>
                                                            <td>
                                                                <button class="btn btn-success btn-sm" @onclick="() => SeleccionarPacienteAsync(paciente)"><i class="bi bi-check-lg"></i></button>
                                                            </td>
                                                        </tr>
                                                    }
                                                }
                                                else
                                                {
                                                    <tr><td colspan="4" class="text-center text-muted">Sin resultados</td></tr>
                                                }
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                                <div class="modal-footer">
                                    <button class="btn btn-secondary" @onclick="CerrarModalBuscarPacienteAsync">Cerrar</button>
                                </div>
                            </div>
                        </div>
                    </div>
                }

                @if (_mostrarModalMedico)
                {
                    <div class="modal show d-block" style="background-color: rgba(0,0,0,0.5);">
                        <div class="modal-dialog modal-md modal-dialog-centered">
                            <div class="modal-content shadow-lg border-0">
                                <EditForm Model="@_medicoNuevo" OnValidSubmit="GuardarNuevoMedicoAsync">
                                    <div class="modal-header bg-primary text-white">
                                        <h5 class="modal-title"><i class="bi bi-person-plus me-2"></i>Registrar Médico</h5>
                                        <button type="button" class="btn-close btn-close-white" @onclick="CerrarModalMedicoAsync"></button>
                                    </div>
                                    <div class="modal-body">
                                        <DataAnnotationsValidator />
                                        <ValidationSummary />
                                        <div class="mb-3">
                                            <label class="form-label">Nombre</label>
                                            <InputText class="form-control text-uppercase"
                                                       @bind-Value="_medicoNuevo.NombreMedico"
                                                       @oninput="(e => _medicoNuevo.NombreMedico = e.Value?.ToString()?.ToUpper() ?? string.Empty)" />
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label">Especialidad</label>
                                            <InputText class="form-control text-uppercase"
                                                       @bind-Value="_medicoNuevo.Especialidad"
                                                       @oninput="(e => _medicoNuevo.Especialidad = e.Value?.ToString()?.ToUpper() ?? string.Empty)" />
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label">Teléfono</label>
                                            <InputText class="form-control" @bind-Value="_medicoNuevo.Telefono" />
                                        </div>
                                    </div>
                                    <div class="modal-footer">
                                        <button class="btn btn-primary px-3" type="submit">
                                            <i class="bi bi-save me-1"></i>Guardar
                                        </button>
                                        <button class="btn btn-secondary" type="button" @onclick="CerrarModalMedicoAsync">
                                            <i class="bi bi-x-lg me-1"></i>Cancelar
                                        </button>
                                    </div>
                                </EditForm>
                            </div>
                        </div>
                    </div>
                }

                @if (_mostrarModalExamen)
                {
                    <div class="modal show d-block" style="background-color: rgba(0,0,0,0.5);">
                        <div class="modal-dialog modal-xl modal-dialog-centered">
                            <div class="modal-content shadow-lg border-0">
                                <div class="modal-header bg-primary text-white">
                                    <h5 class="modal-title"><i class="bi bi-flask me-2"></i>Seleccionar Examen</h5>
                                    <button type="button" class="btn-close btn-close-white" @onclick="CerrarModalExamenAsync"></button>
                                </div>
                                <div class="modal-body">
                                    <div class="row g-2 mb-3">
                                        <div class="col-md-3">
                                            <InputSelect class="form-select" @bind-Value="_filtroExamen.CriterioBusqueda">
                                                <option value="nombre">Nombre</option>
                                                <option value="estudio">Estudio</option>
                                                <option value="tipo">Tipo de Examen</option>
                                                <option value="tecnica">Técnica</option>
                                            </InputSelect>
                                        </div>
                                        <div class="col-md-5">
                                            <InputText class="form-control" @bind-Value="_filtroExamen.ValorBusqueda" placeholder="Buscar examen..." @onkeypress="@(async e => { if (e.Key == "Enter") { _filtroExamen.PageNumber = 1; await BuscarExamenesModalAsync(); } })" />
                                        </div>
                                        <div class="col-md-2">
                                            <select class="form-select form-select-sm" @bind="_filtroExamen.PageSize" @bind:after="async () => { _filtroExamen.PageNumber = 1; await BuscarExamenesModalAsync(); }">
                                                <option value="5">5</option>
                                                <option value="10">10</option>
                                                <option value="15">15</option>
                                                <option value="20">20</option>
                                                <option value="50">50</option>
                                            </select>
                                        </div>
                                        <div class="col-md-2 d-grid">
                                            <button class="btn btn-primary" @onclick="@(async ()=> { _filtroExamen.PageNumber = 1; await BuscarExamenesModalAsync(); })"><i class="bi bi-search"></i></button>
                                        </div>
                                    </div>
                                    <div class="d-flex justify-content-between align-items-center mb-2">
                                        <div class="text-muted small">
                                            @if (_resultadoExamenes != null)
                                            {
                                                <span>@RangoMostradoExamenes</span>
                                            }
                                        </div>
                                        <div class="d-flex align-items-center gap-2">
                                            <button class="btn btn-sm btn-outline-secondary me-1" disabled="@(_resultadoExamenes == null || _resultadoExamenes.PageNumber == 1)" @onclick="(() => CambiarPaginaExamenAsync(-1))"><i class="bi bi-chevron-left"></i></button>
                                            <button class="btn btn-sm btn-outline-secondary" disabled="@(_resultadoExamenes == null || _resultadoExamenes.PageNumber >= TotalPaginasExamenes)" @onclick="(() => CambiarPaginaExamenAsync(1))"><i class="bi bi-chevron-right"></i></button>
                                        </div>
                                    </div>
                                    <div style="max-height: 400px; overflow-y: auto;" class="border rounded">
                                        <table class="table table-sm table-hover align-middle mb-0">
                                            <thead class="table-light text-center">
                                                <tr>
                                                    <th>Nombre</th>
                                                    <th>Estudio</th>
                                                    <th>Precio</th>
                                                    <th>Acción</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                @if (_resultadoExamenes == null)
                                                {
                                                    <tr>
                                                        <td colspan="4" class="text-center text-muted">Ingrese un criterio y presione buscar</td>
                                                    </tr>
                                                }
                                                else if (_resultadoExamenes.Items.Any())
                                                {
                                                    @foreach (var examen in _resultadoExamenes.Items)
                                                    {
                                                        <tr class="text-center">
                                                            <td>@examen.NombreExamen</td>
                                                            <td>@examen.Estudio</td>
                                                            <td>@examen.Precio.ToString("C")</td>
                                                            <td>
                                                                <button class="btn btn-success btn-sm" @onclick="() => SeleccionarExamen(examen)"><i class="bi bi-check-lg"></i></button>
                                                            </td>
                                                        </tr>
                                                    }
                                                }
                                                else
                                                {
                                                    <tr>
                                                        <td colspan="4" class="text-center text-muted">No hay resultados</td>
                                                    </tr>
                                                }
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                                <div class="modal-footer">
                                    <button class="btn btn-secondary" type="button" @onclick="CerrarModalExamenAsync">
                                        <i class="bi bi-x-lg me-1"></i> Cerrar
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                }
                @if (!_examenesSeleccionados.Any())
                {
                    <div class="alert alert-warning text-center mt-3">
                        <i class="bi bi-exclamation-triangle me-2"></i> No hay exámenes seleccionados.
                    </div>
                }
                else
                {
                    <div class="card shadow-sm mb-4">
                        <div class="card-header bg-light fw-semibold">
                            <i class="bi bi-list-check me-2 text-primary"></i> Exámenes Seleccionados
                        </div>
                        <div class="card-body table-responsive p-0">
                            <table class="table table-striped table-bordered table-sm align-middle text-center mb-0">
                                <thead class="table-primary text-dark">
                                    <tr>
                                        <th>Nombre</th>
                                        <th>Estudio</th>
                                        <th>Precio</th>
                                        <th>Acción</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var examen in _examenesSeleccionados)
                                    {
                                        <tr>
                                            <td>@examen.NombreExamen</td>
                                            <td>@examen.Estudio</td>
                                            <td>@examen.Precio.ToString("C")</td>
                                            <td>
                                                <button class="btn btn-outline-danger btn-sm" title="Quitar examen" @onclick="() => QuitarExamen(examen)"><i class="bi bi-trash"></i></button>
                                            </td>
                                        </tr>
                                    }
                                </tbody>
                                <tfoot class="fw-bold">
                                    <tr>
                                        <td colspan="2" class="text-end">Total:</td>
                                        <td>@CalcularTotal()</td>
                                        <td></td>
                                    </tr>
                                </tfoot>
                            </table>
                        </div>
                    </div>
                }
                @if (_mostrarModalPago)
                {
                    <div class="modal fade show d-block" style="background-color: rgba(0,0,0,0.5);">
                        <div class="modal-dialog">
                            <div class="modal-content">
                                <EditForm Model="@_pagoActual" OnValidSubmit="GuardarPagoAsync">
                                    <div class="modal-header">
                                        <h5 class="modal-title"><i class="fas fa-cash-register me-2"></i> Registrar Pago</h5>
                                        <button class="btn-close" type="button" @onclick="CerrarModalPagoAsync"></button>
                                    </div>
                                    <div class="modal-body">
                                        <div class="mb-2">
                                            <label>Total a pagar</label>
                                            <input class="form-control" value="@CalcularTotal()" disabled />
                                        </div>
                                        <div class="mb-2">
                                            <label>Efectivo</label>
                                            <InputNumber class="form-control" @bind-Value="_montoEfectivo" />
                                        </div>
                                        <div class="mb-2">
                                            <label>Transferencia</label>
                                            <InputNumber class="form-control" @bind-Value="_montoTransferencia" />
                                        </div>
                                        @if (ObtenerCambio() > 0)
                                        {
                                            <div class="mb-2">
                                                <label>Cambio</label>
                                                <input class="form-control" value="@ObtenerCambio()" disabled />
                                            </div>
                                        }
                                        else if (ObtenerSaldoPendiente() > 0)
                                        {
                                            <div class="mb-2">
                                                <label>Saldo pendiente</label>
                                                <input class="form-control" value="@ObtenerSaldoPendiente()" disabled />
                                            </div>
                                        }
                                        else
                                        {
                                            <div class="mb-2">
                                                <label>Cambio</label>
                                                <input class="form-control" value="0,00" disabled />
                                            </div>
                                        }
                                        <div class="mb-2">
                                            <label>Observación</label>
                                            <InputTextArea class="form-control" @bind-Value="_pagoActual.Observacion" />
                                        </div>
                                    </div>
                                    <div class="modal-footer">
                                        <button class="btn btn-success" type="submit">Confirmar</button>
                                        <button class="btn btn-secondary" type="button" @onclick="CerrarModalPagoAsync">Cancelar</button>
                                    </div>
                                </EditForm>
                            </div>
                        </div>
                    </div>
                }
            }
        }
    </Authorized>
    <NotAuthorized>
        <div class="d-flex justify-content-center align-items-center vh-100">
            <div class="card shadow-lg text-center border-0" style="max-width: 450px;">
                <div class="card-body p-4">
                    <i class="bi bi-person-x text-danger fs-1 mb-3"></i>
                    <h5 class="fw-bold mb-2">Debe iniciar sesión</h5>
                    <p class="text-muted mb-3">Para acceder, inicie sesión con una cuenta autorizada.</p>
                    <NavLink href="/login" class="btn btn-primary">
                        <i class="bi bi-box-arrow-in-right"></i> Ir al Login
                    </NavLink>
                </div>
            </div>
        </div>
    </NotAuthorized>
</AuthorizeView>

@code {
    private bool _contenidoCargado;
    private string _cedulaPaciente = "";
    private DateOnly _fechaOrden = DateOnly.FromDateTime(DateTime.Now);
    private PacienteDto? _pacienteSeleccionado;
    private PacienteDto _pacienteNuevo = new();
    private List<MedicoDto> _listaMedicos = new();
    private MedicoDto? _medicoSeleccionado;
    private MedicoDto _medicoNuevo = new();
    private List<ExamenDto> _examenesSeleccionados = new();
    private OrdenDto _ordenActual = new();
    private PagoDto _pagoActual = new();
    private decimal _montoEfectivo;
    private decimal _montoTransferencia;
    private bool _mostrarModalRegistrarPaciente;
    private bool _mostrarModalBuscarPaciente;
    private bool _mostrarModalMedico;
    private bool _mostrarModalExamen;
    private bool _mostrarModalPago;
    private PacienteFiltroDto _filtroPaciente = new() { PageNumber = 1, PageSize = 10, SortBy = nameof(PacienteDto.NombrePaciente), SortAsc = true, IncluirAnulados = true, IncluirVigentes = true };
    private ResultadoPaginadoDto<PacienteDto>? _resultadoPacientes;
    private ExamenFiltroDto _filtroExamen = new() { CriterioBusqueda = "nombre", PageNumber = 1, PageSize = 10, SortBy = nameof(ExamenDto.NombreExamen), SortAsc = true, IncluirAnulados = false, IncluirVigentes = true };
    private ResultadoPaginadoDto<ExamenDto>? _resultadoExamenes;
    private int? MedicoIdSeleccionado { get => _medicoSeleccionado?.IdMedico; set => _medicoSeleccionado = _listaMedicos.FirstOrDefault(m => m.IdMedico == value); }
    private bool _sesionVerificada = false;
    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender && !_sesionVerificada)
        {
            _sesionVerificada = true;
            if (!await SesionService.VerificarOSalirAsync()) return;
            _listaMedicos = await MedicosApi.ListarMedicosAsync();
            _contenidoCargado = true;
            StateHasChanged();
        }
    }
    private async Task BuscarPorCedulaAsync()
    {
        if (!await SesionService.VerificarOSalirAsync()) return;
        if (string.IsNullOrWhiteSpace(_cedulaPaciente))
        {
            _mostrarModalBuscarPaciente = true;
            _resultadoPacientes = null;
            await JS.InvokeVoidAsync("marcarModalAbierto");
            return;
        }
        var paciente = await PacientesApi.ObtenerPacientePorCedulaAsync(_cedulaPaciente);
        if (paciente != null)
        {
            _pacienteSeleccionado = paciente;
        }
        else
        {
            var deseaRegistrar = await JS.InvokeAsync<bool>("confirm", "No se encontró paciente con esa cédula. ¿Desea registrarlo?");
            if (!deseaRegistrar) return;
            if (!ValidarCedula(_cedulaPaciente))
            {
                await JS.InvokeVoidAsync("alert", "La cédula ingresada no es válida.");
                return;
            }
            _pacienteNuevo = new PacienteDto { CedulaPaciente = _cedulaPaciente, FechaNacPaciente = DateTime.Today.AddYears(-20) };
            _mostrarModalRegistrarPaciente = true;
            await JS.InvokeVoidAsync("marcarModalAbierto");
        }
    }
    private async Task BuscarPacientesModalAsync()
    {
        if (!await SesionService.VerificarOSalirAsync()) return;
        _resultadoPacientes = await PacientesApi.ListarPacientesPaginadosAsync(_filtroPaciente);
    }
    private async Task CambiarPaginaPacienteAsync(int delta)
    {
        if (_resultadoPacientes == null) return;
        var nueva = Math.Max(1, Math.Min(TotalPaginasPacientes, _resultadoPacientes.PageNumber + delta));
        if (nueva == _resultadoPacientes.PageNumber) return;
        _filtroPaciente.PageNumber = nueva;
        await BuscarPacientesModalAsync();
    }
    private int TotalPaginasPacientes => _resultadoPacientes == null || _resultadoPacientes.PageSize == 0 ? 1 : (int)Math.Ceiling(_resultadoPacientes.TotalCount / (double)_resultadoPacientes.PageSize);
    private string RangoMostradoPacientes
    {
        get
        {
            if (_resultadoPacientes == null || _resultadoPacientes.TotalCount == 0) return "";
            int desde = ((_resultadoPacientes.PageNumber - 1) * _resultadoPacientes.PageSize) + 1;
            int hasta = Math.Min(_resultadoPacientes.PageNumber * _resultadoPacientes.PageSize, _resultadoPacientes.TotalCount);
            return $"Mostrando {desde} - {hasta} de {_resultadoPacientes.TotalCount} pacientes";
        }
    }
    private async Task SeleccionarPacienteAsync(PacienteDto paciente)
    {
        _pacienteSeleccionado = paciente;
        _cedulaPaciente = paciente.CedulaPaciente;
        _mostrarModalBuscarPaciente = false;
        await JS.InvokeVoidAsync("marcarModalCerrado");
    }
    private async Task BuscarExamenesModalAsync()
    {
        if (!await SesionService.VerificarOSalirAsync()) return;
        if (string.IsNullOrWhiteSpace(_filtroExamen.ValorBusqueda))
        {
            _resultadoExamenes = null;
            StateHasChanged();
            return;
        }
        _resultadoExamenes = await ExamenesApi.ListarExamenesPaginadosAsync(_filtroExamen);
    }
    private async Task AbrirModalExamenAsync()
    {
        _mostrarModalExamen = true;
        _filtroExamen.PageNumber = 1;
        _resultadoExamenes = null;
        await JS.InvokeVoidAsync("marcarModalAbierto");
        StateHasChanged();
    }
    private async Task CambiarPaginaExamenAsync(int delta)
    {
        if (_resultadoExamenes == null) return;
        var nueva = Math.Max(1, Math.Min(TotalPaginasExamenes, _resultadoExamenes.PageNumber + delta));
        if (nueva == _resultadoExamenes.PageNumber) return;
        _filtroExamen.PageNumber = nueva;
        await BuscarExamenesModalAsync();
    }
    private int TotalPaginasExamenes => _resultadoExamenes == null || _resultadoExamenes.PageSize == 0 ? 1 : (int)Math.Ceiling(_resultadoExamenes.TotalCount / (double)_resultadoExamenes.PageSize);
    private string RangoMostradoExamenes
    {
        get
        {
            if (_resultadoExamenes == null || _resultadoExamenes.TotalCount == 0) return "";
            int desde = ((_resultadoExamenes.PageNumber - 1) * _resultadoExamenes.PageSize) + 1;
            int hasta = Math.Min(_resultadoExamenes.PageNumber * _resultadoExamenes.PageSize, _resultadoExamenes.TotalCount);
            return $"Mostrando {desde} - {hasta} de {_resultadoExamenes.TotalCount} exámenes";
        }
    }
    private async Task SeleccionarExamen(ExamenDto examen)
    {
        if (!_examenesSeleccionados.Any(e => e.IdExamen == examen.IdExamen))
            _examenesSeleccionados.Add(examen);
        _mostrarModalExamen = false;
        _resultadoExamenes = null;
        await JS.InvokeVoidAsync("marcarModalCerrado");
    }
    private void QuitarExamen(ExamenDto examen) => _examenesSeleccionados.Remove(examen);
    private async Task AbrirModalNuevoMedicoAsync()
    {
        _medicoNuevo = new MedicoDto();
        _mostrarModalMedico = true;
        await JS.InvokeVoidAsync("marcarModalAbierto");
    }
    private async Task GuardarNuevoMedicoAsync()
    {
        if (!await SesionService.VerificarOSalirAsync()) return;
        var respuesta = await MedicosApi.GuardarMedicoAsync(_medicoNuevo);
        if (respuesta.IsSuccessStatusCode)
        {
            _listaMedicos = await MedicosApi.ListarMedicosAsync();
            _medicoSeleccionado = _listaMedicos.FirstOrDefault(m => m.NombreMedico == _medicoNuevo.NombreMedico);
            _mostrarModalMedico = false;
            await JS.InvokeVoidAsync("marcarModalCerrado");
        }
        else
        {
            var mensaje = await respuesta.Content.ReadAsStringAsync();
            await JS.InvokeVoidAsync("alert", $"Error al crear médico: {mensaje}");
        }
    }
    private void AbrirModalPago()
    {
        if (_pacienteSeleccionado == null || _medicoSeleccionado == null || !_examenesSeleccionados.Any())
        {
            JS.InvokeVoidAsync("alert", "Debe seleccionar paciente, médico y al menos un examen.");
            return;
        }
        _montoEfectivo = 0;
        _montoTransferencia = 0;
        _pagoActual = new PagoDto();
        _mostrarModalPago = true;
        StateHasChanged();
    }
    private decimal CalcularTotal() => _examenesSeleccionados.Sum(e => e.Precio);
    private decimal ObtenerSaldoPendiente() => Math.Max(0, CalcularTotal() - (_montoEfectivo + _montoTransferencia));
    private decimal ObtenerCambio() => Math.Max(0, (_montoEfectivo + _montoTransferencia) - CalcularTotal());
    private async Task GuardarPagoAsync()
    {
        if (!await SesionService.VerificarOSalirAsync()) return;
        var totalPagado = _montoEfectivo + _montoTransferencia;
        var saldoPendiente = ObtenerSaldoPendiente();
        _ordenActual.IdPaciente = _pacienteSeleccionado!.IdPaciente;
        _ordenActual.IdMedico = _medicoSeleccionado!.IdMedico;
        _ordenActual.FechaOrden = _fechaOrden;
        _ordenActual.Total = CalcularTotal();
        _ordenActual.SaldoPendiente = saldoPendiente;
        _ordenActual.TotalPagado = totalPagado;
        _ordenActual.EstadoPago = saldoPendiente == 0 ? "PAGADO" : "PENDIENTE";
        _ordenActual.Anulado = false;
        _ordenActual.NumeroOrden = "";
        _ordenActual.Observacion = "";
        _ordenActual.Detalles = _examenesSeleccionados.Select(e => new DetalleOrdenDto { IdExamen = e.IdExamen, Precio = e.Precio }).ToList();
        var dtoOrdenCompleta = new OrdenCompletaDto { Orden = _ordenActual, IdsExamenes = _examenesSeleccionados.Select(e => e.IdExamen).ToList() };
        var respuestaOrden = await OrdenesApi.GuardarOrdenHttpAsync(dtoOrdenCompleta);
        if (respuestaOrden.IsSuccessStatusCode)
        {
            var respuestaContenido = await respuestaOrden.Content.ReadFromJsonAsync<OrdenRespuestaDto>();
            if (respuestaContenido != null && respuestaContenido.IdOrden > 0)
            {
                var observacion = string.IsNullOrWhiteSpace(_pagoActual.Observacion) ? "PAGO DESDE ORDEN" : _pagoActual.Observacion;
                var pago = new PagoDto
                {
                    IdOrden = respuestaContenido.IdOrden,
                    FechaPago = DateTime.Now,
                    MontoPagado = totalPagado,
                    Observacion = observacion,
                    DetallePagos = new List<DetallePagoDto>
                {
                    new() { TipoPago = "EFECTIVO", Monto = _montoEfectivo },
                    new() { TipoPago = "TRANSFERENCIA", Monto = _montoTransferencia }
                }
                };
                await PagosApi.GuardarPagoAsync(pago);
                Navigation.NavigateTo("/ordenes");
            }
            else await JS.InvokeVoidAsync("alert", "No se pudo registrar la orden.");
        }
        else
        {
            var msg = await respuestaOrden.Content.ReadAsStringAsync();
            await JS.InvokeVoidAsync("alert", $"Error al registrar la orden: {msg}");
        }
    }
    private bool ValidarCedula(string cedula)
    {
        if (string.IsNullOrWhiteSpace(cedula) || cedula.Length != 10 || !cedula.All(char.IsDigit)) return false;
        int suma = 0;
        for (int i = 0; i < 9; i++)
        {
            int digito = int.Parse(cedula[i].ToString());
            int coef = (i % 2 == 0) ? 2 : 1;
            int producto = digito * coef;
            suma += (producto >= 10) ? (producto - 9) : producto;
        }
        int ultimoDigito = int.Parse(cedula[9].ToString());
        int digitoCalculado = (suma % 10 == 0) ? 0 : (10 - (suma % 10));
        return ultimoDigito == digitoCalculado;
    }
    private async Task CerrarModalRegistrarPacienteAsync()
    {
        _mostrarModalRegistrarPaciente = false;
        await JS.InvokeVoidAsync("marcarModalCerrado");
    }
    private async Task CerrarModalBuscarPacienteAsync()
    {
        _mostrarModalBuscarPaciente = false;
        await JS.InvokeVoidAsync("marcarModalCerrado");
    }
    private async Task CerrarModalMedicoAsync()
    {
        _mostrarModalMedico = false;
        await JS.InvokeVoidAsync("marcarModalCerrado");
    }
    private async Task CerrarModalExamenAsync()
    {
        _mostrarModalExamen = false;
        _resultadoExamenes = null;
        await JS.InvokeVoidAsync("marcarModalCerrado");
    }
    private async Task CerrarModalPagoAsync()
    {
        _mostrarModalPago = false;
        await JS.InvokeVoidAsync("marcarModalCerrado");
    }
    private async Task VolverAtrasAsync() => await JS.InvokeVoidAsync("history.back");
    private async Task RegistrarNuevoPacienteAsync()
    {
        if (!await SesionService.VerificarOSalirAsync()) return;
        var resultado = await PacientesApi.GuardarPacienteAsync(_pacienteNuevo);
        if (resultado.Exito && resultado.Paciente != null)
        {
            _pacienteSeleccionado = resultado.Paciente;
            _cedulaPaciente = resultado.Paciente.CedulaPaciente;
            _mostrarModalRegistrarPaciente = false;
            await JS.InvokeVoidAsync("marcarModalCerrado");
        }
        else
        {
            await JS.InvokeVoidAsync("alert", $"Error al registrar paciente: {resultado.Mensaje}");
        }
    }
}