    @page "/nueva-orden"
@rendermode InteractiveServer

@using Lab_Blazor.Services.Examenes
@using Lab_Blazor.Services.Medicos
@using Lab_Blazor.Services.Ordenes
@using Lab_Blazor.Services.Pacientes
@using Lab_Blazor.Services.Pagos
@using Lab_Contracts.Ordenes
@using Lab_Contracts.Pacientes
@using Lab_Contracts.Medicos
@using Lab_Contracts.Examenes
@using Lab_Contracts.Pagos
@using Microsoft.AspNetCore.Components.Authorization
@using System.Security.Claims
@using System.Linq
@using Lab_Blazor.Services.Auth
@inject SesionVerificacionService SesionService
@inject IOrdenesApiService OrdenApi
@inject NavigationManager Navigation
@inject IPacientesApiService PacientesApi
@inject IMedicosApiService MedicosApi
@inject IExamenesApiService ExamenesApi
@inject IPagosApiService PagosApi
@inject IJSRuntime JS
@inject AuthenticationStateProvider AuthProvider

<PageTitle>Registrar Orden</PageTitle>

<AuthorizeView>
    <Authorized Context="authState">
        @{
            var user = authState.User;
            var rol = user.FindFirst(ClaimTypes.Role)?.Value
            ?? user.FindFirst("role")?.Value
            ?? user.FindFirst("roles")?.Value
            ?? "";
            bool puedeVer = rol is "administrador" or "recepcionista";
        }

        @if (!puedeVer)
        {
            <div class="d-flex justify-content-center align-items-center vh-100">
                <div class="card shadow-lg text-center border-0" style="max-width: 450px;">
                    <div class="card-body p-4">
                        <i class="bi bi-shield-lock text-primary fs-1 mb-3"></i>
                        <h5 class="fw-bold mb-2">Acceso no autorizado</h5>
                        <p class="text-muted mb-3">No tienes permisos para registrar órdenes.</p>
                        <button class="btn btn-outline-primary" @onclick="VolverAtras">
                            <i class="bi bi-arrow-left"></i> Regresar
                        </button>
                    </div>
                </div>
            </div>
        }
        else
        {
            <h3 class="mb-4 d-flex align-items-center text-uppercase fw-bold flex-wrap">
                <i class="bi bi-file-earmark-medical text-primary fs-4 me-2"></i> Registrar Nueva Orden
            </h3>

            @if (!cargado)
            {
                <div class="d-flex align-items-center text-primary">
                    <div class="spinner-border me-2" role="status"></div>
                </div>
            }
            else
            {
                <EditForm Model="orden" OnValidSubmit="MostrarPagoModal">
                    <div class="card shadow-sm mb-4">
                        <div class="card-body row g-3">
                            <div class="col-md-4">
                                <label class="form-label fw-semibold">Fecha de la Orden</label>
                                <InputDate class="form-control" @bind-Value="FechaOrdenSeleccionada" TValue="DateOnly" disabled />
                            </div>

                            <div class="col-md-6">
                                <label class="form-label fw-semibold">Cédula del Paciente</label>
                                <div class="input-group">
                                    <InputText class="form-control" @bind-Value="Cedula" placeholder="Ingrese cédula" />
                                    <button type="button" class="btn btn-outline-primary" @onclick="BuscarPorCedula">
                                        <i class="bi bi-search"></i>
                                    </button>

                                </div>
                            </div>
                        </div>

                        @if (PacienteActual is not null)
                        {
                            <div class="card border-0 shadow-sm mt-3">
                                <div class="card-header bg-light fw-semibold">
                                    <i class="bi bi-person-badge text-primary me-2"></i> Datos del Paciente
                                </div>
                                <div class="card-body">
                                    <div class="row g-3">
                                        <div class="col-md-4">
                                            <label class="form-label fw-semibold">Nombre</label>
                                            <input class="form-control" value="@PacienteActual.NombrePaciente" disabled />
                                        </div>
                                        <div class="col-md-3">
                                            <label class="form-label fw-semibold">Cédula</label>
                                            <input class="form-control" value="@PacienteActual.CedulaPaciente" disabled />
                                        </div>
                                        <div class="col-md-5">
                                            <label class="form-label fw-semibold">Correo Electrónico</label>
                                            <input class="form-control" value="@PacienteActual.CorreoElectronicoPaciente" disabled />
                                        </div>
                                        <div class="col-md-4">
                                            <label class="form-label fw-semibold">Teléfono</label>
                                            <input class="form-control" value="@PacienteActual.TelefonoPaciente" disabled />
                                        </div>
                                        <div class="col-md-8">
                                            <label class="form-label fw-semibold">Dirección</label>
                                            <input class="form-control" value="@PacienteActual.DireccionPaciente" disabled />
                                        </div>
                                    </div>
                                </div>
                            </div>
                        }
                    </div>

                    <div class="card shadow-sm mb-4">
                        <div class="card-body">
                            <label class="form-label fw-semibold">Médico</label>
                            <div class="input-group">
                                <select class="form-select" @bind="MedicoIdSeleccionado">
                                    <option value="">-- Seleccione un médico --</option>
                                    @foreach (var medico in Medicos)
                                    {
                                        <option value="@medico.IdMedico">@medico.NombreMedico</option>
                                    }
                                </select>
                                <button class="btn btn-secondary" type="button" @onclick="AbrirModalNuevoMedico">
                                    <i class="bi bi-person-plus"></i> Nuevo
                                </button>
                            </div>
                        </div>
                    </div>

                    <div class="mb-3">
                        <button class="btn btn-success" type="button" @onclick="() => MostrarModalExamen = true">
                            <i class="bi bi-plus-circle me-1"></i> Agregar Examen
                        </button>
                    </div>


                    <div class="text-end mb-4">
                        <button class="btn btn-primary px-4" type="submit">
                            <i class="bi bi-save me-1"></i> Guardar Orden
                        </button>
                    </div>
                </EditForm>

                @if (MostrarModalRegistrarPaciente)
                {
                    <div class="modal show d-block" style="background-color: rgba(0,0,0,0.5);">
                        <div class="modal-dialog modal-lg modal-dialog-centered">
                            <div class="modal-content shadow-lg border-0">
                                <EditForm Model="@NuevoPaciente" OnValidSubmit="RegistrarNuevoPaciente">
                                    <div class="modal-header bg-primary text-white">
                                        <h5 class="modal-title"><i class="bi bi-person-plus me-2"></i>Registrar Paciente</h5>
                                        <button type="button" class="btn-close btn-close-white" @onclick="CerrarModalRegistrarPaciente"></button>
                                    </div>
                                    <div class="modal-body">
                                        <DataAnnotationsValidator />
                                        <ValidationSummary />
                                        <div class="row g-3">
                                            <div class="col-md-6">
                                                <label class="form-label">Cédula</label>
                                                <InputText class="form-control" @bind-Value="NuevoPaciente.CedulaPaciente" readonly />
                                            </div>
                                            <div class="col-md-6">
                                                <label class="form-label">Nombre</label>
                                                <InputText class="form-control text-uppercase"
                                                           @bind-Value="NuevoPaciente.NombrePaciente"
                                                           @oninput="(e => NuevoPaciente.NombrePaciente = e.Value?.ToString()?.ToUpper() ?? string.Empty)" />
                                            </div>

                                            <div class="col-md-6">
                                                <label class="form-label">Fecha Nacimiento</label>
                                                <InputDate class="form-control" @bind-Value="NuevoPaciente.FechaNacPaciente" TValue="DateTime" />
                                            </div>
                                            <div class="col-md-6">
                                                <label class="form-label">Correo</label>
                                                <InputText class="form-control" @bind-Value="NuevoPaciente.CorreoElectronicoPaciente" />
                                            </div>
                                            <div class="col-md-6">
                                                <label class="form-label">Teléfono</label>
                                                <InputText class="form-control" @bind-Value="NuevoPaciente.TelefonoPaciente" />
                                            </div>
                                            <div class="col-md-6">
                                                <label class="form-label">Dirección</label>
                                                <InputText class="form-control text-uppercase"
                                                           @bind-Value="NuevoPaciente.DireccionPaciente"
                                                           @oninput="(e => NuevoPaciente.DireccionPaciente = e.Value?.ToString()?.ToUpper() ?? string.Empty)" />
                                            </div>

                                        </div>
                                    </div>
                                    <div class="modal-footer">
                                        <button class="btn btn-primary px-3" type="submit">
                                            <i class="bi bi-save me-1"></i>Guardar
                                        </button>
                                        <button class="btn btn-secondary" type="button" @onclick="CerrarModalRegistrarPaciente">
                                            <i class="bi bi-x-lg me-1"></i>Cancelar
                                        </button>
                                    </div>
                                </EditForm>
                            </div>
                        </div>
                    </div>
                }

                @if (MostrarModalBuscarPaciente)
                {
                    <div class="modal show d-block" style="background-color: rgba(0,0,0,0.5);">
                        <div class="modal-dialog modal-lg modal-dialog-centered">
                            <div class="modal-content shadow-lg border-0">
                                <div class="modal-header bg-primary text-white">
                                    <h5 class="modal-title"><i class="bi bi-search me-2"></i>Buscar Paciente</h5>
                                    <button type="button" class="btn-close btn-close-white" @onclick="CerrarModalBuscarPaciente"></button>
                                </div>
                                <div class="modal-body">
                                    <div class="row g-2 mb-3">
                                        <div class="col-md-4">
                                            <InputSelect class="form-select" @bind-Value="FiltroBusquedaPaciente">
                                                <option value="nombre">Nombre</option>
                                                <option value="cedula">Cédula</option>
                                            </InputSelect>
                                        </div>
                                        <div class="col-md-6">
                                            <InputText class="form-control" @bind-Value="ValorBusquedaPaciente" placeholder="Ingrese valor a buscar" />
                                        </div>
                                        <div class="col-md-2 d-grid">
                                            <button class="btn btn-primary" @onclick="BuscarPacientesModal"><i class="bi bi-search"></i></button>
                                        </div>
                                    </div>

                                    <div style="max-height: 300px; overflow-y: auto;" class="border rounded">
                                        <table class="table table-sm table-hover align-middle mb-0">
                                            <thead class="table-light">
                                                <tr><th>Cédula</th><th>Nombre</th><th>Correo</th><th></th></tr>
                                            </thead>
                                            <tbody>
                                                @if (PacientesEncontrados.Any())
                                                {
                                                    @foreach (var p in PacientesEncontrados)
                                                    {
                                                        <tr>
                                                            <td>@p.CedulaPaciente</td>
                                                            <td>@p.NombrePaciente</td>
                                                            <td>@p.CorreoElectronicoPaciente</td>
                                                            <td>
                                                                <button class="btn btn-success btn-sm" @onclick="() => SeleccionarPaciente(p)">
                                                                    <i class="bi bi-check-lg"></i>
                                                                </button>
                                                            </td>
                                                        </tr>
                                                    }
                                                }
                                                else
                                                {
                                                    <tr><td colspan="4" class="text-center text-muted">Sin resultados</td></tr>
                                                }
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                                <div class="modal-footer">
                                    <button class="btn btn-secondary" @onclick="CerrarModalBuscarPaciente">Cerrar</button>
                                </div>
                            </div>
                        </div>
                    </div>
                }

                @if (MostrarModalMedico)
                {
                    <div class="modal show d-block" style="background-color: rgba(0,0,0,0.5);">
                        <div class="modal-dialog modal-md modal-dialog-centered">
                            <div class="modal-content shadow-lg border-0">
                                <EditForm Model="@NuevoMedico" OnValidSubmit="GuardarNuevoMedico">
                                    <div class="modal-header bg-primary text-white">
                                        <h5 class="modal-title"><i class="bi bi-person-plus me-2"></i>Registrar Médico</h5>
                                        <button type="button" class="btn-close btn-close-white" @onclick="CerrarModalMedico"></button>
                                    </div>
                                    <div class="modal-body">
                                        <DataAnnotationsValidator />
                                        <ValidationSummary />
                                        <div class="mb-3">
                                            <label class="form-label">Nombre</label>
                                            <InputText class="form-control text-uppercase"
                                                       @bind-Value="NuevoMedico.NombreMedico"
                                                       @oninput="(e => NuevoMedico.NombreMedico = e.Value?.ToString()?.ToUpper() ?? string.Empty)" />
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label">Especialidad</label>
                                            <InputText class="form-control text-uppercase"
                                                       @bind-Value="NuevoMedico.Especialidad"
                                                       @oninput="(e => NuevoMedico.Especialidad = e.Value?.ToString()?.ToUpper() ?? string.Empty)" />
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label">Teléfono</label>
                                            <InputText class="form-control" @bind-Value="NuevoMedico.Telefono" />
                                        </div>
                                    </div>
                                    <div class="modal-footer">
                                        <button class="btn btn-primary px-3" type="submit">
                                            <i class="bi bi-save me-1"></i>Guardar
                                        </button>
                                        <button class="btn btn-secondary" type="button" @onclick="CerrarModalMedico">
                                            <i class="bi bi-x-lg me-1"></i>Cancelar
                                        </button>
                                    </div>
                                </EditForm>
                            </div>
                        </div>
                    </div>
                }

                @if (MostrarModalExamen)
                {
                    <div class="modal show d-block" style="background-color: rgba(0,0,0,0.5);">
                        <div class="modal-dialog modal-xl modal-dialog-centered">
                            <div class="modal-content shadow-lg border-0">
                                <div class="modal-header bg-primary text-white">
                                    <h5 class="modal-title"><i class="bi bi-flask me-2"></i>Seleccionar Examen</h5>
                                    <button type="button" class="btn-close btn-close-white" @onclick="CerrarModalExamen"></button>
                                </div>

                                <div class="modal-body">
                                    <div class="row g-2 mb-3">
                                        <div class="col-md-10">
                                            <InputText class="form-control" @bind-Value="TextoBuscarExamen" placeholder="Buscar examen por nombre o estudio..." />
                                        </div>
                                        <div class="col-md-2 d-grid">
                                            <button class="btn btn-primary" @onclick="BuscarExamenes"><i class="bi bi-search"></i></button>
                                        </div>
                                    </div>

                                    <div style="max-height: 400px; overflow-y: auto;" class="border rounded">
                                        <table class="table table-sm table-hover align-middle mb-0">
                                            <thead class="table-light text-center">
                                                <tr>
                                                    <th>Nombre</th>
                                                    <th>Estudio</th>
                                                    <th>Precio</th>
                                                    <th>Acción</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                @if (ExamenesDisponibles.Any())
                                                {
                                                    @foreach (var ex in ExamenesDisponibles)
                                                    {
                                                        <tr class="text-center">
                                                            <td>@ex.NombreExamen</td>
                                                            <td>@ex.Estudio</td>
                                                            <td>@ex.Precio.ToString("C")</td>
                                                            <td>
                                                                <button class="btn btn-success btn-sm" @onclick="() => SeleccionarExamen(ex)">
                                                                    <i class="bi bi-check-lg"></i>
                                                                </button>
                                                            </td>
                                                        </tr>
                                                    }
                                                }
                                                else
                                                {
                                                    <tr>
                                                        <td colspan="4" class="text-center text-muted">No hay resultados</td>
                                                    </tr>
                                                }
                                            </tbody>
                                        </table>
                                    </div>
                                </div>

                                <div class="modal-footer">
                                    <button class="btn btn-secondary" type="button" @onclick="CerrarModalExamen">
                                        <i class="bi bi-x-lg me-1"></i> Cerrar
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                }

                @if (!ExamenesSeleccionados.Any())
                {
                    <div class="alert alert-warning text-center mt-3">
                        <i class="bi bi-exclamation-triangle me-2"></i> No hay exámenes seleccionados.
                    </div>
                }
                else
                {
                    <div class="card shadow-sm mb-4">
                        <div class="card-header bg-light fw-semibold">
                            <i class="bi bi-list-check me-2 text-primary"></i> Exámenes Seleccionados
                        </div>
                        <div class="card-body table-responsive p-0">
                            <table class="table table-striped table-bordered table-sm align-middle text-center mb-0">
                                <thead class="table-primary text-dark">
                                    <tr>
                                        <th>Nombre</th>
                                        <th>Estudio</th>
                                        <th>Precio</th>
                                        <th>Acción</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var ex in ExamenesSeleccionados)
                                    {
                                        <tr>
                                            <td>@ex.NombreExamen</td>
                                            <td>@ex.Estudio</td>
                                            <td>@ex.Precio.ToString("C")</td>
                                            <td>
                                                <button class="btn btn-outline-danger btn-sm" title="Quitar examen" @onclick="() => QuitarExamen(ex)">
                                                    <i class="bi bi-trash"></i>
                                                </button>
                                            </td>
                                        </tr>
                                    }
                                </tbody>
                                <tfoot class="fw-bold">
                                    <tr>
                                        <td colspan="2" class="text-end">Total:</td>
                                        <td>@CalcularTotal().ToString("C")</td>
                                        <td></td>
                                    </tr>
                                </tfoot>
                            </table>
                        </div>
                    </div>
                }

                @if (MostrarModalPago)
                {
                    <div class="modal fade show d-block" style="background-color: rgba(0,0,0,0.5);">
                        <div class="modal-dialog">
                            <div class="modal-content">
                                <EditForm Model="@PagoActual" OnValidSubmit="GuardarPago">
                                    <div class="modal-header">
                                        <h5 class="modal-title"><i class="fas fa-cash-register me-2"></i> Registrar Pago</h5>
                                        <button class="btn-close" type="button" @onclick="CerrarModalPago"></button>
                                    </div>
                                    <div class="modal-body">
                                        <div class="mb-2">
                                            <label>Total a pagar</label>
                                            <input class="form-control" value="@CalcularTotal().ToString("C")" disabled />
                                        </div>
                                        <div class="mb-2">
                                            <label>Efectivo</label>
                                            <InputNumber class="form-control" @bind-Value="Efectivo" />
                                        </div>
                                        <div class="mb-2">
                                            <label>Transferencia</label>
                                            <InputNumber class="form-control" @bind-Value="Transferencia" />
                                        </div>

                                        @if (ObtenerCambio() > 0)
                                        {
                                            <div class="mb-2">
                                                <label>Cambio</label>
                                                <input class="form-control" value="@ObtenerCambio().ToString("C")" disabled />
                                            </div>
                                        }
                                        else if (ObtenerSaldoPendiente() > 0)
                                        {
                                            <div class="mb-2">
                                                <label>Saldo pendiente</label>
                                                <input class="form-control" value="@ObtenerSaldoPendiente().ToString("C")" disabled />
                                            </div>
                                        }
                                        else
                                        {
                                            <div class="mb-2">
                                                <label>Cambio</label>
                                                <input class="form-control" value="0,00" disabled />
                                            </div>
                                        }

                                        <div class="mb-2">
                                            <label>Observación</label>
                                            <InputTextArea class="form-control" @bind-Value="PagoActual.Observacion" />
                                        </div>
                                    </div>

                                    <div class="modal-footer">
                                        <button class="btn btn-success" type="submit">Confirmar</button>
                                        <button class="btn btn-secondary" type="button" @onclick="CerrarModalPago">Cancelar</button>
                                    </div>
                                </EditForm>
                            </div>
                        </div>
                    </div>
                }


            }
        }
    </Authorized>





    <NotAuthorized>
        <div class="d-flex justify-content-center align-items-center vh-100">
            <div class="card shadow-lg text-center border-0" style="max-width: 450px;">
                <div class="card-body p-4">
                    <i class="bi bi-person-x text-danger fs-1 mb-3"></i>
                    <h5 class="fw-bold mb-2">Debe iniciar sesión</h5>
                    <p class="text-muted mb-3">Para acceder, inicie sesión con una cuenta autorizada.</p>
                    <NavLink href="/login" class="btn btn-primary">
                        <i class="bi bi-box-arrow-in-right"></i> Ir al Login
                    </NavLink>
                </div>
            </div>
        </div>
    </NotAuthorized>
</AuthorizeView>

@code {
    private bool cargado;
    private string Cedula = "";
    private DateOnly FechaOrdenSeleccionada = DateOnly.FromDateTime(DateTime.Now);
    private PacienteDto? PacienteActual;
    private PacienteDto NuevoPaciente = new();
    private List<PacienteDto> PacientesEncontrados = new();
    private List<MedicoDto> Medicos = new();
    private MedicoDto? MedicoActual;
    private MedicoDto NuevoMedico = new();
    private List<ExamenDto> ExamenesDisponibles = new();
    private List<ExamenDto> ExamenesSeleccionados = new();
    private OrdenDto orden = new();
    private PagoDto PagoActual = new();
    private decimal Efectivo;
    private decimal Transferencia;
    private bool MostrarModalRegistrarPaciente;
    private bool MostrarModalBuscarPaciente;
    private bool MostrarModalMedico;
    private bool MostrarModalExamen;
    private bool MostrarModalPago;
    private string FiltroBusquedaPaciente = "nombre";
    private string ValorBusquedaPaciente = "";
    private string TextoBuscarExamen = "";

    private int? MedicoIdSeleccionado
    {
        get => MedicoActual?.IdMedico;
        set => MedicoActual = Medicos.FirstOrDefault(m => m.IdMedico == value);
    }

    private bool _sesionVerificada = false;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender && !_sesionVerificada)
        {
            _sesionVerificada = true;

            if (!await SesionService.VerificarOSalirAsync())
                return;

            Medicos = await MedicosApi.ListarMedicosAsync();
            cargado = true;
            StateHasChanged();
        }
    }

    private async Task BuscarPorCedula()
    {
        if (!await SesionService.VerificarOSalirAsync()) return;

        if (string.IsNullOrWhiteSpace(Cedula))
        {
            MostrarModalBuscarPaciente = true;
            ValorBusquedaPaciente = "";
            PacientesEncontrados = new();
            await JS.InvokeVoidAsync("marcarModalAbierto");
            return;
        }

        var paciente = await PacientesApi.ObtenerPacientePorCedulaAsync(Cedula);

        if (paciente != null)
        {
            PacienteActual = paciente;
        }
        else
        {
            var deseaRegistrar = await JS.InvokeAsync<bool>("confirm", "No se encontró paciente con esa cédula. ¿Desea registrarlo?");
            if (!deseaRegistrar) return;

            if (!ValidarCedula(Cedula))
            {
                await JS.InvokeVoidAsync("alert", "La cédula ingresada no es válida.");
                return;
            }

            NuevoPaciente = new PacienteDto
            {
                CedulaPaciente = Cedula,
                FechaNacPaciente = DateTime.Today.AddYears(-20)
            };
            MostrarModalRegistrarPaciente = true;
            await JS.InvokeVoidAsync("marcarModalAbierto");
        }
    }

    private async Task BuscarPacientesModal()
    {
        if (!await SesionService.VerificarOSalirAsync()) return;

        PacientesEncontrados = string.IsNullOrWhiteSpace(ValorBusquedaPaciente)
            ? await PacientesApi.GetPacientesAsync()
            : await PacientesApi.BuscarPacientesAsync(FiltroBusquedaPaciente, ValorBusquedaPaciente);
    }

    private async Task RegistrarNuevoPaciente()
    {
        if (!await SesionService.VerificarOSalirAsync()) return;

        var (exito, msg, paciente) = await PacientesApi.CrearPacienteAsync(NuevoPaciente);
        await JS.InvokeVoidAsync("alert", msg);

        if (exito && paciente != null)
        {
            PacienteActual = paciente;
            Cedula = paciente.CedulaPaciente;
            MostrarModalRegistrarPaciente = false;
            await JS.InvokeVoidAsync("marcarModalCerrado");
            StateHasChanged();
        }
    }

    private async Task SeleccionarPaciente(PacienteDto p)
    {
        PacienteActual = p;
        Cedula = p.CedulaPaciente;
        MostrarModalBuscarPaciente = false;
        await JS.InvokeVoidAsync("marcarModalCerrado");
    }

    private async Task AbrirModalNuevoMedico()
    {
        NuevoMedico = new MedicoDto();
        MostrarModalMedico = true;
        await JS.InvokeVoidAsync("marcarModalAbierto");
    }

    private async Task GuardarNuevoMedico()
    {
        if (!await SesionService.VerificarOSalirAsync()) return;

        var res = await MedicosApi.CrearMedicoAsync(NuevoMedico);
        if (res.IsSuccessStatusCode)
        {
            Medicos = await MedicosApi.ListarMedicosAsync();
            MedicoActual = Medicos.FirstOrDefault(m => m.NombreMedico == NuevoMedico.NombreMedico);
            MostrarModalMedico = false;
            await JS.InvokeVoidAsync("marcarModalCerrado");
        }
        else
        {
            var msg = await res.Content.ReadAsStringAsync();
            await JS.InvokeVoidAsync("alert", $"Error al crear médico: {msg}");
        }
    }

    private async Task BuscarExamenes()
    {
        if (!await SesionService.VerificarOSalirAsync()) return;

        ExamenesDisponibles = await ExamenesApi.ListarExamenesAsync(TextoBuscarExamen);
    }

    private void SeleccionarExamen(ExamenDto examen)
    {
        if (!ExamenesSeleccionados.Any(e => e.IdExamen == examen.IdExamen))
            ExamenesSeleccionados.Add(examen);
        MostrarModalExamen = false;
    }

    private void QuitarExamen(ExamenDto examen) =>
        ExamenesSeleccionados.Remove(examen);

    private void MostrarPagoModal()
    {
        if (PacienteActual == null || MedicoActual == null || !ExamenesSeleccionados.Any())
        {
            JS.InvokeVoidAsync("alert", "Debe seleccionar paciente, médico y al menos un examen.");
            return;
        }

        Efectivo = 0;
        Transferencia = 0;
        PagoActual = new PagoDto();
        MostrarModalPago = true;
        StateHasChanged();
    }

    private decimal CalcularTotal() =>
        ExamenesSeleccionados.Sum(e => e.Precio);

    private decimal ObtenerSaldoPendiente() =>
        Math.Max(0, CalcularTotal() - (Efectivo + Transferencia));

    private decimal ObtenerCambio() =>
        Math.Max(0, (Efectivo + Transferencia) - CalcularTotal());

    private async Task GuardarPago()
    {
        if (!await SesionService.VerificarOSalirAsync()) return;

        var pagado = Efectivo + Transferencia;
        var saldo = ObtenerSaldoPendiente();

        orden.IdPaciente = PacienteActual!.IdPaciente;
        orden.IdMedico = MedicoActual!.IdMedico;
        orden.FechaOrden = FechaOrdenSeleccionada;
        orden.Total = CalcularTotal();
        orden.SaldoPendiente = saldo;
        orden.TotalPagado = pagado;
        orden.EstadoPago = saldo == 0 ? "PAGADO" : "PENDIENTE";
        orden.Anulado = false;
        orden.LiquidadoConvenio = false;
        orden.NumeroOrden = "";
        orden.Observacion = "";
        orden.Detalles = ExamenesSeleccionados
            .Select(e => new DetalleOrdenDto { IdExamen = e.IdExamen, Precio = e.Precio })
            .ToList();

        var dto = new OrdenCompletaDto
        {
            Orden = orden,
            IdsExamenes = ExamenesSeleccionados.Select(e => e.IdExamen).ToList()
        };

        var response = await OrdenApi.CrearOrdenHttpResponseAsync(dto);

        if (response.IsSuccessStatusCode)
        {
            var resp = await response.Content.ReadFromJsonAsync<OrdenRespuestaDto>();
            if (resp != null && resp.IdOrden > 0)
            {
                var observacion = string.IsNullOrWhiteSpace(PagoActual.Observacion)
                    ? "PAGO DESDE ORDEN"
                    : PagoActual.Observacion;

                var pago = new PagoDto
                {
                    IdOrden = resp.IdOrden,
                    FechaPago = DateTime.Now,
                    MontoPagado = pagado,
                    Observacion = observacion,
                    DetallePagos = new List<DetallePagoDto>
                {
                    new() { TipoPago = "EFECTIVO", Monto = Efectivo },
                    new() { TipoPago = "TRANSFERENCIA", Monto = Transferencia }
                }
                };

                await PagosApi.RegistrarPagoAsync(pago);
                Navigation.NavigateTo("/ordenes");
            }
            else await JS.InvokeVoidAsync("alert", "No se pudo registrar la orden.");
        }
        else
        {
            var msg = await response.Content.ReadAsStringAsync();
            await JS.InvokeVoidAsync("alert", $"Error al registrar la orden: {msg}");
        }
    }

    private bool ValidarCedula(string cedula)
    {
        if (string.IsNullOrWhiteSpace(cedula) || cedula.Length != 10 || !cedula.All(char.IsDigit))
            return false;

        int suma = 0;
        for (int i = 0; i < 9; i++)
        {
            int digito = int.Parse(cedula[i].ToString());
            int coef = (i % 2 == 0) ? 2 : 1;
            int producto = digito * coef;
            suma += (producto >= 10) ? (producto - 9) : producto;
        }

        int ultimoDigito = int.Parse(cedula[9].ToString());
        int digitoCalculado = (suma % 10 == 0) ? 0 : (10 - (suma % 10));
        return ultimoDigito == digitoCalculado;
    }

    private async Task CerrarModalRegistrarPaciente()
    {
        MostrarModalRegistrarPaciente = false;
        await JS.InvokeVoidAsync("marcarModalCerrado");
    }

    private async Task CerrarModalBuscarPaciente()
    {
        MostrarModalBuscarPaciente = false;
        await JS.InvokeVoidAsync("marcarModalCerrado");
    }

    private async Task CerrarModalMedico()
    {
        MostrarModalMedico = false;
        await JS.InvokeVoidAsync("marcarModalCerrado");
    }

    private async Task CerrarModalExamen()
    {
        MostrarModalExamen = false;
        await JS.InvokeVoidAsync("marcarModalCerrado");
    }

    private async Task CerrarModalPago()
    {
        MostrarModalPago = false;
        await JS.InvokeVoidAsync("marcarModalCerrado");
    }

    private async Task VolverAtras() =>
        await JS.InvokeVoidAsync("history.back");
}